<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.0.5"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vuetify/3.4.8/vuetify-labs.min.js"
    integrity="sha512-5xeIAXqNP/DWGkolQzdPAL042aA4Lb8SCMy/Ju+9yzvf9SzfsbzICQwYyMrhbN8pG8m0LWhMl9BISpIDs8RquQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vuetify/3.4.8/vuetify-labs.min.css"
    integrity="sha512-VP/8WyNQxaDeiVsCGXh7nLWVPt64+rqoCugT7xhZLhx9F8fTJpjpiCqHqJlhmKAMgyRU8TiAAxJmmxz260R03w=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
  <div id="app"></div>

  <script type="module">
    const { createApp } = Vue;
    const { createVuetify } = Vuetify;

    const vuetify = createVuetify();

    createApp({
      template: "#app-template",
      data: () => ({
        dialog: false,
        dialogDelete: false,
        schema: null,
        prefs: null,
        search: "",
        headers: [],
        rules: {
          required: (value) => !!value || "Required.",
        },
        dataTable: [],
        editedIndex: -1,
        editedItem: {},
        defaultItem: {},
        snackbar: {
          text: "",
          show: false,
          timeout: 2000,
          color: "success",
          multiline: true,
          vertical: true,
          right: true,
          bottom: true,
        },
      }),

      computed: {
        formTitle() {
          return this.editedIndex === -1 ? "New Order" : "Edit Order";
        },
      },

      watch: {
        dialog(val) {
          val || this.close();
        },
        dialogDelete(val) {
          val || this.closeDelete();
        },
      },

      created() {
        this.fetchSchema();
        this.refresh();
      },

      methods: {
        fetchSchema() {
          google.script.run
            .withSuccessHandler((res) => {
              this.schema = res.schema;
              this.prefs = res.appSettings;
              const schema = res.schema;
              this.headers = schema.map((item) => {
                return {
                  title: item.label,
                  key: item.key,
                  sortable: item.sortable || true,
                  align: item.align || "start",
                  width: item.width || null,
                  type: item.type,
                };
              });
              // this.headers.push({
              //   text: "Actions",
              //   key: "actions",
              //   sortable: false,
              // });
              const idHeader = { title: 'ID', key: this.prefs.IdColumn }
              this.headers = [idHeader, ...this.headers, {
                text: "Actions",
                key: "actions",
                sortable: false,
                width: '5%'
              }];



              console.log("Headers", this.headers);

              this.editedItem = schema.reduce((acc, item) => {
                acc[item.key] = item.defaultValue || "";
                return acc;
              }, {});
              this.defaultItem = this.editedItem;
            })
            .withFailureHandler((error) => {
              console.log(error);
            })
            .getAppPrefs();
        },
        initialize() {
          google.script.run
            .withSuccessHandler((res) => {
              this.dataTable = JSON.parse(res);
              console.log(this.dataTable);
            })
            .withFailureHandler((error) => {
              console.log(error);
            })
            .readAllRecords();
        },
        refresh() {
          google.script.run
            .withSuccessHandler((res) => {
              // this.dataTable = JSON.parse(res);
              let data = JSON.parse(res);
              console.log("Parsed Data", data);
              // convert date strings to date objects
              const dateFlds = this.schema.filter(
                (fld) => fld.type === "date"
              );
              data = data.map((item) => {
                dateFlds.forEach((fld) => {
                  if (item[fld.key] != "") {
                    const dt = new Date(item[fld.key]);
                    item[fld.key] = `${dt.getFullYear()}-${(
                      "0" +
                      (dt.getMonth() + 1)
                    ).slice(-2)}-${("0" + dt.getDate()).slice(-2)}`;
                    // item[fld.key] = dt;
                  }
                });
                return item;
              });

                            const dateTimeFlds = this.schema.filter(
                (fld) => fld.type === "date-time"
              );
              data = data.map((item) => {
                dateTimeFlds.forEach((fld) => {
                  if (item[fld.key] != "") {
                    const dt = new Date(item[fld.key]);
                     const year = dt.getFullYear();
      const month = String(dt.getMonth() + 1).padStart(2, "0"); // Months are 0-based
      const day = String(dt.getDate()).padStart(2, "0");
      const hours = String(dt.getHours()).padStart(2, "0");
      const minutes = String(dt.getMinutes()).padStart(2, "0");

      const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
      item[fld.key] = formattedDateTime;
                  }
                });
                return item;
              });
              this.dataTable = data;

            })

            .withFailureHandler((error) => {
              console.log(error);
            })
            .readAllRecords();
        },
        editItem(item) {
          this.editedIndex = this.dataTable.indexOf(item);
          this.editedItem = Object.assign({}, item);
          this.dialog = true;
        },

        deleteItem(item) {
          this.editedIndex = this.dataTable.indexOf(item);
          this.editedItem = Object.assign({}, item);
          this.dialogDelete = true;
        },

        deleteItemConfirm() {
          this.showSnackbar("Deleting ...", "warning");
          google.script.run
            .withSuccessHandler((res) => {
              console.log(res);
              this.dataTable.splice(this.editedIndex, 1);
              this.closeDelete();
              this.refresh();
              this.showSnackbar("Record deleted successfully", "success");
            })
            .withFailureHandler((error) => {
              console.log(error);
            })
            .deleteRecord(this.editedItem);
        },

        close() {
          this.dialog = false;
          this.$nextTick(() => {
            this.editedItem = Object.assign({}, this.defaultItem);
            this.editedIndex = -1;
          });
        },

        closeDelete() {
          this.dialogDelete = false;
          this.$nextTick(() => {
            this.editedItem = Object.assign({}, this.defaultItem);
            this.editedIndex = -1;
          });
        },
        calculate(editedItem, val) {
          console.log(editedItem, val)
          editedItem['Amount'] = editedItem['Qty'] * editedItem['Unit Price'];
          editedItem['Net Price'] = editedItem['Amount'] - editedItem['Discount'];
          editedItem['Pending Payment'] = editedItem['Net Price'] - editedItem['Advance Payment'] - editedItem['Payment-1'] - editedItem['Payment-2'] - editedItem['Payment-3'] - editedItem['Payment-4'] - editedItem['Payment-5'];
        },
        program1() {
          console.log("Program 1");
          alert("Program 1");
        },

        save() {
          this.showSnackbar("Saving item...", "info");

          if (this.editedIndex > -1) {
            console.log("Edited Item", this.editedItem);
            google.script.run
              .withSuccessHandler((res) => {
                this.showSnackbar(
                  `Order saved successfully!\nRefreshing data..`,
                  "success"
                );
                this.refresh();
                this.resetForm();
              })
              .withFailureHandler((error) => {
                console.log(error);
              })
              .updateRecordById(this.editedItem);
          } else {
            google.script.run
              .withSuccessHandler((res) => {
                this.showSnackbar(
                  `Order saved successfully!\nRefreshing data..`,
                  "success"
                );
                this.refresh();
                this.resetForm();
              })
              .withFailureHandler((error) => {
                console.log(error);
              })
              .createRecord(this.editedItem);
          }
          this.close();
        },
        resetForm() {
          this.editedItem = Object.assign({}, this.defaultItem);
          this.editedIndex = -1;
        },
        showSnackbar(text, color) {
          this.snackbar.text = text;
          this.snackbar.color = color;
          this.snackbar.show = true;
        },
      },
    })
      .use(vuetify)
      .mount("#app");
  </script>
  <script type="text/x-template" id="app-template">
    <v-app>
                  <v-data-table
                    :headers="headers"
                    :items="dataTable"
                    :search="search"
                    :sort-by="[{ key: 'calories', order: 'asc' }]"
                    fixed-header
                    items-per-page="25"
                    style="font-size: 11px;"
                  >
                    <template v-slot:top>
                      <v-toolbar
                      :elevation="6"
                      >
                        <v-toolbar-title>{{prefs.AppName}}</v-toolbar-title>
    
    
                        <v-text-field
                          v-model="search"
                          prepend-inner-icon="mdi-magnify"
                          density="compact"
                          label="Search"
                          single-line
                          flat
                          hide-details
                          variant="solo-filled"
                       ></v-text-field>
                        <v-spacer></v-spacer>
                       
                        <v-dialog
                          v-model="dialog"
                          max-width="900px"
                        >
                          <template v-slot:activator="{ props }">
                            <v-btn
                              color="blue"
                              dark
                              class="mb-2 mx-2"
                              v-bind="props"
                              prepend-icon="mdi-plus"
                              variant="elevated"
                            >
                              New Item
                            </v-btn>
                            
    
                          </template>
                          
                          <v-card>
                            <v-card-title>
                              <span class="text-h5">{{ formTitle }}</span>
                            </v-card-title>
    
                            <v-card-text>
                              <v-container>
                                <v-row>
                                <v-col
                                        v-for="fld in schema"
                                        :key="fld.key"
                                        cols="12"
                                        sm="6"
                                        md="4"
                                    >
    
                                      <div v-if="fld.type === 'text'">
                                          <v-text-field
                                              v-model="editedItem[fld.key]"
                                              :label="fld.label"
                                              :rules="fld.required ? [rules.required]:[]"
                                              :disabled="fld.disabled||false"
                                          ></v-text-field>
                                      </div>
                                      <div v-if="fld.type === 'textarea'">
                                          <v-textarea
                                              v-model="editedItem[fld.key]"
                                              :label="fld.label"
                                              :rules="fld.required ? [rules.required]:[]"
                                          ></v-textarea>
                                      </div>
                                      <div v-if="fld.type === 'select'">
                                          <v-select
                                              v-model="editedItem[fld.key]"
                                              :label="fld.label"
                                              :items="fld.options.split(',')"
                                              :rules="fld.required ? [rules.required]:[]"
                                          ></v-select>
                                      </div>
                                      <div v-if="fld.type === 'checkbox'">
                                          <v-checkbox
                                              v-model="editedItem[fld.key]"
                                              :label="fld.label"
                                              :rules="fld.required ? [rules.required]:[]"
                                          ></v-checkbox>
                                      </div>
                                      <div v-if="fld.type === 'radio'">
                                          <v-radio-group inline v-model="editedItem[fld.key]" :rules="fld.required ? [rules.required]:[]">
                                              <template v-slot:label>
                                                <div>{{fld.label}}</div>
                                              </template>
                                              <v-radio
                                              v-for="opt in fld.options.split(',')"
                                              :key="opt"
                                              :label="opt"
                                              :value="opt"
                                          ></v-radio>
                                            </v-radio-group>
                                      </div>
                                      <div v-if="fld.type === 'date'">
                                          <v-text-field
                                              v-model="editedItem[fld.key]"
                                              :label="fld.label"
                                              type="date"
                                              :rules="fld.required ? [rules.required]:[]"
                                          ></v-text-field>
                                      </div>
                                      <div v-if="fld.type === 'time'">
                                        <label for="appt-time">{{fld.label}} </label>
                                        <input v-model="editedItem[fld.key]" id="appt-time" type="time" name="appt-time" value="13:30" :disabled="fld.disabled"
                                                :rules="fld.required ? [rules.required]:[]" />
                                            
                                        </div>
                                         </div>
 <div v-if="fld.type === 'date-time'">
                                      <label for="meeting-time">{{fld.label}} </label>

<input
  type="datetime-local"
  id="meeting-time"
  name="meeting-time"
   v-model="editedItem[fld.key]" 
/>
                                            
                                        </div>
                                         <div v-if="fld.type === 'link'||fld.type === 'avatar'">
                                          <v-text-field
                                              v-model="editedItem[fld.key]"
                                              :label="fld.label"
                                              type="text"
                                              :rules="fld.required ? [rules.required]:[]"
                                          ></v-text-field>
                                      </div>
                                      <div v-if="fld.type === 'number' ||fld.type === 'number_currency'">
                                          <v-text-field
                                              v-model="editedItem[fld.key]"
                                              :label="fld.label"
                                              type="number"
                                              :min="fld.min"
                                              :max="fld.max"
                                              :rules="fld.required ? [rules.required]:[]"
                                              :disabled="fld.disabled||false"
                                              @change="()=>{
                                                calculate(editedItem,editedItem[fld.key])
                                              }"
                                          ></v-text-field>
                                      </div>
    
                                    </v-col>
    
                                </v-row>
                              </v-container>
                            </v-card-text>
    
                            <v-card-actions>
                              <v-spacer></v-spacer>
                              <v-btn
                                color="blue-darken-1"
                                variant="text"
                                @click="close"
                              >
                                Cancel
                              </v-btn>
                              <v-btn
                                color="blue-darken-1"
                                variant="text"
                                @click="save"
                              >
                                Save
                              </v-btn>
                            </v-card-actions>
                          </v-card>
                        </v-dialog>
                        <v-dialog v-model="dialogDelete" max-width="500px">
                          <v-card>
                            <v-card-title class="text-h5">Are you sure you want to delete this Order?</v-card-title>
                            <v-card-actions>
                              <v-spacer></v-spacer>
                              <v-btn color="blue-darken-1" variant="text" @click="closeDelete">Cancel</v-btn>
                              <v-btn color="blue-darken-1" variant="text" @click="deleteItemConfirm">OK</v-btn>
                              <v-spacer></v-spacer>
                            </v-card-actions>
                          </v-card>
                        </v-dialog>
                      </v-toolbar>
                    </template>
                  
                    <template v-slot:item.actions="{ item }">
                      <div style="width:60px;">
                        <v-icon
                        size="small"
                        class="me-2"
                        @click="editItem(item)"
                      >
                        mdi-pencil
                      </v-icon>
                      <v-icon
                        size="small"
                        @click="deleteItem(item)"
                        color="red"
                      >
                        mdi-delete
                      </v-icon>
                      </div>
                    </template>
                    <template v-slot:item.rating="{ item }">
                      <v-rating
                        :model-value="item.rating"
                        color="blue-darken-2"
                        density="compact"
                        size="small"
                        readonly
                      ></v-rating>
                    </template>
       
                    <template v-for="header in headers.filter((header) => header.type==='number_currency')" v-slot:[`item.${header.key}`]="{ header, value }">
                      {{value?.toLocaleString(prefs.Locale, {
                        style: 'currency',
                        currency: prefs.Currency,
                    })}}
                    </template>
                    <template v-for="header in headers.filter((header) => header.type==='date')" v-slot:[`item.${header.key}`]="{ header, value }">
                      {{ value !==''? new Date(value).toLocaleDateString() : value }}
                    </template>
                    <template v-for="header in headers.filter((header) => header.type==='link')" v-slot:[`item.${header.key}`]="{ header, value }">
                      <div class="text-center">
                        <!-- <a :href="value" target="_blank">{{schema.find(o=>o.key==header?.key)?.link_alias}}</a> -->
                        <a :href="value" target="_blank">Open</a>
                    </div>
                    </template>
                                        <template v-for="header in headers.filter((header) => header.type==='avatar')" v-slot:[`item.${header.key}`]="{ header, value }">
                      <div class="text-center">
                       <a :href="value" target="_blank"><v-avatar :size="71">
      <v-img
        alt="pic"
        :src="value"

      ></v-img>
    </v-avatar></a>
                       
                      
                    </div>
                    </template>
                        <template v-slot:item.stock="{ item }">
                        <div class="text-end">
                            <v-chip
                            :color="item.stock ? 'green' : 'red'"
                            :text="item.stock ? 'In stock' : 'Out of stock'"
                            class="text-uppercase"
                            label
                            size="small"
                            ></v-chip>
                        </div>
                        </template>
                        <template v-slot:item.approval="{ item }">
                            <div class="text-center">
                                <v-chip
                                :color="item.approval == 'Yes' ? 'green' : 'red'"
                                :text="item.approval == 'Yes' ? 'Yes' : 'No'"
                                :prepend-icon="item.approval == 'Yes' ? 'mdi-checkbox-marked-circle' : 'mdi-close'"
                                class="ma-2"
                                size="small"
                                >
                                {{item.approval}}</v-chip>
                            </div>
                        </template>
                              <template v-slot:item.status="{ item }">
                                <div class="text-center">
                                  <v-chip
                                  class="ma-2"
                                  :color="item.status ==='Completed' ?'teal': item.status ==='In-Progress' ? 'orange' : 'red'"
                                  :prepend-icon="item.status ==='Completed' ?'mdi-checkbox-marked-circle': item.status ==='In-Progress' ? 'mdi-progress-alert' : 'mdi-alert'"
                                  size="small"
                                >
                                  {{item.status}}
                                </v-chip>
                                </div>
                        </template>
                        <template v-slot:item.priority="{ item }">
                        <div class="text-end">
                            <v-chip
                            :color="item.priority ==='High' ? 'red' : item.priority ==='Medium' ? 'orange' : 'green'"
                            :text="item.priority"
                            class="text-uppercase"
                            label
                            size="small"
                            ></v-chip>
                        </div>
                        </template>
                      
                    
                    <template v-slot:no-data>
                      <v-btn
                        color="primary"
                        @click="initialize"
                      >
                        Reset
                      </v-btn>
                    </template>
                  </v-data-table>
                  <v-snackbar
                        v-model="snackbar.show"
                        :color="snackbar.color"
                        :timeout="snackbar.timeout"
                        :vertical="snackbar.vertical"
                        :right="snackbar.right"
                        :bottom="snackbar.bottom"
                        multi-line
                         >
                     <strong>{{snackbar.text}}</strong>
    
                    <template v-slot:actions>
                    <v-btn
                        color="red"
                        variant="text"
                        @click="snackbar.show = false"
                    >
                        Close
                    </v-btn>
            </template>
          </v-snackbar>
            </v-app>
        </script>
</body>

</html>