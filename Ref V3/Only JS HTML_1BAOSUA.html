
    <script>
      let formRepairModalInstance = null;
      // Global data variables
      let userData = {};
      let appData = {};
      let data_Repair_DV = {};
      let CONFIG_COLUMNS = {};
      let CONFIG_ENUM = {};
      let val_Repair = {
        MaxId_Count: 0,
        MaxRow_Id: 0,
        CurrentRow_Id: 0
      };
      
      ///////////////////////////////////
      // 1. Nh√≥m h√†m x·ª≠ l√Ω d·ªØ li·ªáu ban ƒë·∫ßu
      ///////////////////////////////////
      // 1.1. B·∫Øt s·ª± ki·ªán ƒë·ªÉ t·∫£i d·ªØ li·ªáu
      document.addEventListener('DOMContentLoaded', function() {
        // Load data
        loadAllData();
      });

      // 1.2. H√†m t·∫£i d·ªØ li·ªáu
      function loadAllData() {
        console.log('Starting to load data...');
        
        google.script.run
          .withSuccessHandler(handleDataLoaded)
          .withFailureHandler(handleScriptError)
          .getdata();
      }

      // 1.3. H√†m x·ª≠ l√Ω d·ªØ li·ªáu ƒë√£ t·∫£i
      function handleDataLoaded(dataJSON) {
        try {
          // L∆∞u d·ªØ li·ªáu v√†o bi·∫øn to√†n c·ª•c
          appData = JSON.parse(dataJSON);
          CONFIG_COLUMNS = appData.CONFIG_COLUMNS;
          CONFIG_ENUM = appData.CONFIG_ENUM;

          // Kh·ªüi t·∫°o c√°c th√†nh ph·∫ßn giao di·ªán
          initializeUI();
          
          // Kh·ªüi t·∫°o RepairModalManager
          RepairModalManager.initialize();
          
          // ·∫®n m√†n h√¨nh ƒëang t·∫£i
          document.getElementById('loading').classList.add('hidden');
          
          // Hi·ªÉn th·ªã form ƒëƒÉng nh·∫≠p
          document.getElementById('loginSection').style.display = 'block';
        } catch (error) {      
          showError("L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu: " + error.message);
        }
      }

      // 1.4. H√†m kh·ªüi t·∫°o giao di·ªán
      function initializeUI() {
        // Kh·ªüi t·∫°o c√°c modal
        const modalElements = document.querySelectorAll('.modal');
        modalElements.forEach(element => {
          new bootstrap.Modal(element);
        });

        // Kh·ªüi t·∫°o tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Kh·ªüi t·∫°o popovers
        const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        popoverTriggerList.map(function (popoverTriggerEl) {
          return new bootstrap.Popover(popoverTriggerEl);
        });

        // Kh·ªüi t·∫°o b·∫Øt c√°c s·ª± ki·ªán cho c√°c tr∆∞·ªùng d·ªØ li·ªáu
        setupFormEventListeners();
      }

      // 1.6. Kh·ªüi t·∫°o b·∫Øt c√°c s·ª± ki·ªán cho c√°c tr∆∞·ªùng d·ªØ li·ªáu
      function setupFormEventListeners() {
        // Nh√≥m thi·∫øt b·ªã thay ƒë·ªïi
        document.getElementById('equipmentGroup').addEventListener('change', function() {
          RepairModalManager.updateEquipmentList();
        });

        // M√£ thi·∫øt b·ªã thay ƒë·ªïi
        document.getElementById('equipmentId').addEventListener('change', function() {
          RepairModalManager.updateEquipmentDetails();
        });

        // Ng∆∞·ªùi s·ª≠a ch·ªØa thay ƒë·ªïi
        document.getElementById('repairPerson').addEventListener('change', function() {
          RepairModalManager.updateRepairPersonPhone();
        });

        // Ng∆∞·ªùi y√™u c·∫ßu thay ƒë·ªïi
        document.getElementById('requesterName').addEventListener('change', function() {
          RepairModalManager.updateRequesterPhone();
        });

        // L·∫Øng nghe s·ª± ki·ªán cho t·∫•t c·∫£ c√°c modal
        document.querySelectorAll('.modal').forEach(modal => {
          modal.addEventListener('shown.bs.modal', () => {
            setupModalFocus(modal); // G·ªçi h√†m setupModalFocus m·ªói khi modal ƒë∆∞·ª£c hi·ªÉn th·ªã
          });
        });
      }
      
      // 1.5. Kh·ªüi t·∫°o x·ª≠ l√Ω focus cho modal
      function setupModalFocus(modal) {
        // Focus first input
        const firstInput = modal.querySelector('input:not([readonly]):not([disabled])');
        if (firstInput) {
          firstInput.focus();
        }
      }
      ///////////////////////////////////
      // 2. Nh√≥m h√†m th√¥ng b√°o
      ///////////////////////////////////

      // 2.1 H√†m th√¥ng b√°o l·ªói
      function showError(message) {
        Swal.fire({
          icon: 'error',
          title: 'L·ªói',
          text: message,
          confirmButtonText: 'ƒê√≥ng'
        });
      }

      // 2.2 H√†m th√¥ng b√°o th√†nh c√¥ng
      function showSuccess(message) {
        Swal.fire({
          icon: 'success',
          title: 'Th√†nh c√¥ng',
          html: message.replace(/\n/g, '<br>'),
          confirmButtonText: 'ƒê√≥ng'
        });
      }

      // 2.3 H√†m th√¥ng b√°o x√°c nh·∫≠n
      function showConfirm(title, message, callback) {
        // Use SweetAlert for confirmation dialogs as it's already loaded
        Swal.fire({
          icon: 'question',
          title: title,
          text: message,
          showCancelButton: true,
          confirmButtonText: 'ƒê·ªìng √Ω',
          cancelButtonText: 'H·ªßy',
          backdrop: true,
          allowOutsideClick: true
        }).then((result) => {
          if (result.isConfirmed) {
            callback();
          }
        });
      }

      // 2.4 H√†m th√¥ng b√°o ƒëang t·∫£i
      function showLoading() {
        Swal.fire({
          title: 'ƒêang x·ª≠ l√Ω',
          text: 'Vui l√≤ng ƒë·ª£i...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
      }

      // 2.5 H√†m x·ª≠ l√Ω l·ªói script
      function handleScriptError(error) {
        Swal.close();
        showError("L·ªói: " + error.message);
      }
      
      ///////////////////////////////////
      // 3. Nh√≥m h√†m x·ª≠ l√Ω ƒëƒÉng nh·∫≠p
      ///////////////////////////////////

      // 3.1 H√†m x√°c th·ª±c ƒëƒÉng nh·∫≠p
      function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
          showError("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u");
          return;
        }
        
        // Verify credentials
        const departmentUsers = appData.val_DSUserDV;
        
        // Skip header row
        for (let i = 1; i < departmentUsers.length; i++) {
          const user = departmentUsers[i];
          const userUsername = user[CONFIG_COLUMNS.DSUserDV.username];
          const userPassword = user[CONFIG_COLUMNS.DSUserDV.pass];
          
          if (username === userUsername && password === userPassword) {
            // Store user data
            userData = {
              id: user[CONFIG_COLUMNS.DSUserDV.id],
              name: user[CONFIG_COLUMNS.DSUserDV.donvi],
              username: user[CONFIG_COLUMNS.DSUserDV.username],
              pass: user[CONFIG_COLUMNS.DSUserDV.pass],
              kihieu: user[CONFIG_COLUMNS.DSUserDV.kihieu],
              email: user[CONFIG_COLUMNS.DSUserDV.email],
              logo: user[CONFIG_COLUMNS.DSUserDV.logo]
            };
            
            // Hide login form
            document.getElementById('loginSection').style.display = 'none';
            
            // Show main app
            document.getElementById('mainApp').style.display = 'block';
            document.querySelector('.dashboard').style.display = 'block';
            
            // Setup user interface
            setupUserInterface();
            
            // Load repair data
            updateRepairTables();
            
            return;
          }
        }
        
        // Invalid credentials
        showError("T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng");
      }

      // 3.2 H√†m Hi·ªÉn th·ªã/·∫©n m·∫≠t kh·∫©u
      function togglePassword() {
        const passwordInput = document.getElementById('password');
        const toggleIcon = document.querySelector('.toggle-password');
        
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          toggleIcon.classList.remove('fa-eye-slash');
          toggleIcon.classList.add('fa-eye');
        } else {
          passwordInput.type = 'password';
          toggleIcon.classList.remove('fa-eye');
          toggleIcon.classList.add('fa-eye-slash');
        }
      }
      
      ///////////////////////////////////
      // 4. Nh√≥m h√†m x·ª≠ l√Ω giao di·ªán ng∆∞·ªùi d√πng
      ///////////////////////////////////
      // 4.2 H√†m thi·∫øt l·∫≠p giao di·ªán sau khi ƒëƒÉng nh·∫≠p
      function setupUserInterface() {
        // Set user name and avatar
        document.getElementById('userName').textContent = userData.name;
        
        // Set avatar image if available
        if (userData.logo) {
          const logoLink = "https://drive.google.com/thumbnail?id=" + userData.logo + "&sz=s100";
          document.getElementById('userAvatar').src = logoLink;
        }
        // Set department name in repair form
        document.getElementById('departmentName').value = userData.name;
        
        RepairModalManager.ListDropDowns();
        RepairModalManager.ListDropDowns_Requester();
        
        // Reinitialize UI components to ensure modals and other Bootstrap components work properly
        initializeUI();
      }
      
      // 4.2 H√†m Hi·ªÉn th·ªã/·∫©n menu ng∆∞·ªùi d√πng
      function toggleUserMenu() {
        const userMenu = document.getElementById('userMenu');
        if (userMenu.style.display === 'none') {
          userMenu.style.display = 'block';
        } else {
          userMenu.style.display = 'none';
        }
      }
      
      
      ///////////////////////////////////
      // 5. NH√ìM H√ÄM X·ª¨ L√ù MENU DROPDOWN NG∆Ø·ªúI D√ôNG
      ///////////////////////////////////

      ///////////////////////////////////
      // 5.1. Nh√≥m h√†m x·ª≠ l√Ω h·ªì s∆° c√° nh√¢n
      ///////////////////////////////////
      // 5.1.0. H√†m t·∫£i l·∫°i d·ªØ li·ªáu
      function refreshData() {
        // Show loading message
        showLoading();
        
        // Reload DataSC table
        google.script.run
          .withSuccessHandler(function(data) {
            console.log('Data reloaded successfully:', data);
            Swal.close();
            // Update appData with new data
            appData.val_DataSC = data;
            console.log('appData updated with new DataSC');
            
            // Refresh dropdowns
            RepairModalManager.ListDropDowns();
            RepairModalManager.ListDropDowns_Requester();
            console.log('Dropdowns refreshed');
            
            // Refresh tables
            if (typeof refreshTables === 'function') {
              refreshTables();
              console.log('Tables refreshed');
            }
            
            // Show success message
            showSuccess('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t');
            console.log('Data refresh completed successfully');
          })
          .withFailureHandler(function(error) {
            Swal.close();
            showError('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message);
          })
          .getDataSC();
      }
      // 5.1.1. H√†m s·ª≠a h·ªì s∆° ng∆∞·ªùi d√πng
      function editUserProfile() {
        // Hide user menu
        document.getElementById('userMenu').style.display = 'none';
        
        // Fill form with current user data
        document.getElementById('profileName').value = userData.name || '';
        document.getElementById('profileEmail').value = userData.email || '';
        document.getElementById('profileLogo').value = userData.logo || '';
        
        // Show modal using Bootstrap 5 syntax
        const modalElement = document.getElementById('editProfileModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
      
      // 5.1.2. H√†m l∆∞u th√¥ng tin h·ªì s∆° ng∆∞·ªùi d√πng
      function saveProfile() {
        // Get form values
        const name = document.getElementById('profileName').value;
        const email = document.getElementById('profileEmail').value;
        const logo = document.getElementById('profileLogo').value;
        
        // Validate form
        if (!name) {
          showError("Vui l√≤ng nh·∫≠p t√™n ƒë∆°n v·ªã");
          return;
        }
        
        if (!email) {
          showError("Vui l√≤ng nh·∫≠p email");
          return;
        }
        
        // Prepare data for update
        const profileData = {
          id: userData.id,
          donvi: name,
          email: email,
          logo: logo
        };
        
        // Show loading message
        showLoading();
        
        // Send update to server
        google.script.run
          .withSuccessHandler(handleProfileUpdated)
          .withFailureHandler(handleScriptError)
          .updateUserProfile(profileData);
      }
      
      // 5.1.3. H√†m x·ª≠ l√Ω c·∫≠p nh·∫≠t th√¥ng tin h·ªì s∆° ng∆∞·ªùi d√πng th√†nh c√¥ng
      function handleProfileUpdated(result) {
        Swal.close();
        
        if (result) {
          // Update user data
          for (let i = 1; i < appData.val_DSUserDV.length; i++) {
            if (appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.id] == userData.id) {
              appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.donvi] = document.getElementById('profileName').value;
              appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.email] = document.getElementById('profileEmail').value;
              appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.logo] = document.getElementById('profileLogo').value;
              break;
            }
          }
          
          // Update userData
          userData.name = document.getElementById('profileName').value;
          userData.email = document.getElementById('profileEmail').value;
          userData.logo = document.getElementById('profileLogo').value;
          
          // Update UI
          document.getElementById('userName').textContent = userData.name;
          if (userData.logo) {
            //document.getElementById('userAvatar').src = `https://drive.google.com/thumbnail?id=${userData.logo}&sz=s100`;
          }
          
          // Close modal
          bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
          
          // Show success message
          showSuccess("C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng");
        } else {
          showError("C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t th√¥ng tin");
        }
      }
      
      ///////////////////////////////////
      // 5.2. Nh√≥m h√†m x·ª≠ l√Ω m·∫≠t kh·∫©u
      ///////////////////////////////////

      // 5.2.1. H√†m thay ƒë·ªïi m·∫≠t kh·∫©u
      function changePassword() {
        // Hide user menu
        document.getElementById('userMenu').style.display = 'none';
        
        // Clear form
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        
        // Show modal using Bootstrap 5 syntax
        const modalElement = document.getElementById('changePasswordModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
      
      // 5.2.2. H√†m hi·ªÉn th·ªã m·∫≠t kh·∫©u
      function togglePasswordField(fieldId) {
        const passwordInput = document.getElementById(fieldId);
        const toggleButton = passwordInput.nextElementSibling;
        const toggleIcon = toggleButton.querySelector('i');
        
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          toggleIcon.classList.remove('fa-eye-slash');
          toggleIcon.classList.add('fa-eye');
        } else {
          passwordInput.type = 'password';
          toggleIcon.classList.remove('fa-eye');
          toggleIcon.classList.add('fa-eye-slash');
        }
      }
      
      // 5.2.3. H√†m l∆∞u m·∫≠t kh·∫©u m·ªõi
      function saveNewPassword() {
        // Get form values
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // Validate form
        if (!currentPassword) {
          showError("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i");
          return;
        }
        
        if (!newPassword) {
          showError("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi");
          return;
        }
        
        if (!confirmPassword) {
          showError("Vui l√≤ng x√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi");
          return;
        }
        
        if (newPassword !== confirmPassword) {
          showError("M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp");
          return;
        }
        
        // Verify current password (find user in departmentUsers by userData.id)
        let currentUserPassword = '';
        for (let i = 1; i < appData.val_DSUserDV.length; i++) {
          if (appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.id] == userData.id) {
            currentUserPassword = appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.pass];
            break;
          }
        }
        
        if (currentPassword !== currentUserPassword) {
          showError("M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng");
          return;
        }
        
        // Prepare data for update
        const passwordData = {
          id: userData.id,
          newPassword: newPassword
        };
        
        showLoading();
        
        // Send update to server
        google.script.run
          .withSuccessHandler(handlePasswordUpdated)
          .withFailureHandler(handleScriptError)
          .updateUserPassword(passwordData);
      }
      
      // 5.2.4. H√†m x·ª≠ l√Ω c·∫≠p nh·∫≠t m·∫≠t kh·∫©u th√†nh c√¥ng
      function handlePasswordUpdated(result) {
        Swal.close();
        
        if (result) {
          // Update password in the cached data
          for (let i = 1; i < appData.val_DSUserDV.length; i++) {
            if (appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.id] == userData.id) {
              appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.pass] = document.getElementById('newPassword').value;
              break;
            }
          }
          
          // Close modal
          bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
          
          // Show success message
          showSuccess("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng");
        } else {
          showError("C√≥ l·ªói x·∫£y ra khi ƒë·ªïi m·∫≠t kh·∫©u");
        }
      }
      
      ///////////////////////////////////
      // 5.3. Nh√≥m h√†m ƒëƒÉng xu·∫•t
      ///////////////////////////////////
      // 5.3.1 H√†m ƒêƒÉng xu·∫•t
      function logout() {
        showConfirm("ƒêƒÉng xu·∫•t", "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng?", function() {
          // Reset user data
          userData = {};
          
          // Hide main app
          document.getElementById('mainApp').style.display = 'none';
          document.querySelector('.dashboard').style.display = 'none';
          document.getElementById('userMenu').style.display = 'none';
          
          // Show login form
          document.getElementById('loginSection').style.display = 'block';
          
          // Clear login form
          document.getElementById('username').value = '';
          document.getElementById('password').value = '';
          
          // Show success message
          showSuccess("ƒêƒÉng xu·∫•t th√†nh c√¥ng!");
        });
      }
      
      ///////////////////////////////////
      // 6. Nh√≥m h√†m x·ª≠ l√Ω t√¨m ki·∫øm
      ///////////////////////////////////
      
      // 6.2. H√†m t√¨m ki·∫øm b√°o h·ªèng
      function searchRepair() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        if (!searchTerm) {
          showError("Vui l√≤ng nh·∫≠p n·ªôi dung t√¨m ki·∫øm");
          return;
        }
        
        // Filter repair tables based on search term
        filterRepairTables(searchTerm);
      }
      
      // 6.3. H√†m l·ªçc b√°o h·ªèng
      function filterRepairTables(searchTerm) {
        try {
          // Get all table rows in all tabs
          const allTables = ['history_baohong', 'history_dangsua', 'history_baohanh', 'history_suangoai'];
          const tabIds = ['tab-baohong', 'tab-dangsua', 'tab-baohanh', 'tab-suangoai'];
          const tabNames = ['B√°o h·ªèng', 'ƒêang s·ª≠a', 'B·∫£o h√†nh', 'S·ª≠a ngo√†i'];
          
          let totalMatchCount = 0;
          let matchCountPerTab = [0, 0, 0, 0];
          
          // Search in each tab and count matches
          allTables.forEach((tableId, index) => {
            const tableBody = document.getElementById(tableId);
            const rows = tableBody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
              const content = rows[i].innerText.toLowerCase();
              if (content.includes(searchTerm)) {
                rows[i].style.display = '';
                totalMatchCount++;
                matchCountPerTab[index]++;
              } else {
                rows[i].style.display = 'none';
              }
            }
            
            // Update tab name with match count
            document.getElementById(tabIds[index]).textContent = `${tabNames[index]} (${matchCountPerTab[index]})`;
          });
          
          if (totalMatchCount === 0) {
            showError("Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p");
          } else {
            // Create a detailed message with counts per tab
            let detailMessage = `T√¨m th·∫•y ${totalMatchCount} k·∫øt qu·∫£ ph√π h·ª£p:\n`;
            allTables.forEach((tableId, index) => {
              if (matchCountPerTab[index] > 0) {
                detailMessage += `- ${tabNames[index]}: ${matchCountPerTab[index]} k·∫øt qu·∫£\n`;
              }
            });
            
            showSuccess(detailMessage);
          }
        } catch (error) {          
          showError('L·ªói khi l·ªçc d·ªØ li·ªáu t√¨m ki·∫øm: ' + error.message);
        }
      }
      
      // 6.4. H√†m h·ªßy t√¨m ki·∫øm b√°o h·ªèng
      function cancelSearch() {
        // Clear search input
        document.getElementById('searchInput').value = '';
        
        // Reset repair tables to show all items
        updateRepairTables();
      showSuccess("ƒê√£ h·ªßy t√¨m ki·∫øm v√† hi·ªÉn th·ªã l·∫°i t·∫•t c·∫£ d·ªØ li·ªáu");
      }

      ///////////////////////////////////
      // 7. Nh√≥m h√†m x·ª≠ l√Ω hi·ªÉn th·ªã danh s√°ch s·ª≠a ch·ªØa
      ///////////////////////////////////
      // 7.1. H√†m c·∫≠p nh·∫≠t t·∫•t c·∫£ c√°c b·∫£ng b√°o h·ªèng
      function updateRepairTables() {
        const countBaoHong = updateTable('baohong', CONFIG_ENUM.TRANGTHAI.BAO_HONG);
        const countDangSua = updateTable('dangsua', CONFIG_ENUM.TRANGTHAI.DANG_SUA);
        const countBaoHanh = updateTable('baohanh', CONFIG_ENUM.TRANGTHAI.BAO_HANH);
        const countSuaNgoai = updateTable('suangoai', CONFIG_ENUM.TRANGTHAI.SUA_NGOAI);
        
        // Calculate total count
        const totalCount = countBaoHong + countDangSua + countBaoHanh + countSuaNgoai;
        
        // Log counts to console for debugging
        console.log(`T·ªïng s·ªë: ${totalCount} | B√°o h·ªèng: ${countBaoHong} | ƒêang s·ª≠a: ${countDangSua} | B·∫£o h√†nh: ${countBaoHanh} | S·ª≠a ngo√†i: ${countSuaNgoai}`);
        
        return {
          total: totalCount,
          baoHong: countBaoHong,
          dangSua: countDangSua,
          baoHanh: countBaoHanh,
          suaNgoai: countSuaNgoai
        };
      }
      
      // 7.2. H√†m c·∫≠p nh·∫≠t b·∫£ng theo tr·∫°ng th√°i
      function updateTable(tableType, status) {
        try {
          // Get table body
          const tableBody = document.getElementById(`history_${tableType}`);
          tableBody.innerHTML = '';
          
          // Counter for repair items
          let count = 0;
          
          // Process data
          appData.val_DataSC.slice(1).forEach(item => {
            // Check if this item matches the status and current user
            if (item[CONFIG_COLUMNS.DataSC.trangthai] == status && item[CONFIG_COLUMNS.DataSC.iduserdv] == userData.id) {
              count++;
              
              // Create row
              const row = document.createElement('tr');
              
              // STT cell
              const sttCell = document.createElement('td');
              sttCell.textContent = count;
              row.appendChild(sttCell);
              
              // Get equipment and repair person info
              const equipmentId = item[CONFIG_COLUMNS.DataSC.idthietbi];
              const equipment = appData.val_DSThietBi.find(eq => eq[CONFIG_COLUMNS.DSThietBi.id] === equipmentId);
              
              const repairPersonId = item[CONFIG_COLUMNS.DataSC.idusersua];
              const repairPerson = appData.val_DSUserSua.find(rp => rp[CONFIG_COLUMNS.DSUserSua.id] === repairPersonId);
              
              // Content cell
              const contentCell = document.createElement('td');
              contentCell.innerHTML = `
                üõ†Ô∏è ${item[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao]} ‚ö†Ô∏è ${item[CONFIG_COLUMNS.DataSC.id]}
                <br>- Th√¥ng tin thi·∫øt b·ªã: ‚ôüÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.tentb] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.model] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.serial] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.nuocsx] : ''}
                <br>- Th√¥ng tin ng∆∞·ªùi s·ª≠a: üë®${repairPerson ? repairPerson[CONFIG_COLUMNS.DSUserSua.hoten] : ''} 
                üìÖ${item[CONFIG_COLUMNS.DataSC.ngaydonvibao]}
              `;
              row.appendChild(contentCell);
              
              // Action cell
              const actionCell = document.createElement('td');
              actionCell.classList.add('action-buttons');
              
              // View button
              const viewBtn = document.createElement('button');
              viewBtn.classList.add('btn', 'btn-success', 'btn-sm', 'me-1');
              viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
              viewBtn.title = 'Xem chi ti·∫øt';
              viewBtn.onclick = () => showViewRepairModal(item[CONFIG_COLUMNS.DataSC.id]);
              actionCell.appendChild(viewBtn);

              // Add edit and delete buttons only for "b√°o h·ªèng" status
              if (status === CONFIG_ENUM.TRANGTHAI.BAO_HONG) {
              // Edit button
              const editBtn = document.createElement('button');
              editBtn.classList.add('btn', 'btn-primary', 'btn-sm', 'me-1');
              editBtn.innerHTML = '<i class="fas fa-edit"></i>';
              editBtn.title = 'Ch·ªânh s·ª≠a';
                editBtn.onclick = () => showEditRepairModal(item[CONFIG_COLUMNS.DataSC.id]);
              actionCell.appendChild(editBtn);
              
              // Delete button
              const deleteBtn = document.createElement('button');
              deleteBtn.classList.add('btn', 'btn-danger', 'btn-sm', 'me-1');
              deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
              deleteBtn.title = 'X√≥a';
                deleteBtn.onclick = () => showDeleteRepairModal(item[CONFIG_COLUMNS.DataSC.id]);
              actionCell.appendChild(deleteBtn);
              }
              
              row.appendChild(actionCell);
              
              // Add row to table
              tableBody.appendChild(row);
            }
          });
          
          // Update tab count
          document.getElementById(`tab-${tableType}`).textContent = `${getTableTitle(tableType)} (${count})`;
          
          // Return the count for potential use elsewhere
          return count;
        } catch (error) {          
          showError(`L·ªói khi c·∫≠p nh·∫≠t b·∫£ng ${getTableTitle(tableType)}: ${error.message}`);
          return 0;
        }
      }
      
      // Helper function to get table title
      function getTableTitle(tableType) {
        const titles = {
          'baohong': 'B√°o h·ªèng',
          'dangsua': 'ƒêang s·ª≠a',
          'baohanh': 'B·∫£o h√†nh',
          'suangoai': 'S·ª≠a ngo√†i'
        };
        return titles[tableType] || tableType;
      }

      ///////////////////////////////////
      // 8. NH√ìM H√ÄM X·ª¨ L√ù FORM D·ªÆ LI·ªÜU (TH√äM, S·ª¨A, X√ìA)
      ///////////////////////////////////
      // 8.1. H√†m ƒëi·ªÅn d·ªØ li·ªáu cho c√°c dropdown list: Ng∆∞·ªùi s·ª≠a ch·ªØa, Nh√≥m thi·∫øt b·ªã, M·ª©c ƒë·ªô ∆∞u ti√™n

      // H√†m c·∫≠p nh·∫≠t d·ªØ li·ªáu sau khi th√™m/s·ª≠a/x√≥a
      function updateData(result) {
        try {
          // C·∫≠p nh·∫≠t d·ªØ li·ªáu trong appData
          if (result) {
            // T√¨m v·ªã tr√≠ c·ªßa b·∫£n ghi trong m·∫£ng
            const index = appData.val_DataSC.findIndex(item => 
              item[CONFIG_COLUMNS.DataSC.id] === result[CONFIG_COLUMNS.DataSC.id]
            );

            if (index !== -1) {
              // N·∫øu ƒë√£ t·ªìn t·∫°i, c·∫≠p nh·∫≠t
              appData.val_DataSC[index] = result;
            } else {
              // N·∫øu ch∆∞a t·ªìn t·∫°i, th√™m m·ªõi
              appData.val_DataSC.push(result);
            }
          }
        } catch (error) {
          console.error("Error in updateData:", error);
          throw error;
        }
      }

      // H√†m c·∫≠p nh·∫≠t giao di·ªán sau khi thay ƒë·ªïi d·ªØ li·ªáu
      function updateUI() {
        try {
          // C·∫≠p nh·∫≠t c√°c b·∫£ng hi·ªÉn th·ªã
          updateRepairTables();
          
          // C·∫≠p nh·∫≠t c√°c dropdown list
          RepairModalManager.ListDropDowns();
        } catch (error) {
          console.error("Error in updateUI:", error);
          throw error;
        }
      }

      // 8.8. Helper to get a single instance of FormRepairModal
      function getFormRepairModalInstance() {
        const modalElement = document.getElementById('FormRepairModal');
        if (formRepairModalInstance) {
          formRepairModalInstance.dispose(); // Cleanup instance c≈©
        }
        formRepairModalInstance = new bootstrap.Modal(modalElement, {
          backdrop: 'static', // NgƒÉn click outside ƒë·ªÉ ƒë√≥ng
        });
        return formRepairModalInstance;
      }

      // 8.9. H√†m hi·ªÉn th·ªã modal th√™m b√°o h·ªèng
      function showAddRepairModal() {
        try {
          console.log('Opening repair add form');
          RepairModalManager.open(RepairModalManager.MODE.ADD);
        } catch (error) {          
          showError('C√≥ l·ªói khi m·ªü form th√™m m·ªõi: ' + error.message);
        }
      }

      // 8.10. H√†m hi·ªÉn th·ªã modal s·ª≠a b√°o h·ªèng
      function showEditRepairModal(repairId) {
        try {
          console.log('Opening repair edit for ID:', repairId);
          if (!repairId) {
            showError('ID b√°o h·ªèng kh√¥ng h·ª£p l·ªá');
            return;
          }
          RepairModalManager.open(RepairModalManager.MODE.EDIT, repairId);
        } catch (error) {          
          showError('C√≥ l·ªói khi m·ªü form ch·ªânh s·ª≠a: ' + error.message);
        }
      }
      
      // 8.11. H√†m hi·ªÉn th·ªã modal xem chi ti·∫øt b√°o h·ªèng
      function showViewRepairModal(repairId) {
        try {
          console.log('Opening repair details for ID:', repairId);
          if (!repairId) {
            showError('ID b√°o h·ªèng kh√¥ng h·ª£p l·ªá');
            return;
          }
          RepairModalManager.open(RepairModalManager.MODE.VIEW, repairId);
        } catch (error) {          
          showError('C√≥ l·ªói khi m·ªü chi ti·∫øt b√°o h·ªèng: ' + error.message);
        }
      }
      
      // 8.12. H√†m hi·ªÉn th·ªã modal x√≥a b√°o h·ªèng
      function showDeleteRepairModal(repairId) {
        showConfirm("X√≥a b√°o h·ªèng", "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√°o h·ªèng n√†y?", function() {
          showLoading();
          google.script.run
            .withSuccessHandler(function(result) {
              Swal.close();
              if (result) {
                // Remove from appData
                const index = appData.val_DataSC.findIndex(item => 
                  item[CONFIG_COLUMNS.DataSC.id] === repairId
                );
                if (index !== -1) {
                  appData.val_DataSC.splice(index, 1);
                }
                
                // Refresh repair tables
                updateRepairTables();
                
                showSuccess("X√≥a b√°o h·ªèng th√†nh c√¥ng");
              } else {
                showError("C√≥ l·ªói x·∫£y ra khi x√≥a b√°o h·ªèng");
              }
            })
            .withFailureHandler(handleScriptError)
            .SC_delete(repairId);
        });
      }
      
      function saveRepair() {
        try {
          // Collect form data
          const formData = RepairModalManager.collectFormData();
          
          // Validate form data
          if (!formData.Name_NguoiYeuCau) {
            showError("Vui l√≤ng nh·∫≠p ng∆∞·ªùi y√™u c·∫ßu");
            return;
          }
          
          if (!formData.SDT_NguoiYeuCau) {
            showError("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i y√™u c·∫ßu");
            return;
          }
          
          if (!formData.TinhTrang_ThietBi) {
            showError("Vui l√≤ng nh·∫≠p t√¨nh tr·∫°ng thi·∫øt b·ªã");
            return;
          }
          
          if (!formData.ID_ThietBi) {
            showError("Vui l√≤ng ch·ªçn thi·∫øt b·ªã");
            return;
          }
          
          if (!formData.ID_MucDo_YeuCau) {
            showError("Vui l√≤ng ch·ªçn m·ª©c ƒë·ªô ∆∞u ti√™n");
            return;
          }

          // Prepare data for saving
          const arr_repairDataMain = RepairModalManager.arr_MainSC_prepare(formData);
          const textTelegram = RepairModalManager.textTelegram_prepare(formData);
          const idTelegram_UserRepair = appData.val_DSUserSua.find(
            item => item[CONFIG_COLUMNS.DSUserSua.id] === formData.ID_NguoiSua
          )?.[CONFIG_COLUMNS.DSUserSua.usetele] || '';
          

          const repairData = {
            TrangThai_Form: RepairModalManager.state.mode,
            arr_repairDataMain: arr_repairDataMain,
            idTelegram_UserRepair: idTelegram_UserRepair,
            textTelegram: textTelegram
          };

          // Show loading message
          showLoading();

          // Handle based on mode
          switch (RepairModalManager.state.mode) {
            case RepairModalManager.MODE.ADD:
              google.script.run
                .withSuccessHandler(handleAddRepair)
                .withFailureHandler(handleScriptError)
                .SC_thembaohong(repairData);
              break;
              
            case RepairModalManager.MODE.EDIT:
              google.script.run
                .withSuccessHandler(handleEditRepair)
                .withFailureHandler(handleScriptError)
                .SC_suabaohong(repairData);
              break;
          }
        } catch (error) {          
          showError("C√≥ l·ªói x·∫£y ra: " + error.message);
        }
      }

      function handleAddRepair(result) {
        try {
          if (result) {
            // ƒê√≥ng SweetAlert loading
            Swal.close();

            // C·∫≠p nh·∫≠t d·ªØ li·ªáu v√† giao di·ªán
            updateData(result);
            updateUI();

            // ƒê√≥ng modal
            const modalElement = document.getElementById('FormRepairModal');
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
              modalInstance.hide();
            }

            // Th√¥ng b√°o th√†nh c√¥ng
            showSuccess("Th√™m b√°o h·ªèng th√†nh c√¥ng");
          } else {
            showError("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu t·ª´ server");
          }
        } catch (error) {          
          showError("C√≥ l·ªói x·∫£y ra: " + error.message);
        }
      }

      function handleEditRepair(result) {
        try {
          Swal.close();
          
          if (result) {
            // ƒê√≥ng modal
            const modalInstance = getFormRepairModalInstance(); // L·∫•y instance
            modalInstance.hide(); // G·ªçi ph∆∞∆°ng th·ª©c hide ƒë·ªÉ ƒë√≥ng modal

            // Update appData with edited repair data
            const index = appData.val_DataSC.findIndex(item => 
              item[CONFIG_COLUMNS.DataSC.id] === result[CONFIG_COLUMNS.DataSC.id]
            );
            if (index !== -1) {
              appData.val_DataSC[index] = result;
            }
            
            // Refresh repair tables
            updateRepairTables();
            
            // Show success message
            showSuccess("C·∫≠p nh·∫≠t b√°o h·ªèng th√†nh c√¥ng");
          } else {
            showError("C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t b√°o h·ªèng");
          }
        } catch (error) {          
          showError("C√≥ l·ªói x·∫£y ra: " + error.message);
        }
      }

      // RepairModalManager object to handle repair modal operations
      const RepairModalManager = {
        // 1. Qu·∫£n l√Ω tr·∫°ng th√°i
        state: {
          isOpen: false,      // Modal open/close state
          mode: null,         // Operation mode (ADD/EDIT/VIEW)
          formData: null,     // Current form data
          originalData: null  // Original data (for EDIT/VIEW)
        },

        // 2. C√°c h·∫±ng s·ªë mode
        MODE: {
          ADD: 1,
          EDIT: 2,
          VIEW: 3,
          DELETE: 4
        },

        // 3. Kh·ªüi t·∫°o modal manager
        initialize() {
          const modalElement = document.getElementById('FormRepairModal');
          
          // 3.1. Listen for modal hidden event
          modalElement.addEventListener('hidden.bs.modal', () => {
            this.handleModalHidden();
          });
          
          // 3.2. Listen for modal shown event  
          modalElement.addEventListener('shown.bs.modal', () => {
            this.handleModalShown();
          });
        },

        // 3.3. Handle modal hidden event
        handleModalHidden() {
          this.state.isOpen = false;
          this.state.mode = null;
          this.state.formData = null;
          this.state.originalData = null;
          
          // Cleanup backdrop
          const backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) {
            backdrop.remove();
          }
          
          // Dispose modal instance
          if (formRepairModalInstance) {
            formRepairModalInstance.dispose();
            formRepairModalInstance = null;
          }
        },

        // 3.4. Handle modal shown event
        handleModalShown() {
          this.state.isOpen = true;
        },

        // 3.6. M·ªü modal v·ªõi mode v√† ID s·ª≠a ch·ªØa
        open(mode, repairId = null) {
          try {
            // Cleanup tr∆∞·ªõc khi m·ªü modal m·ªõi
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
              backdrop.remove();
            }
            
            this.state.mode = mode;
            const modalElement = document.getElementById('FormRepairModal');
            const modalTitle = modalElement.querySelector('.modal-title');
            const saveButton = modalElement.querySelector('button[onclick="saveRepair()"]');
            this.ListDropDowns_Requester();

            // Configure UI based on mode
            switch (mode) {
              case this.MODE.ADD:
                modalTitle.textContent = 'Th√™m b√°o h·ªèng m·ªõi';
                saveButton.style.display = 'block';
                saveButton.textContent = 'L∆∞u';
                document.getElementById('repairId').value = this.generateRepairID();
                this.valFormRepair_Add();
                this.EnDisableField_Add();
                break;

              case this.MODE.EDIT:
                modalTitle.textContent = 'Ch·ªânh s·ª≠a b√°o h·ªèng';
                saveButton.style.display = 'block';
                saveButton.textContent = 'C·∫≠p nh·∫≠t';
                this.valFormRepair_Edit_View(repairId);
                this.EnDisableField_Edit();
                break;

              case this.MODE.VIEW:
                modalTitle.textContent = 'Chi ti·∫øt b√°o h·ªèng';
                saveButton.style.display = 'none';
                this.valFormRepair_Edit_View(repairId);
                this.EnDisableField_View();
                break;
            }

            // Show modal sau khi ƒë√£ setup xong
            getFormRepairModalInstance().show();

          } catch (error) {
            // Cleanup n·∫øu c√≥ l·ªói
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
              backdrop.remove();
            }
            showError('C√≥ l·ªói khi m·ªü form: ' + error.message);
          }
        },

        // 3.7. H√†m t·∫°o ID s·ª≠a ch·ªØa
        generateRepairID() {
          const Time_now = new Date();
          
          // Find val_Repair.Max Id_Count
          if (val_Repair.MaxId_Count == 0) {
            // Filter data by department
            const userDeptRepairs = appData.val_DataSC.filter(row => 
              row && row[CONFIG_COLUMNS.DataSC.iduserdv] === userData.id
            );
            
            if (userDeptRepairs.length > 0) {
              const sequenceNumbers = userDeptRepairs
                .map(row => {
                  if (!row || !row[CONFIG_COLUMNS.DataSC.id]) return 0;
                  
                  const parts = row[CONFIG_COLUMNS.DataSC.id].split('.');
                  if (parts.length < 4) return 0;
                  
                  const currentYear = Time_now.getFullYear().toString().slice(-2);
                  const idYear = parts[2].slice(0, 2);
                  return idYear === currentYear ? parseInt(parts[3], 10) : 0;
                })
                .filter(num => !isNaN(num));
              
              if (sequenceNumbers.length > 0) {
                val_Repair.MaxId_Count = Math.max(...sequenceNumbers);
              }
            }
          }

          const sequenceNumber = ("000" + (val_Repair.MaxId_Count + 1)).slice(-3);
          const year = Time_now.getFullYear().toString().slice(-2);
          const month = ("0" + (Time_now.getMonth() + 1)).slice(-2);
          const day = ("0" + Time_now.getDate()).slice(-2);
          const datePart = year + month + day;
          const milisecondPart = Time_now.getMilliseconds().toString().padStart(3, '0');
          const repairID = "SC." + userData.kihieu + "." + datePart + "." + sequenceNumber + "." + milisecondPart;
          console.log('Generated repair ID:', repairID);
          
          return repairID;
        },

        // 3.8. Gi√° tr·ªã m·∫∑c ƒë·ªãnh cho form th√™m b√°o h·ªèng
        valFormRepair_Add() {
          document.getElementById('equipmentGroup').selectedIndex = 0;
          document.getElementById('equipmentId').innerHTML = '<option value="">-- Ch·ªçn thi·∫øt b·ªã --</option>';
          document.getElementById('equipmentStatus').value = '';
          document.getElementById('priorityLevel').selectedIndex = 0;
          document.getElementById('notes').value = '';
          this.clearEquipmentDetails();
        },

        // 3.9. Gi√° tr·ªã cho form ch·ªânh s·ª≠a/xem b√°o h·ªèng
        valFormRepair_Edit_View(repairId) {
          const repair = appData.val_DataSC.find(item => 
            item[CONFIG_COLUMNS.DataSC.id] === repairId
          );

          if (repair) {
            // Fill form with repair data
            document.getElementById('repairId').value = repair[CONFIG_COLUMNS.DataSC.id];
            document.getElementById('requesterName').value = repair[CONFIG_COLUMNS.DataSC.hoten];
            document.getElementById('requesterPhone').value = repair[CONFIG_COLUMNS.DataSC.sdt];
            document.getElementById('repairPerson').value = repair[CONFIG_COLUMNS.DataSC.idusersua];
            
            this.updateRepairPersonPhone();
            
            // Load equipment details
            const equipmentId = repair[CONFIG_COLUMNS.DataSC.idthietbi];
            const equipment = appData.val_DSThietBi.find(eq => eq[CONFIG_COLUMNS.DSThietBi.id] === equipmentId);
            
            if (equipment) {
              document.getElementById('equipmentGroup').value = equipment[CONFIG_COLUMNS.DSThietBi.nhomtb];
              this.updateEquipmentList();
              document.getElementById('equipmentId').value = equipmentId;
              this.updateEquipmentDetails();
            }

            document.getElementById('equipmentStatus').value = repair[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao];
            document.getElementById('priorityLevel').value = repair[CONFIG_COLUMNS.DataSC.mucdo];
            document.getElementById('notes').value = repair[CONFIG_COLUMNS.DataSC.ghichu];
          }
        },

        // 3.10. En/Disable c√°c tr∆∞·ªùng trong form xem b√°o h·ªèng
        EnDisableField_View() {
          document.getElementById('requesterName').disabled = true;
          document.getElementById('requesterPhone').disabled = true;
          document.getElementById('repairPerson').disabled = true;
          document.getElementById('equipmentGroup').disabled = true;
          document.getElementById('equipmentId').disabled = true;
          document.getElementById('equipmentStatus').disabled = true;
          document.getElementById('priorityLevel').disabled = true;
          document.getElementById('notes').disabled = true;
        },

        // 3.11. En/Disable c√°c tr∆∞·ªùng trong form th√™m b√°o h·ªèng
        EnDisableField_Add() {
          document.getElementById('requesterName').disabled = false;
          document.getElementById('requesterPhone').disabled = false;
          document.getElementById('repairPerson').disabled = false;
          document.getElementById('equipmentGroup').disabled = false;
          document.getElementById('equipmentId').disabled = false;
          document.getElementById('equipmentStatus').disabled = false; 
          document.getElementById('priorityLevel').disabled = false; 
          document.getElementById('notes').disabled = false; 
        },

        // 3.12. En/Disable c√°c tr∆∞·ªùng trong form ch·ªânh s·ª≠a
        EnDisableField_Edit() {
          document.getElementById('requesterName').disabled = false;
          document.getElementById('requesterPhone').disabled = false;
          document.getElementById('repairPerson').disabled = false;
          document.getElementById('equipmentGroup').disabled = false;
          document.getElementById('equipmentId').disabled = false;
          document.getElementById('equipmentStatus').disabled = false;
          document.getElementById('priorityLevel').disabled = false;
          document.getElementById('notes').disabled = false;
        },

        
        // 3.5. H√†m ƒëi·ªÅn d·ªØ li·ªáu cho c√°c dropdown list: Ng∆∞·ªùi s·ª≠a ch·ªØa, Nh√≥m thi·∫øt b·ªã, M·ª©c ƒë·ªô ∆∞u ti√™n
        ListDropDowns() {
          // 3.5.1. Dropdown Ng∆∞·ªùi s·ª≠a ch·ªØa
        const repairPersonSelect = document.getElementById('repairPerson');
        repairPersonSelect.innerHTML = '<option value="">-- Ch·ªçn ng∆∞·ªùi s·ª≠a ch·ªØa --</option>';
        const repairPersons = appData.val_DSUserSua;
        for (let i = 1; i < repairPersons.length; i++) {
          const person = repairPersons[i];
          const option = document.createElement('option');
          option.value = person[CONFIG_COLUMNS.DSUserSua.id];
          option.textContent = person[CONFIG_COLUMNS.DSUserSua.hoten];
          repairPersonSelect.appendChild(option);
        }
          // 3.5.2. Dropdown Nh√≥m thi·∫øt b·ªã
        const equipmentGroupSelect = document.getElementById('equipmentGroup');
        equipmentGroupSelect.innerHTML = '<option value="">-- Ch·ªçn nh√≥m thi·∫øt b·ªã --</option>';
          // L·ªçc thi·∫øt b·ªã thu·ªôc ƒë∆°n v·ªã hi·ªán t·∫°i
        const equipment = appData.val_DSThietBi;
        const departmentEquipment = equipment.filter(item => 
          item[CONFIG_COLUMNS.DSThietBi.donvi] == userData.id // Theo c·ªôt "ƒê∆°n v·ªã_TB"
        );
          // T·∫°o Set ƒë·ªÉ l∆∞u c√°c nh√≥m thi·∫øt b·ªã kh√¥ng tr√πng l·∫∑p c·ªßa ƒë∆°n v·ªã
        const departmentGroups = new Set();
        departmentEquipment.forEach(item => {
          if (item[CONFIG_COLUMNS.DSThietBi.nhomtb]) {
            departmentGroups.add(item[CONFIG_COLUMNS.DSThietBi.nhomtb]);
          }
        });
          // L·ªçc Nh√≥m thi·∫øt b·ªã theo thi·∫øt b·ªã
        const equipmentGroups = appData.val_DSNhomTB;
        for (let i = 1; i < equipmentGroups.length; i++) {
          const group = equipmentGroups[i];
          const groupName = group[CONFIG_COLUMNS.DSNhomTB.nhomtb];
          const groupID = group[CONFIG_COLUMNS.DSNhomTB.id];
          // Ch·ªâ th√™m nh√≥m thi·∫øt b·ªã n·∫øu ƒë∆°n v·ªã hi·ªán t·∫°i c√≥ thi·∫øt b·ªã thu·ªôc nh√≥m ƒë√≥
          if (departmentGroups.has(groupID)) {
            const option = document.createElement('option');
            option.value = groupID;
            option.textContent = groupName;
            equipmentGroupSelect.appendChild(option);
          }
        }
          // 3.5.3. M·ª©c ƒë·ªô ∆∞u ti√™n
        const prioritySelect = document.getElementById('priorityLevel');
        prioritySelect.innerHTML = '<option value="">-- Ch·ªçn m·ª©c ƒë·ªô ∆∞u ti√™n --</option>';
        const enumSettings = appData.val_EnumSetting;
        const priorities = enumSettings.filter(item => item[1] === "M·ª©c ƒë·ªô YC");
        for (let i = 0; i < priorities.length; i++) {
          const priority = priorities[i];
          const option = document.createElement('option');
          option.value = priority[0]; // ID
          option.textContent = priority[2]; // T√™n m·ª©c ƒë·ªô
          prioritySelect.appendChild(option);
        }
        },

        // 3.13. H√†m ƒëi·ªÅn d·ªØ li·ªáu cho c√°c dropdown list: Ng∆∞·ªùi y√™u c·∫ßu
        ListDropDowns_Requester() {
          const repairs = appData.val_DataSC;
          // L·ªçc b√°o h·ªèng thu·ªôc ƒë∆°n v·ªã hi·ªán t·∫°i
          const departmentRepairs = repairs.filter(item => 
            item[CONFIG_COLUMNS.DataSC.iduserdv] == userData.id
          );

          const requesters = new Set();

          // L·ªçc v√† th√™m t√™n ng∆∞·ªùi y√™u c·∫ßu kh√¥ng tr√πng l·∫∑p v√†o Set
          departmentRepairs.forEach(repair => {
            if (repair[CONFIG_COLUMNS.DataSC.hoten]) {
              requesters.add(repair[CONFIG_COLUMNS.DataSC.hoten]);
            }
          });

          // Dropdown Ng∆∞·ªùi y√™u c·∫ßu
          const requesterList = document.getElementById('requesterList');
          requesterList.innerHTML = ''; // X√≥a c√°c t√πy ch·ªçn c≈©
          requesters.forEach(requester => {
            const option = document.createElement('option');
            option.value = requester;
            requesterList.appendChild(option);
          });

            // 3.5.10. Dropdown T√¨nh tr·∫°ng thi·∫øt b·ªã
        const statusList = document.getElementById('statusList');
        statusList.innerHTML = '';
        const statuses = new Set();
        departmentRepairs.forEach(repair => {
          if (repair[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao]) {
            statuses.add(repair[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao]);
          }
        });
        statuses.forEach(status => {
          const option = document.createElement('option');
          option.value = status;
          statusList.appendChild(option);
        });
        },

        // 3. 14 H√†m c·∫≠p nh·∫≠t s·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi b√°o s·ª≠a khi ng∆∞·ªùi b√°o s·ª≠a thay ƒë·ªïi
        updateRequesterPhone() {
          const Name_requester = document.getElementById('requesterName').value;
          const unitId = userData.id; // Gi·∫£ s·ª≠ userData.id l√† ID ƒë∆°n v·ªã c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i
          console.log('Name_requester:', Name_requester);
          if (!Name_requester) {
            console.log('No requester selected');
            document.getElementById('requesterPhone').value = '';
            return;
          }

          // T√¨m ng∆∞·ªùi y√™u c·∫ßu trong appData.val_DataSC theo c·∫£ t√™n v√† ID ƒë∆°n v·ªã
          console.log('Finding requester with name:', Name_requester, 'and unit ID:', unitId);
          const Sdt_requester = appData.val_DataSC.find(item => 
            item[CONFIG_COLUMNS.DataSC.hoten] === Name_requester && 
            item[CONFIG_COLUMNS.DataSC.iduserdv] === unitId
          );
          console.log('Found requester:', Sdt_requester);

          if (Sdt_requester) {
            const phoneList = document.getElementById('phoneList');
            phoneList.innerHTML = ''; // Clear existing options
            if (Sdt_requester[CONFIG_COLUMNS.DataSC.sdt]) {
              const option = document.createElement('option');
              option.value = Sdt_requester[CONFIG_COLUMNS.DataSC.sdt];
              phoneList.appendChild(option);
              console.log('Added phone option:', option.value);
            }
          } else {
            console.log('No requester found, clearing phone field');
            document.getElementById('requesterPhone').value = '';
          }
        },

        // 3.14. H√†m c·∫≠p nh·∫≠t s·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi s·ª≠a ch·ªØa khi ng∆∞·ªùi s·ª≠a ch·ªØa thay ƒë·ªïi
        updateRepairPersonPhone() {
          const repairPersonId = document.getElementById('repairPerson').value;
          if (!repairPersonId) {
            document.getElementById('repairPersonPhone').value = '';
            return;
          }
          
          const repairPerson = appData.val_DSUserSua.find(person => 
            person[CONFIG_COLUMNS.DSUserSua.id] === repairPersonId
          );
          if (repairPerson) {
            document.getElementById('repairPersonPhone').value = repairPerson[CONFIG_COLUMNS.DSUserSua.sdt] || '';
          }
        },

        // 3.14. C·∫≠p nh·∫≠t danh s√°ch thi·∫øt b·ªã khi nh√≥m thi·∫øt b·ªã thay ƒë·ªïi
        updateEquipmentList() {
          const selectedGroup = document.getElementById('equipmentGroup').value;
          const equipmentSelect = document.getElementById('equipmentId');
          
          equipmentSelect.innerHTML = '<option value="">-- Ch·ªçn thi·∫øt b·ªã --</option>';
          
          if (!selectedGroup) return;
          
          const departmentEquipment = appData.val_DSThietBi.filter(item => 
            item[CONFIG_COLUMNS.DSThietBi.nhomtb] === selectedGroup && 
            item[CONFIG_COLUMNS.DSThietBi.donvi] == userData.id
          );
          
          departmentEquipment.forEach(item => {
            const option = document.createElement('option');
            option.value = item[CONFIG_COLUMNS.DSThietBi.id];
            option.textContent = item[CONFIG_COLUMNS.DSThietBi.mathietbi] + ' - ' + item[CONFIG_COLUMNS.DSThietBi.tentb];
            equipmentSelect.appendChild(option);
          });
          
          this.clearEquipmentDetails();
        },

        // 3.15. X√≥a gi√° tr·ªã c√°c tr∆∞·ªùng thi·∫øt b·ªã
        clearEquipmentDetails() {
          try {
            document.getElementById('equipmentName').value = '';
            document.getElementById('equipmentModel').value = '';
            document.getElementById('equipmentSerial').value = '';
            document.getElementById('equipmentManufacturer').value = '';
            document.getElementById('equipmentYear').value = '';
            document.getElementById('equipmentUseYear').value = '';
            document.getElementById('equipmentWarranty').value = '';
            document.getElementById('equipmentLocation').value = '';
          } catch (error) {
            console.error('Error in clearEquipmentDetails:', error);
          }
        },

        // 3.16. C·∫≠p nh·∫≠t gi√° tr·ªã c√°c tr∆∞·ªùng thi·∫øt b·ªã khi thi·∫øt b·ªã thay ƒë·ªïi
        updateEquipmentDetails() {
          try {
            const equipmentIdElement = document.getElementById('equipmentId');
            if (!equipmentIdElement) {
              console.error('Equipment ID element not found');
              return;
            }

            const equipmentId = equipmentIdElement.value;
            this.clearEquipmentDetails();
            
            if (!equipmentId) return;
            
            const equipment = appData.val_DSThietBi.find(item => 
              item[CONFIG_COLUMNS.DSThietBi.id] === equipmentId
            );
            
            if (equipment) {
              document.getElementById('equipmentName').value = equipment[CONFIG_COLUMNS.DSThietBi.tentb] || '';
              document.getElementById('equipmentModel').value = equipment[CONFIG_COLUMNS.DSThietBi.model] || '';
              document.getElementById('equipmentSerial').value = equipment[CONFIG_COLUMNS.DSThietBi.serial] || '';
              document.getElementById('equipmentManufacturer').value = equipment[CONFIG_COLUMNS.DSThietBi.hangsx] || '';
              document.getElementById('equipmentYear').value = equipment[CONFIG_COLUMNS.DSThietBi.namsx] || '';
              document.getElementById('equipmentUseYear').value = equipment[CONFIG_COLUMNS.DSThietBi.namsd] || '';
              document.getElementById('equipmentWarranty').value = equipment[CONFIG_COLUMNS.DSThietBi.hanbaohanh] || '';
              document.getElementById('equipmentLocation').value = equipment[CONFIG_COLUMNS.DSThietBi.vitridat] || '';
            }
          } catch (error) {
            console.error('Error in updateEquipmentDetails:', error);
          }
        },

        // 3.17. Thu th·∫≠p d·ªØ li·ªáu t·ª´ form
        collectFormData() {
          return {
            id_repair: document.getElementById('repairId').value,
            Name_NguoiYeuCau: document.getElementById('requesterName').value,
            SDT_NguoiYeuCau: document.getElementById('requesterPhone').value,
            ID_NguoiSua: document.getElementById('repairPerson').value,
            ID_ThietBi: document.getElementById('equipmentId').value,
            TinhTrang_ThietBi: document.getElementById('equipmentStatus').value,
            ID_MucDo_YeuCau: document.getElementById('priorityLevel').value,
            GhiChu_repair: document.getElementById('notes').value,
            trangThai_repair: CONFIG_ENUM.TRANGTHAI.BAO_HONG,
            timeupdate: new Date().toLocaleString('vi-VN', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: false
            })
          };
        },

        // 3.18. Chu·∫©n b·ªã d·ªØ li·ªáu cho m·∫£ng Main_SC
        arr_MainSC_prepare(repairDataForm) {
          const currentDateTime = repairDataForm.timeupdate;
          const newRow = Array(appData.val_DataSC[0].length).fill("");

          newRow[CONFIG_COLUMNS.DataSC.id] = repairDataForm.id_repair;
          newRow[CONFIG_COLUMNS.DataSC.trangthai] = repairDataForm.trangThai_repair;
          newRow[CONFIG_COLUMNS.DataSC.mucdo] = repairDataForm.ID_MucDo_YeuCau;
          newRow[CONFIG_COLUMNS.DataSC.iduserdv] = userData.id;
          newRow[CONFIG_COLUMNS.DataSC.idusersua] = repairDataForm.ID_NguoiSua;
          newRow[CONFIG_COLUMNS.DataSC.idthietbi] = repairDataForm.ID_ThietBi;
          newRow[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao] = repairDataForm.TinhTrang_ThietBi;
          newRow[CONFIG_COLUMNS.DataSC.ngaydonvibao] = currentDateTime;
          newRow[CONFIG_COLUMNS.DataSC.ghichu] = repairDataForm.GhiChu_repair;
          newRow[CONFIG_COLUMNS.DataSC.hoten] = repairDataForm.Name_NguoiYeuCau;
          newRow[CONFIG_COLUMNS.DataSC.sdt] = repairDataForm.SDT_NguoiYeuCau;

          let historyEntry = `* Ng√†y ${currentDateTime}   - ${repairDataForm.Name_NguoiYeuCau}: B√°o h·ªèng`;
          if (repairDataForm.GhiChu_repair?.trim()) {
            historyEntry += `\n   - Ghi ch√∫: ${repairDataForm.GhiChu_repair}`;
          }
          newRow[CONFIG_COLUMNS.DataSC.history] = historyEntry;
          newRow[CONFIG_COLUMNS.DataSC.timeupdate] = currentDateTime;

          return newRow;
        },

        // 3.19. Chu·∫©n b·ªã tin nh·∫Øn Telegram
        textTelegram_prepare(repairDataForm) {
          const thietbi = appData.val_DSThietBi.find(item => 
            item[CONFIG_COLUMNS.DSThietBi.id] === repairDataForm.ID_ThietBi
          );
          
          const mucdo = appData.val_EnumSetting.find(item => 
            item[0] === repairDataForm.ID_MucDo_YeuCau && item[1] === "M·ª©c ƒë·ªô YC"
          );
          
          const nguoisua = appData.val_DSUserSua.find(item =>
            item[CONFIG_COLUMNS.DSUserSua.id] === repairDataForm.ID_NguoiSua
          );

          const thietbiInfo = {
            ten: thietbi ? thietbi[CONFIG_COLUMNS.DSThietBi.tentb] : 'Kh√¥ng x√°c ƒë·ªãnh',
            model: thietbi ? thietbi[CONFIG_COLUMNS.DSThietBi.model] : 'Kh√¥ng x√°c ƒë·ªãnh',
            serial: thietbi ? thietbi[CONFIG_COLUMNS.DSThietBi.serial] : 'Kh√¥ng x√°c ƒë·ªãnh'
          };

          const mucdoText = mucdo ? mucdo[2] : 'Kh√¥ng x√°c ƒë·ªãnh';
          const nguoisuaText = nguoisua ? nguoisua[CONFIG_COLUMNS.DSUserSua.hoten] : '';

          return `üîî *B√ÅO H·ªéNG THI·∫æT B·ªä M·ªöI* üîî
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üÜî *ID:* ${repairDataForm.id_repair}
üè• *ƒê∆°n v·ªã b√°o h·ªèng:* ${userData.name}
üîß *Thi·∫øt b·ªã:* ${thietbiInfo.ten}
üìã *Model:* ${thietbiInfo.model}
üî¢ *Serial:* ${thietbiInfo.serial}
‚ö†Ô∏è *T√¨nh tr·∫°ng:* ${repairDataForm.TinhTrang_ThietBi}
‚è±Ô∏è *M·ª©c ƒë·ªô ∆∞u ti√™n:* ${mucdoText}
üë§ *Ng∆∞·ªùi y√™u c·∫ßu:* ${repairDataForm.Name_NguoiYeuCau} (${repairDataForm.SDT_NguoiYeuCau})
${nguoisuaText ? `üë®‚Äçüîß *Ng∆∞·ªùi ph·ª• tr√°ch:* ${nguoisuaText}` : ""}`;
        }
      };
    </script>
