<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phần mềm quản lý sửa chữa - Bệnh viện Đa khoa Bắc Giang</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    
    <!-- Google Platform -->
    <script src="https://apis.google.com/js/platform.js"></script>
    
    <style>
      body {
        background-color: #f8f9fa;
        font-family: Arial, sans-serif;
      }

      .container {
        max-width: 100%;
        margin-top: 20px;
      }
      
      /* Loading screen */
      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: #f4f4f4;
        z-index: 9999;
        transition: opacity 0.5s ease, visibility 0.5s ease;
      }

      .loading-screen.hidden {
        opacity: 0;
        visibility: hidden;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #ddd;
        border-top-color: #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .loading-message {
        margin-top: 20px;
        font-size: 16px;
        color: #333;
        text-align: center;
      }
      
      /* Login form */
      #loginSection {
        width: 500px;
        margin: 100px auto;
        padding: 20px;
        display: none;
      }
      
      .card {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border: none;
        padding: 10px;
      }

      .card-header {
        background-color: #007bff;
        color: #fff;
        font-size: 1rem;
        font-weight: bold;
        text-align: center;
        padding: 5px;
      }

      .password-field {
        position: relative;
      }

      .toggle-password {
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        cursor: pointer;
      }
      
      /* Main sections */
      .section {
        display: none;
        padding: 5px;
      }

      .dashboard {
        margin-left: 10px;
        margin-right: 10px;
        display: none;
      }

      .nav-pills .nav-link.active {
        background-color: #007bff;
        color: #fff;
      }

      .tab-content .tab-pane {
        padding: 15px;
        padding-left: 10px;
        padding-right: 10px;
        border-top: none;
        background-color: #ffffff;
      }
      
      /* Tables */
      .custom-table {
        border-collapse: collapse;
        width: 100%;
        border: 1px solid #ddd;
        font-size: 18px;
      }

      .custom-table th,
      .custom-table td {
        text-align: left;
        padding: 12px;
      }

      .custom-table tr {
        border-bottom: 1px solid #ddd;
      }

      .custom-table tr.tb_header,
      .custom-table tr:hover {
        background-color: #f1f1f1;
      }
      
      /* Action buttons */
      .action-buttons button {
        padding: 5px 10px;
        margin: 2px;
        cursor: pointer;
      }

      .edit-button {
        background-color: #4CAF50;
        color: white;
        border: none;
      }

      .delete-button {
        background-color: #f44336;
        color: white;
        border: none;
      }
      
      /* Modal */
      .modal {
        z-index: 1050;
      }

      .modal-backdrop {
        z-index: 1040;
      }

      .modal-dialog {
        z-index: 1050;
        margin: 1.75rem auto;
      }

      .modal-content {
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        z-index: 1050;
      }
      
      .modal-header {
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
      }
      
      /* Password field styling */
      .input-group .btn-outline-secondary {
        border-color: #ced4da;
      }
      
      .input-group .btn-outline-secondary:hover {
        background-color: #f8f9fa;
      }
      
      /* Header styles */
      .app-header {
        background-color: #fff;
        border-bottom: 1px solid #ddd;
        padding: 10px 0;
        margin-bottom: 20px;
      }

      .app-logo {
        height: 50px;
        margin-right: 15px;
        flex-shrink: 0;
      }
      
      .app-title {
        color: #007bff;
        font-size: 1.5rem;
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }
      
      @media (max-width: 992px) {
        .app-title {
          font-size: 1.25rem;
        }
      }
      
      @media (max-width: 768px) {
        .app-title {
          font-size: 1rem;
        }
      }
      
      .user-profile {
        display: flex;
        align-items: center;
        cursor: pointer;
      }
      
      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
      }
      
      .dropdown-menu {
        min-width: 200px;
      }
    </style>
  </head>
  <body>
    <!-- Loading screen -->
    <div id="loading" class="loading-screen">
      <div class="spinner"></div>
      <div class="loading-message">Đang tải dữ liệu, vui lòng đợi...</div>
    </div>
    
    <!-- Login section -->
    <div id="loginSection" class="container">
      <div class="card">
        <div class="card-header">
          ĐĂNG NHẬP<br>PHẦN MỀM QUẢN LÝ SỬA CHỮA
        </div>
        <div class="card-body">
          <form id="loginForm">
            <div class="mb-3">
              <label for="username" class="form-label">Tên đăng nhập</label>
              <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-3 password-field">
              <label for="password" class="form-label">Mật khẩu</label>
              <input type="password" class="form-control" id="password" required>
              <i class="toggle-password fas fa-eye-slash" onclick="togglePassword()"></i>
            </div>
            <button type="button" class="btn btn-primary w-100" onclick="login()">Đăng nhập</button>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Main application -->
    <div id="mainApp" class="section">
      <!-- Header -->
      <div class="app-header">
        <div class="container">
          <div class="row align-items-center">
            <div class="col-md-8 d-flex align-items-center">
              <img src="https://drive.google.com/thumbnail?id=16gCExt-p9JflHcqZQ2nxWLDL65bpD-Tf&sz=s100" alt="Logo" class="app-logo">
              <span class="app-title">Phần mềm quản lý sửa chữa - Bệnh viện Đa khoa Bắc Giang</span>
            </div>
            <div class="col-md-2 d-none d-md-block">
            </div>
            <div class="col-md-2 text-end">
              <div class="dropdown">
                <div class="user-profile dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                  <img id="userAvatar" src="https://drive.google.com/thumbnail?id=1Y2obUC2vpgQLsD1JokCX8QY4olp3LjXe&sz=s100" alt="User Avatar" class="user-avatar">
                  <span id="userName">User Name</span>
                  <i class="fas fa-chevron-down ms-2"></i>
                </div>
                <ul class="dropdown-menu" aria-labelledby="userDropdown">
                  <li><a class="dropdown-item" href="#" onclick="refreshData()"><i class="fas fa-sync-alt me-2"></i>Cập nhật dữ liệu</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editProfileModal"><i class="fas fa-user-edit me-2"></i>Chỉnh sửa thông tin</a></li>
                  <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal"><i class="fas fa-key me-2"></i>Đổi mật khẩu</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Main content -->
      <div class="container dashboard">
        <div class="row mb-3">
          <div class="col-md-3">
            <button class="btn btn-success w-100" onclick="showAddRepairModal()" data-bs-toggle="modal" data-bs-target="#FormRepairModal">
              <i class="fas fa-plus me-2"></i>Thêm báo hỏng
            </button>
          </div>
          <div class="col-md-2 d-none d-md-block">
          </div>
          <div class="col-md-7">
            <div class="input-group">
              <input type="text" class="form-control" id="searchInput" placeholder="Nhập nội dung tìm kiếm...">
              <button class="btn btn-primary" type="button" onclick="searchRepair()">
                <i class="fas fa-search me-2"></i>Tìm kiếm
              </button>
              <button class="btn btn-secondary" type="button" onclick="cancelSearch()">
                <i class="fas fa-times me-2"></i>Hủy tìm kiếm
              </button>
            </div>
          </div>
        </div>
        
        <!-- Tabs -->
        <ul class="nav nav-pills mb-3" id="repairTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-baohong" data-bs-toggle="pill" data-bs-target="#baohong" type="button" role="tab">
              Báo hỏng (0)
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-dangsua" data-bs-toggle="pill" data-bs-target="#dangsua" type="button" role="tab">
              Đang sửa (0)
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-baohanh" data-bs-toggle="pill" data-bs-target="#baohanh" type="button" role="tab">
              Bảo hành (0)
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-suangoai" data-bs-toggle="pill" data-bs-target="#suangoai" type="button" role="tab">
              Sửa ngoài (0)
            </button>
          </li>
        </ul>
        
        <!-- Tab content -->
        <div class="tab-content" id="repairTabsContent">
          <!-- Báo hỏng tab -->
          <div class="tab-pane fade show active" id="baohong" role="tabpanel">
            <table class="custom-table">
              <thead>
                <tr class="tb_header">
                  <th style="width: 5%;">STT</th>
                  <th style="width: 75%;">Nội dung</th>
                  <th style="width: 20%;">Hành động</th>
                </tr>
              </thead>
              <tbody id="history_baohong">
                <!-- Data will be populated dynamically -->
              </tbody>
            </table>
          </div>
          
          <!-- Đang sửa tab -->
          <div class="tab-pane fade" id="dangsua" role="tabpanel">
            <table class="custom-table">
              <thead>
                <tr class="tb_header">
                  <th style="width: 5%;">STT</th>
                  <th style="width: 75%;">Nội dung</th>
                  <th style="width: 20%;">Hành động</th>
                </tr>
              </thead>
              <tbody id="history_dangsua">
                <!-- Data will be populated dynamically -->
              </tbody>
            </table>
          </div>
          
          <!-- Bảo hành tab -->
          <div class="tab-pane fade" id="baohanh" role="tabpanel">
            <table class="custom-table">
              <thead>
                <tr class="tb_header">
                  <th style="width: 5%;">STT</th>
                  <th style="width: 75%;">Nội dung</th>
                  <th style="width: 20%;">Hành động</th>
                </tr>
              </thead>
              <tbody id="history_baohanh">
                <!-- Data will be populated dynamically -->
              </tbody>
            </table>
          </div>
          
          <!-- Sửa ngoài tab -->
          <div class="tab-pane fade" id="suangoai" role="tabpanel">
            <table class="custom-table">
              <thead>
                <tr class="tb_header">
                  <th style="width: 5%;">STT</th>
                  <th style="width: 75%;">Nội dung</th>
                  <th style="width: 20%;">Hành động</th>
                </tr>
              </thead>
              <tbody id="history_suangoai">
                <!-- Data will be populated dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Repair Modal -->
    <div class="modal fade" id="FormRepairModal" tabindex="-1" aria-labelledby="FormRepairModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Thêm báo hỏng mới</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="addRepairForm">
              <input type="hidden" id="repairId">
              
              <!-- Nhóm Đơn vị yêu cầu -->
              <div class="card mb-3">
                <div class="card-header bg-info text-white">
                  <h6 class="mb-0">Thông tin đơn vị yêu cầu</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-12">
                      <div class="mb-3">
                        <div class="d-flex align-items-center mb-2">
                          <label for="departmentName" class="me-2 mb-0">Đơn vị yêu cầu:</label>
                          <div class="input-group" style="max-width: 300px;">
                            <span class="input-group-text"><i class="fas fa-hospital"></i></span>
                            <input type="text" class="form-control" id="departmentName" readonly>
                          </div>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="requesterName" class="form-label">Người yêu cầu</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-user"></i></span>
                          <input type="text" class="form-control" id="requesterName" list="requesterList">
                          <datalist id="requesterList"></datalist>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="requesterPhone" class="form-label">Số điện thoại yêu cầu</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-phone"></i></span>
                          <input type="text" class="form-control" id="requesterPhone" list="phoneList">
                          <datalist id="phoneList"></datalist>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Nhóm Người sửa chữa -->
              <div class="card mb-3">
                <div class="card-header bg-info text-white">
                  <h6 class="mb-0">Thông tin người sửa chữa</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="repairPerson" class="form-label">Người sửa chữa</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-user-cog"></i></span>
                          <select class="form-select" id="repairPerson"></select>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="repairPersonPhone" class="form-label">Số điện thoại người sửa chữa</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-phone-alt"></i></span>
                          <input type="text" class="form-control" id="repairPersonPhone" readonly>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Nhóm Thiết bị -->
              <div class="card mb-3">
                <div class="card-header bg-info text-white">
                  <h6 class="mb-0">Thông tin thiết bị</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="equipmentGroup" class="form-label">Nhóm thiết bị</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-layer-group"></i></span>
                          <select class="form-select" id="equipmentGroup"></select>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="equipmentId" class="form-label">Mã thiết bị</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                          <select class="form-select" id="equipmentId"></select>
                        </div>
                      </div>
                    </div>
                  </div>
                  <!-- Các trường thông tin thiết bị khác -->
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="equipmentName" class="form-label">Tên thiết bị</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-tag"></i></span>
                          <input type="text" class="form-control" id="equipmentName" readonly>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="equipmentModel" class="form-label">Model</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-info-circle"></i></span>
                          <input type="text" class="form-control" id="equipmentModel" readonly>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="equipmentSerial" class="form-label">Serial</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-qrcode"></i></span>
                          <input type="text" class="form-control" id="equipmentSerial" readonly>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="equipmentManufacturer" class="form-label">Hãng sản xuất</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-industry"></i></span>
                          <input type="text" class="form-control" id="equipmentManufacturer" readonly>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="equipmentYear" class="form-label">Năm sản xuất</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                          <input type="text" class="form-control" id="equipmentYear" readonly>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="equipmentUseYear" class="form-label">Năm đưa vào sử dụng</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-calendar-check"></i></span>
                          <input type="text" class="form-control" id="equipmentUseYear" readonly>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="equipmentWarranty" class="form-label">Hạn bảo hành</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-shield-alt"></i></span>
                          <input type="text" class="form-control" id="equipmentWarranty" readonly>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="equipmentLocation" class="form-label">Vị trí đặt</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                          <input type="text" class="form-control" id="equipmentLocation" readonly>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Nhóm Tình trạng -->
              <div class="card mb-3">
                <div class="card-header bg-info text-white">
                  <h6 class="mb-0">Thông tin tình trạng thiết bị</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="equipmentStatus" class="form-label">Tình trạng thiết bị</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-exclamation-triangle"></i></span>
                          <input type="text" class="form-control" id="equipmentStatus" list="statusList">
                          <datalist id="statusList"></datalist>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="priorityLevel" class="form-label">Mức độ yêu cầu</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-flag"></i></span>
                          <select class="form-select" id="priorityLevel"></select>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12">
                      <div class="mb-3">
                        <label for="notes" class="form-label">Ghi chú</label>
                        <div class="input-group">
                          <span class="input-group-text"><i class="fas fa-sticky-note"></i></span>
                          <textarea class="form-control" id="notes" rows="3"></textarea>
                        </div>
                      </div>
                    </div>
                  </div>
                <div class="row" id="historySection" style="display: none;">
                  <div class="col-md-12">
                    <div class="mb-3">
                      <label for="history" class="form-label">Lịch sử</label>
                      <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-history"></i></span>
                        <textarea class="form-control" id="history" rows="3"></textarea>
                      </div>
                    </div>
                  </div>
                </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button type="button" class="btn btn-primary" onclick="saveRepair()">Lưu</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit User Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Chỉnh sửa thông tin cá nhân</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="profileName" class="form-label">Tên đơn vị</label>
              <input type="text" class="form-control" id="profileName">
            </div>
            <div class="mb-3">
              <label for="profileEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="profileEmail">
            </div>
            <div class="mb-3">
              <label for="profileLogo" class="form-label">URL Logo (tùy chọn)</label>
              <input type="text" class="form-control" id="profileLogo">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button type="button" class="btn btn-primary" onclick="saveProfile()">Lưu thay đổi</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Đổi mật khẩu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3 position-relative">
              <label for="currentPassword" class="form-label">Mật khẩu hiện tại</label>
              <div class="input-group">
                <input type="password" class="form-control" id="currentPassword">
                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordField('currentPassword')">
                  <i class="fas fa-eye-slash"></i>
                </button>
              </div>
            </div>
            <div class="mb-3 position-relative">
              <label for="newPassword" class="form-label">Mật khẩu mới</label>
              <div class="input-group">
                <input type="password" class="form-control" id="newPassword">
                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordField('newPassword')">
                  <i class="fas fa-eye-slash"></i>
                </button>
              </div>
            </div>
            <div class="mb-3 position-relative">
              <label for="confirmPassword" class="form-label">Xác nhận mật khẩu mới</label>
              <div class="input-group">
                <input type="password" class="form-control" id="confirmPassword">
                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordField('confirmPassword')">
                  <i class="fas fa-eye-slash"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            <button type="button" class="btn btn-primary" onclick="saveNewPassword()">Xác nhận</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let formRepairModalInstance = null;
      // Global data variables
      let userData = {};
      let appData = {};
      let data_Repair_DV = {};
      let CONFIG_COLUMNS = {};
      let CONFIG_ENUM = {};
      let val_Repair = {
        MaxId_Count: 0,
        MaxRow_Id: 0,
        CurrentRow_Id: 0
      };
      
      ///////////////////////////////////
      // 1. Nhóm hàm xử lý dữ liệu ban đầu
      ///////////////////////////////////
      // 1.1. Bắt sự kiện để tải dữ liệu
      document.addEventListener('DOMContentLoaded', function() {
        // Load data
        loadAllData();
      });

      // 1.2. Hàm tải dữ liệu
      function loadAllData() {
        console.log('Starting to load data...');
        
        google.script.run
          .withSuccessHandler(handleDataLoaded)
          .withFailureHandler(handleScriptError)
          .getdata();
      }

      // 1.3. Hàm xử lý dữ liệu đã tải
      function handleDataLoaded(dataJSON) {
        try {
          // Lưu dữ liệu vào biến toàn cục
          appData = JSON.parse(dataJSON);
          CONFIG_COLUMNS = appData.CONFIG_COLUMNS;
          CONFIG_ENUM = appData.CONFIG_ENUM;

          // Khởi tạo các thành phần giao diện
          initializeUI();
          
          // Khởi tạo RepairModalManager
          RepairModalManager.initialize();
          
          // Ẩn màn hình đang tải
          document.getElementById('loading').classList.add('hidden');
          
          // Hiển thị form đăng nhập
          document.getElementById('loginSection').style.display = 'block';
        } catch (error) {      
          showError("Lỗi khi xử lý dữ liệu: " + error.message);
        }
      }

      // 1.4. Hàm khởi tạo giao diện
      function initializeUI() {
        // Khởi tạo các modal
        const modalElements = document.querySelectorAll('.modal');
        modalElements.forEach(element => {
          new bootstrap.Modal(element);
        });

        // Khởi tạo tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Khởi tạo popovers
        const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        popoverTriggerList.map(function (popoverTriggerEl) {
          return new bootstrap.Popover(popoverTriggerEl);
        });

        // Khởi tạo bắt các sự kiện cho các trường dữ liệu
        setupFormEventListeners();
      }

      // 1.6. Khởi tạo bắt các sự kiện cho các trường dữ liệu
      function setupFormEventListeners() {
        // Nhóm thiết bị thay đổi
        document.getElementById('equipmentGroup').addEventListener('change', function() {
          RepairModalManager.updateEquipmentList();
        });

        // Mã thiết bị thay đổi
        document.getElementById('equipmentId').addEventListener('change', function() {
          RepairModalManager.updateEquipmentDetails();
        });

        // Người sửa chữa thay đổi
        document.getElementById('repairPerson').addEventListener('change', function() {
          RepairModalManager.updateRepairPersonPhone();
        });

        // Người yêu cầu thay đổi
        document.getElementById('requesterName').addEventListener('change', function() {
          RepairModalManager.updateRequesterPhone();
        });

        // Lắng nghe sự kiện cho tất cả các modal
        document.querySelectorAll('.modal').forEach(modal => {
          modal.addEventListener('shown.bs.modal', () => {
            setupModalFocus(modal); // Gọi hàm setupModalFocus mỗi khi modal được hiển thị
          });
        });
      }
      
      // 1.5. Khởi tạo xử lý focus cho modal
      function setupModalFocus(modal) {
        // Focus first input
        const firstInput = modal.querySelector('input:not([readonly]):not([disabled])');
        if (firstInput) {
          firstInput.focus();
        }
      }
      ///////////////////////////////////
      // 2. Nhóm hàm thông báo
      ///////////////////////////////////

      // 2.1 Hàm thông báo lỗi
      function showError(message) {
        Swal.fire({
          icon: 'error',
          title: 'Lỗi',
          text: message,
          confirmButtonText: 'Đóng'
        });
      }

      // 2.2 Hàm thông báo thành công
      function showSuccess(message) {
        Swal.fire({
          icon: 'success',
          title: 'Thành công',
          html: message.replace(/\n/g, '<br>'),
          confirmButtonText: 'Đóng'
        });
      }

      // 2.3 Hàm thông báo xác nhận
      function showConfirm(title, message, callback) {
        // Use SweetAlert for confirmation dialogs as it's already loaded
        Swal.fire({
          icon: 'question',
          title: title,
          text: message,
          showCancelButton: true,
          confirmButtonText: 'Đồng ý',
          cancelButtonText: 'Hủy',
          backdrop: true,
          allowOutsideClick: true
        }).then((result) => {
          if (result.isConfirmed) {
            callback();
          }
        });
      }

      // 2.4 Hàm thông báo đang tải
      function showLoading() {
        Swal.fire({
          title: 'Đang xử lý',
          text: 'Vui lòng đợi...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
      }

      // 2.5 Hàm xử lý lỗi script
      function handleScriptError(error) {
        Swal.close();
        showError("Lỗi: " + error.message);
      }
      
      ///////////////////////////////////
      // 3. Nhóm hàm xử lý đăng nhập
      ///////////////////////////////////

      // 3.1 Hàm xác thực đăng nhập
      function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
          showError("Vui lòng nhập đầy đủ tên đăng nhập và mật khẩu");
          return;
        }
        
        // Verify credentials
        const departmentUsers = appData.val_DSUserDV;
        
        // Skip header row
        for (let i = 1; i < departmentUsers.length; i++) {
          const user = departmentUsers[i];
          const userUsername = user[CONFIG_COLUMNS.DSUserDV.username];
          const userPassword = user[CONFIG_COLUMNS.DSUserDV.pass];
          
          if (username === userUsername && password === userPassword) {
            // Store user data
            userData = {
              id: user[CONFIG_COLUMNS.DSUserDV.id],
              name: user[CONFIG_COLUMNS.DSUserDV.donvi],
              username: user[CONFIG_COLUMNS.DSUserDV.username],
              pass: user[CONFIG_COLUMNS.DSUserDV.pass],
              kihieu: user[CONFIG_COLUMNS.DSUserDV.kihieu],
              email: user[CONFIG_COLUMNS.DSUserDV.email],
              logo: user[CONFIG_COLUMNS.DSUserDV.logo]
            };
            
            // Hide login form
            document.getElementById('loginSection').style.display = 'none';
            
            // Show main app
            document.getElementById('mainApp').style.display = 'block';
            document.querySelector('.dashboard').style.display = 'block';
            
            // Setup user interface
            setupUserInterface();
            
            // Load repair data
            updateRepairTables();
            
            return;
          }
        }
        
        // Invalid credentials
        showError("Tên đăng nhập hoặc mật khẩu không đúng");
      }

      // 3.2 Hàm Hiển thị/ẩn mật khẩu
      function togglePassword() {
        const passwordInput = document.getElementById('password');
        const toggleIcon = document.querySelector('.toggle-password');
        
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          toggleIcon.classList.remove('fa-eye-slash');
          toggleIcon.classList.add('fa-eye');
        } else {
          passwordInput.type = 'password';
          toggleIcon.classList.remove('fa-eye');
          toggleIcon.classList.add('fa-eye-slash');
        }
      }
      
      ///////////////////////////////////
      // 4. Nhóm hàm xử lý giao diện người dùng
      ///////////////////////////////////
      // 4.2 Hàm thiết lập giao diện sau khi đăng nhập
      function setupUserInterface() {
        // Set user name and avatar
        document.getElementById('userName').textContent = userData.name;
        
        // Set avatar image if available
        if (userData.logo) {
          const logoLink = "https://drive.google.com/thumbnail?id=" + userData.logo + "&sz=s100";
          document.getElementById('userAvatar').src = logoLink;
        }
        // Set department name in repair form
        document.getElementById('departmentName').value = userData.name;
        
        RepairModalManager.ListDropDowns();
        RepairModalManager.ListDropDowns_Requester();
        
        // Reinitialize UI components to ensure modals and other Bootstrap components work properly
        initializeUI();
      }
      
      // 4.2 Hàm Hiển thị/ẩn menu người dùng
      function toggleUserMenu() {
        const userMenu = document.getElementById('userMenu');
        if (userMenu.style.display === 'none') {
          userMenu.style.display = 'block';
        } else {
          userMenu.style.display = 'none';
        }
      }
      
      
      ///////////////////////////////////
      // 5. NHÓM HÀM XỬ LÝ MENU DROPDOWN NGƯỜI DÙNG
      ///////////////////////////////////

      ///////////////////////////////////
      // 5.1. Nhóm hàm xử lý hồ sơ cá nhân
      ///////////////////////////////////
      // 5.1.0. Hàm tải lại dữ liệu
      function refreshData() {
        // Show loading message
        showLoading();
        
        // Reload DataSC table
        google.script.run
          .withSuccessHandler(function(data) {
            console.log('Data reloaded successfully:', data);
            Swal.close();
            // Update appData with new data
            appData.val_DataSC = data;
            console.log('appData updated with new DataSC');
            
            // Refresh dropdowns
            RepairModalManager.ListDropDowns();
            RepairModalManager.ListDropDowns_Requester();
            console.log('Dropdowns refreshed');
            
            // Refresh tables
            if (typeof refreshTables === 'function') {
              refreshTables();
              console.log('Tables refreshed');
            }
            
            // Show success message
            showSuccess('Dữ liệu đã được cập nhật');
            console.log('Data refresh completed successfully');
          })
          .withFailureHandler(function(error) {
            Swal.close();
            showError('Lỗi khi tải dữ liệu: ' + error.message);
          })
          .getDataSC();
      }
      // 5.1.1. Hàm sửa hồ sơ người dùng
      function editUserProfile() {
        // Hide user menu
        document.getElementById('userMenu').style.display = 'none';
        
        // Fill form with current user data
        document.getElementById('profileName').value = userData.name || '';
        document.getElementById('profileEmail').value = userData.email || '';
        document.getElementById('profileLogo').value = userData.logo || '';
        
        // Show modal using Bootstrap 5 syntax
        const modalElement = document.getElementById('editProfileModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
      
      // 5.1.2. Hàm lưu thông tin hồ sơ người dùng
      function saveProfile() {
        // Get form values
        const name = document.getElementById('profileName').value;
        const email = document.getElementById('profileEmail').value;
        const logo = document.getElementById('profileLogo').value;
        
        // Validate form
        if (!name) {
          showError("Vui lòng nhập tên đơn vị");
          return;
        }
        
        if (!email) {
          showError("Vui lòng nhập email");
          return;
        }
        
        // Prepare data for update
        const profileData = {
          id: userData.id,
          donvi: name,
          email: email,
          logo: logo
        };
        
        // Show loading message
        showLoading();
        
        // Send update to server
        google.script.run
          .withSuccessHandler(handleProfileUpdated)
          .withFailureHandler(handleScriptError)
          .updateUserProfile(profileData);
      }
      
      // 5.1.3. Hàm xử lý cập nhật thông tin hồ sơ người dùng thành công
      function handleProfileUpdated(result) {
        Swal.close();
        
        if (result) {
          // Update user data
          for (let i = 1; i < appData.val_DSUserDV.length; i++) {
            if (appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.id] == userData.id) {
              appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.donvi] = document.getElementById('profileName').value;
              appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.email] = document.getElementById('profileEmail').value;
              appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.logo] = document.getElementById('profileLogo').value;
              break;
            }
          }
          
          // Update userData
          userData.name = document.getElementById('profileName').value;
          userData.email = document.getElementById('profileEmail').value;
          userData.logo = document.getElementById('profileLogo').value;
          
          // Update UI
          document.getElementById('userName').textContent = userData.name;
          if (userData.logo) {
            //document.getElementById('userAvatar').src = `https://drive.google.com/thumbnail?id=${userData.logo}&sz=s100`;
          }
          
          // Close modal
          bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
          
          // Show success message
          showSuccess("Cập nhật thông tin thành công");
        } else {
          showError("Có lỗi xảy ra khi cập nhật thông tin");
        }
      }
      
      ///////////////////////////////////
      // 5.2. Nhóm hàm xử lý mật khẩu
      ///////////////////////////////////

      // 5.2.1. Hàm thay đổi mật khẩu
      function changePassword() {
        // Hide user menu
        document.getElementById('userMenu').style.display = 'none';
        
        // Clear form
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        
        // Show modal using Bootstrap 5 syntax
        const modalElement = document.getElementById('changePasswordModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
      
      // 5.2.2. Hàm hiển thị mật khẩu
      function togglePasswordField(fieldId) {
        const passwordInput = document.getElementById(fieldId);
        const toggleButton = passwordInput.nextElementSibling;
        const toggleIcon = toggleButton.querySelector('i');
        
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          toggleIcon.classList.remove('fa-eye-slash');
          toggleIcon.classList.add('fa-eye');
        } else {
          passwordInput.type = 'password';
          toggleIcon.classList.remove('fa-eye');
          toggleIcon.classList.add('fa-eye-slash');
        }
      }
      
      // 5.2.3. Hàm lưu mật khẩu mới
      function saveNewPassword() {
        // Get form values
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // Validate form
        if (!currentPassword) {
          showError("Vui lòng nhập mật khẩu hiện tại");
          return;
        }
        
        if (!newPassword) {
          showError("Vui lòng nhập mật khẩu mới");
          return;
        }
        
        if (!confirmPassword) {
          showError("Vui lòng xác nhận mật khẩu mới");
          return;
        }
        
        if (newPassword !== confirmPassword) {
          showError("Mật khẩu mới và xác nhận mật khẩu không khớp");
          return;
        }
        
        // Verify current password (find user in departmentUsers by userData.id)
        let currentUserPassword = '';
        for (let i = 1; i < appData.val_DSUserDV.length; i++) {
          if (appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.id] == userData.id) {
            currentUserPassword = appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.pass];
            break;
          }
        }
        
        if (currentPassword !== currentUserPassword) {
          showError("Mật khẩu hiện tại không đúng");
          return;
        }
        
        // Prepare data for update
        const passwordData = {
          id: userData.id,
          newPassword: newPassword
        };
        
        showLoading();
        
        // Send update to server
        google.script.run
          .withSuccessHandler(handlePasswordUpdated)
          .withFailureHandler(handleScriptError)
          .updateUserPassword(passwordData);
      }
      
      // 5.2.4. Hàm xử lý cập nhật mật khẩu thành công
      function handlePasswordUpdated(result) {
        Swal.close();
        
        if (result) {
          // Update password in the cached data
          for (let i = 1; i < appData.val_DSUserDV.length; i++) {
            if (appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.id] == userData.id) {
              appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.pass] = document.getElementById('newPassword').value;
              break;
            }
          }
          
          // Close modal
          bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
          
          // Show success message
          showSuccess("Đổi mật khẩu thành công");
        } else {
          showError("Có lỗi xảy ra khi đổi mật khẩu");
        }
      }
      
      ///////////////////////////////////
      // 5.3. Nhóm hàm đăng xuất
      ///////////////////////////////////
      // 5.3.1 Hàm Đăng xuất
      function logout() {
        showConfirm("Đăng xuất", "Bạn có chắc chắn muốn đăng xuất khỏi hệ thống?", function() {
          // Reset user data
          userData = {};
          
          // Hide main app
          document.getElementById('mainApp').style.display = 'none';
          document.querySelector('.dashboard').style.display = 'none';
          document.getElementById('userMenu').style.display = 'none';
          
          // Show login form
          document.getElementById('loginSection').style.display = 'block';
          
          // Clear login form
          document.getElementById('username').value = '';
          document.getElementById('password').value = '';
          
          // Show success message
          showSuccess("Đăng xuất thành công!");
        });
      }
      
      ///////////////////////////////////
      // 6. Nhóm hàm xử lý tìm kiếm
      ///////////////////////////////////
      
      // 6.2. Hàm tìm kiếm báo hỏng
      function searchRepair() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        if (!searchTerm) {
          showError("Vui lòng nhập nội dung tìm kiếm");
          return;
        }
        
        // Filter repair tables based on search term
        filterRepairTables(searchTerm);
      }
      
      // 6.3. Hàm lọc báo hỏng
      function filterRepairTables(searchTerm) {
        try {
          // Get all table rows in all tabs
          const allTables = ['history_baohong', 'history_dangsua', 'history_baohanh', 'history_suangoai'];
          const tabIds = ['tab-baohong', 'tab-dangsua', 'tab-baohanh', 'tab-suangoai'];
          const tabNames = ['Báo hỏng', 'Đang sửa', 'Bảo hành', 'Sửa ngoài'];
          
          let totalMatchCount = 0;
          let matchCountPerTab = [0, 0, 0, 0];
          
          // Search in each tab and count matches
          allTables.forEach((tableId, index) => {
            const tableBody = document.getElementById(tableId);
            const rows = tableBody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
              const content = rows[i].innerText.toLowerCase();
              if (content.includes(searchTerm)) {
                rows[i].style.display = '';
                totalMatchCount++;
                matchCountPerTab[index]++;
              } else {
                rows[i].style.display = 'none';
              }
            }
            
            // Update tab name with match count
            document.getElementById(tabIds[index]).textContent = `${tabNames[index]} (${matchCountPerTab[index]})`;
          });
          
          if (totalMatchCount === 0) {
            showError("Không tìm thấy kết quả phù hợp");
          } else {
            // Create a detailed message with counts per tab
            let detailMessage = `Tìm thấy ${totalMatchCount} kết quả phù hợp:\n`;
            allTables.forEach((tableId, index) => {
              if (matchCountPerTab[index] > 0) {
                detailMessage += `- ${tabNames[index]}: ${matchCountPerTab[index]} kết quả\n`;
              }
            });
            
            showSuccess(detailMessage);
          }
        } catch (error) {          
          showError('Lỗi khi lọc dữ liệu tìm kiếm: ' + error.message);
        }
      }
      
      // 6.4. Hàm hủy tìm kiếm báo hỏng
      function cancelSearch() {
        // Clear search input
        document.getElementById('searchInput').value = '';
        
        // Reset repair tables to show all items
        updateRepairTables();
      showSuccess("Đã hủy tìm kiếm và hiển thị lại tất cả dữ liệu");
      }

      ///////////////////////////////////
      // 7. Nhóm hàm xử lý hiển thị danh sách sửa chữa
      ///////////////////////////////////
      // 7.1. Hàm cập nhật tất cả các bảng báo hỏng
      function updateRepairTables() {
        const countBaoHong = updateTable('baohong', CONFIG_ENUM.TRANGTHAI.BAO_HONG);
        const countDangSua = updateTable('dangsua', CONFIG_ENUM.TRANGTHAI.DANG_SUA);
        const countBaoHanh = updateTable('baohanh', CONFIG_ENUM.TRANGTHAI.BAO_HANH);
        const countSuaNgoai = updateTable('suangoai', CONFIG_ENUM.TRANGTHAI.SUA_NGOAI);
        
        // Calculate total count
        const totalCount = countBaoHong + countDangSua + countBaoHanh + countSuaNgoai;
        
        // Log counts to console for debugging
        console.log(`Tổng số: ${totalCount} | Báo hỏng: ${countBaoHong} | Đang sửa: ${countDangSua} | Bảo hành: ${countBaoHanh} | Sửa ngoài: ${countSuaNgoai}`);
        
        return {
          total: totalCount,
          baoHong: countBaoHong,
          dangSua: countDangSua,
          baoHanh: countBaoHanh,
          suaNgoai: countSuaNgoai
        };
      }
      
      // 7.2. Hàm cập nhật bảng theo trạng thái
      function updateTable(tableType, status) {
        try {
          // Get table body
          const tableBody = document.getElementById(`history_${tableType}`);
          tableBody.innerHTML = '';
          
          // Counter for repair items
          let count = 0;
          
          // Process data
          appData.val_DataSC.slice(1).forEach(item => {
            // Check if this item matches the status and current user
            if (item[CONFIG_COLUMNS.DataSC.trangthai] == status && item[CONFIG_COLUMNS.DataSC.iduserdv] == userData.id) {
              count++;
              
              // Create row
              const row = document.createElement('tr');
              
              // STT cell
              const sttCell = document.createElement('td');
              sttCell.textContent = count;
              row.appendChild(sttCell);
              
              // Get equipment and repair person info
              const equipmentId = item[CONFIG_COLUMNS.DataSC.idthietbi];
              const equipment = appData.val_DSThietBi.find(eq => eq[CONFIG_COLUMNS.DSThietBi.id] === equipmentId);
              
              const repairPersonId = item[CONFIG_COLUMNS.DataSC.idusersua];
              const repairPerson = appData.val_DSUserSua.find(rp => rp[CONFIG_COLUMNS.DSUserSua.id] === repairPersonId);
              
              // Content cell
              const contentCell = document.createElement('td');
              contentCell.innerHTML = `
                🛠️ ${item[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao]} ⚠️ ${item[CONFIG_COLUMNS.DataSC.id]}
                <br>- Thông tin thiết bị: ♟️${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.tentb] : ''} 
                ⚙️${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.model] : ''} 
                ⚙️${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.serial] : ''} 
                ⚙️${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.nuocsx] : ''}
                <br>- Thông tin người sửa: 👨${repairPerson ? repairPerson[CONFIG_COLUMNS.DSUserSua.hoten] : ''} 
                📅${item[CONFIG_COLUMNS.DataSC.ngaydonvibao]}
              `;
              row.appendChild(contentCell);
              
              // Action cell
              const actionCell = document.createElement('td');
              actionCell.classList.add('action-buttons');
              
              // View button
              const viewBtn = document.createElement('button');
              viewBtn.classList.add('btn', 'btn-success', 'btn-sm', 'me-1');
              viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
              viewBtn.title = 'Xem chi tiết';
              viewBtn.onclick = () => showViewRepairModal(item[CONFIG_COLUMNS.DataSC.id]);
              actionCell.appendChild(viewBtn);

              // Add edit and delete buttons only for "báo hỏng" status
              if (status === CONFIG_ENUM.TRANGTHAI.BAO_HONG) {
              // Edit button
              const editBtn = document.createElement('button');
              editBtn.classList.add('btn', 'btn-primary', 'btn-sm', 'me-1');
              editBtn.innerHTML = '<i class="fas fa-edit"></i>';
              editBtn.title = 'Chỉnh sửa';
                editBtn.onclick = () => showEditRepairModal(item[CONFIG_COLUMNS.DataSC.id]);
              actionCell.appendChild(editBtn);
              
              // Delete button
              const deleteBtn = document.createElement('button');
              deleteBtn.classList.add('btn', 'btn-danger', 'btn-sm', 'me-1');
              deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
              deleteBtn.title = 'Xóa';
                deleteBtn.onclick = () => showDeleteRepairModal(item[CONFIG_COLUMNS.DataSC.id]);
              actionCell.appendChild(deleteBtn);
              }
              
              row.appendChild(actionCell);
              
              // Add row to table
              tableBody.appendChild(row);
            }
          });
          
          // Update tab count
          document.getElementById(`tab-${tableType}`).textContent = `${getTableTitle(tableType)} (${count})`;
          
          // Return the count for potential use elsewhere
          return count;
        } catch (error) {          
          showError(`Lỗi khi cập nhật bảng ${getTableTitle(tableType)}: ${error.message}`);
          return 0;
        }
      }
      
      // Helper function to get table title
      function getTableTitle(tableType) {
        const titles = {
          'baohong': 'Báo hỏng',
          'dangsua': 'Đang sửa',
          'baohanh': 'Bảo hành',
          'suangoai': 'Sửa ngoài'
        };
        return titles[tableType] || tableType;
      }

      ///////////////////////////////////
      // 8. NHÓM HÀM XỬ LÝ FORM DỮ LIỆU (THÊM, SỬA, XÓA)
      ///////////////////////////////////
      // 8.1. Hàm điền dữ liệu cho các dropdown list: Người sửa chữa, Nhóm thiết bị, Mức độ ưu tiên

      // Hàm cập nhật dữ liệu sau khi thêm/sửa/xóa
      function updateData(result) {
        try {
          // Cập nhật dữ liệu trong appData
          if (result) {
            // Tìm vị trí của bản ghi trong mảng
            const index = appData.val_DataSC.findIndex(item => 
              item[CONFIG_COLUMNS.DataSC.id] === result[CONFIG_COLUMNS.DataSC.id]
            );

            if (index !== -1) {
              // Nếu đã tồn tại, cập nhật
              appData.val_DataSC[index] = result;
            } else {
              // Nếu chưa tồn tại, thêm mới
              appData.val_DataSC.push(result);
            }
          }
        } catch (error) {
          console.error("Error in updateData:", error);
          throw error;
        }
      }

      // Hàm cập nhật giao diện sau khi thay đổi dữ liệu
      function updateUI() {
        try {
          // Cập nhật các bảng hiển thị
          updateRepairTables();
          
          // Cập nhật các dropdown list
          RepairModalManager.ListDropDowns();
        } catch (error) {
          console.error("Error in updateUI:", error);
          throw error;
        }
      }

      // 8.8. Helper to get a single instance of FormRepairModal
      function getFormRepairModalInstance() {
        const modalElement = document.getElementById('FormRepairModal');
        if (formRepairModalInstance) {
          formRepairModalInstance.dispose(); // Cleanup instance cũ
        }
        formRepairModalInstance = new bootstrap.Modal(modalElement, {
          backdrop: 'static', // Ngăn click outside để đóng
        });
        return formRepairModalInstance;
      }

      // 8.9. Hàm hiển thị modal thêm báo hỏng
      function showAddRepairModal() {
        try {
          console.log('Opening repair add form');
          RepairModalManager.open(RepairModalManager.MODE.ADD);
        } catch (error) {          
          showError('Có lỗi khi mở form thêm mới: ' + error.message);
        }
      }

      // 8.10. Hàm hiển thị modal sửa báo hỏng
      function showEditRepairModal(repairId) {
        try {
          console.log('Opening repair edit for ID:', repairId);
          if (!repairId) {
            showError('ID báo hỏng không hợp lệ');
            return;
          }
          RepairModalManager.open(RepairModalManager.MODE.EDIT, repairId);
        } catch (error) {          
          showError('Có lỗi khi mở form chỉnh sửa: ' + error.message);
        }
      }
      
      // 8.11. Hàm hiển thị modal xem chi tiết báo hỏng
      function showViewRepairModal(repairId) {
        try {
          console.log('Opening repair details for ID:', repairId);
          if (!repairId) {
            showError('ID báo hỏng không hợp lệ');
            return;
          }
          RepairModalManager.open(RepairModalManager.MODE.VIEW, repairId);
        } catch (error) {          
          showError('Có lỗi khi mở chi tiết báo hỏng: ' + error.message);
        }
      }
      
      // 8.12. Hàm hiển thị modal xóa báo hỏng
      function showDeleteRepairModal(repairId) {
        showConfirm("Xóa báo hỏng", "Bạn có chắc chắn muốn xóa báo hỏng này?", function() {
          showLoading();
          google.script.run
            .withSuccessHandler(function(result) {
              Swal.close();
              if (result) {
                // Remove from appData
                const index = appData.val_DataSC.findIndex(item => 
                  item[CONFIG_COLUMNS.DataSC.id] === repairId
                );
                if (index !== -1) {
                  appData.val_DataSC.splice(index, 1);
                }
                
                // Refresh repair tables
                updateRepairTables();
                
                showSuccess("Xóa báo hỏng thành công");
              } else {
                showError("Có lỗi xảy ra khi xóa báo hỏng");
              }
            })
            .withFailureHandler(handleScriptError)
            .SC_delete(repairId);
        });
      }
      
      function saveRepair() {
        try {
          // Collect form data
          const formData = RepairModalManager.collectFormData();
          
          // Validate form data
          if (!formData.Name_NguoiYeuCau) {
            showError("Vui lòng nhập người yêu cầu");
            return;
          }
          
          if (!formData.SDT_NguoiYeuCau) {
            showError("Vui lòng nhập số điện thoại yêu cầu");
            return;
          }
          
          if (!formData.TinhTrang_ThietBi) {
            showError("Vui lòng nhập tình trạng thiết bị");
            return;
          }
          
          if (!formData.ID_ThietBi) {
            showError("Vui lòng chọn thiết bị");
            return;
          }
          
          if (!formData.ID_MucDo_YeuCau) {
            showError("Vui lòng chọn mức độ ưu tiên");
            return;
          }

          // Prepare data for saving
          const arr_repairDataMain = RepairModalManager.arr_MainSC_prepare(formData);
          const textTelegram = RepairModalManager.textTelegram_prepare(formData);
          const idTelegram_UserRepair = appData.val_DSUserSua.find(
            item => item[CONFIG_COLUMNS.DSUserSua.id] === formData.ID_NguoiSua
          )?.[CONFIG_COLUMNS.DSUserSua.usetele] || '';
          

          const repairData = {
            TrangThai_Form: RepairModalManager.state.mode,
            arr_repairDataMain: arr_repairDataMain,
            idTelegram_UserRepair: idTelegram_UserRepair,
            textTelegram: textTelegram
          };

          // Show loading message
          showLoading();

          // Handle based on mode
          switch (RepairModalManager.state.mode) {
            case RepairModalManager.MODE.ADD:
              google.script.run
                .withSuccessHandler(handleAddRepair)
                .withFailureHandler(handleScriptError)
                .SC_thembaohong(repairData);
              break;
              
            case RepairModalManager.MODE.EDIT:
              google.script.run
                .withSuccessHandler(handleEditRepair)
                .withFailureHandler(handleScriptError)
                .SC_suabaohong(repairData);
              break;
          }
        } catch (error) {          
          showError("Có lỗi xảy ra: " + error.message);
        }
      }

      function handleAddRepair(result) {
        try {
          if (result) {
            // Đóng SweetAlert loading
            Swal.close();

            // Cập nhật dữ liệu và giao diện
            updateData(result);
            updateUI();

            // Đóng modal
            const modalElement = document.getElementById('FormRepairModal');
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
              modalInstance.hide();
            }

            // Thông báo thành công
            showSuccess("Thêm báo hỏng thành công");
          } else {
            showError("Không nhận được dữ liệu từ server");
          }
        } catch (error) {          
          showError("Có lỗi xảy ra: " + error.message);
        }
      }

      function handleEditRepair(result) {
        try {
          Swal.close();
          
          if (result) {
            // Đóng modal
            const modalInstance = getFormRepairModalInstance(); // Lấy instance
            modalInstance.hide(); // Gọi phương thức hide để đóng modal

            // Update appData with edited repair data
            const index = appData.val_DataSC.findIndex(item => 
              item[CONFIG_COLUMNS.DataSC.id] === result[CONFIG_COLUMNS.DataSC.id]
            );
            if (index !== -1) {
              appData.val_DataSC[index] = result;
            }
            
            // Refresh repair tables
            updateRepairTables();
            
            // Show success message
            showSuccess("Cập nhật báo hỏng thành công");
          } else {
            showError("Có lỗi xảy ra khi cập nhật báo hỏng");
          }
        } catch (error) {          
          showError("Có lỗi xảy ra: " + error.message);
        }
      }

      // RepairModalManager object to handle repair modal operations
      const RepairModalManager = {
        // 1. Quản lý trạng thái
        state: {
          isOpen: false,      // Modal open/close state
          mode: null,         // Operation mode (ADD/EDIT/VIEW)
          formData: null,     // Current form data
          originalData: null  // Original data (for EDIT/VIEW)
        },

        // 2. Các hằng số mode
        MODE: {
          ADD: 1,
          EDIT: 2,
          VIEW: 3,
          DELETE: 4
        },

        // 3. Khởi tạo modal manager
        initialize() {
          const modalElement = document.getElementById('FormRepairModal');
          
          // 3.1. Listen for modal hidden event
          modalElement.addEventListener('hidden.bs.modal', () => {
            this.handleModalHidden();
          });
          
          // 3.2. Listen for modal shown event  
          modalElement.addEventListener('shown.bs.modal', () => {
            this.handleModalShown();
          });
        },

        // 3.3. Handle modal hidden event
        handleModalHidden() {
          this.state.isOpen = false;
          this.state.mode = null;
          this.state.formData = null;
          this.state.originalData = null;
          
          // Cleanup backdrop
          const backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) {
            backdrop.remove();
          }
          
          // Dispose modal instance
          if (formRepairModalInstance) {
            formRepairModalInstance.dispose();
            formRepairModalInstance = null;
          }
        },

        // 3.4. Handle modal shown event
        handleModalShown() {
          this.state.isOpen = true;
        },

        // 3.6. Mở modal với mode và ID sửa chữa
        open(mode, repairId = null) {
          try {
            // Cleanup trước khi mở modal mới
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
              backdrop.remove();
            }
            
            this.state.mode = mode;
            const modalElement = document.getElementById('FormRepairModal');
            const modalTitle = modalElement.querySelector('.modal-title');
            const saveButton = modalElement.querySelector('button[onclick="saveRepair()"]');
            this.ListDropDowns_Requester();

            // Configure UI based on mode
            switch (mode) {
              case this.MODE.ADD:
                modalTitle.textContent = 'Thêm báo hỏng mới';
                saveButton.style.display = 'block';
                saveButton.textContent = 'Lưu';
                document.getElementById('repairId').value = this.generateRepairID();
                this.valFormRepair_Add();
                this.EnDisableField_Add();
                break;

              case this.MODE.EDIT:
                modalTitle.textContent = 'Chỉnh sửa báo hỏng';
                saveButton.style.display = 'block';
                saveButton.textContent = 'Cập nhật';
                this.valFormRepair_Edit_View(repairId);
                this.EnDisableField_Edit();
                break;

              case this.MODE.VIEW:
                modalTitle.textContent = 'Chi tiết báo hỏng';
                saveButton.style.display = 'none';
                this.valFormRepair_Edit_View(repairId);
                this.EnDisableField_View();
                break;
            }

            // Show modal sau khi đã setup xong
            getFormRepairModalInstance().show();

          } catch (error) {
            // Cleanup nếu có lỗi
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
              backdrop.remove();
            }
            showError('Có lỗi khi mở form: ' + error.message);
          }
        },

        // 3.7. Hàm tạo ID sửa chữa
        generateRepairID() {
          const Time_now = new Date();
          
          // Find val_Repair.Max Id_Count
          if (val_Repair.MaxId_Count == 0) {
            // Filter data by department
            const userDeptRepairs = appData.val_DataSC.filter(row => 
              row && row[CONFIG_COLUMNS.DataSC.iduserdv] === userData.id
            );
            
            if (userDeptRepairs.length > 0) {
              const sequenceNumbers = userDeptRepairs
                .map(row => {
                  if (!row || !row[CONFIG_COLUMNS.DataSC.id]) return 0;
                  
                  const parts = row[CONFIG_COLUMNS.DataSC.id].split('.');
                  if (parts.length < 4) return 0;
                  
                  const currentYear = Time_now.getFullYear().toString().slice(-2);
                  const idYear = parts[2].slice(0, 2);
                  return idYear === currentYear ? parseInt(parts[3], 10) : 0;
                })
                .filter(num => !isNaN(num));
              
              if (sequenceNumbers.length > 0) {
                val_Repair.MaxId_Count = Math.max(...sequenceNumbers);
              }
            }
          }

          const sequenceNumber = ("000" + (val_Repair.MaxId_Count + 1)).slice(-3);
          const year = Time_now.getFullYear().toString().slice(-2);
          const month = ("0" + (Time_now.getMonth() + 1)).slice(-2);
          const day = ("0" + Time_now.getDate()).slice(-2);
          const datePart = year + month + day;
          const milisecondPart = Time_now.getMilliseconds().toString().padStart(3, '0');
          const repairID = "SC." + userData.kihieu + "." + datePart + "." + sequenceNumber + "." + milisecondPart;
          console.log('Generated repair ID:', repairID);
          
          return repairID;
        },

        // 3.8. Giá trị mặc định cho form thêm báo hỏng
        valFormRepair_Add() {
          document.getElementById('equipmentGroup').selectedIndex = 0;
          document.getElementById('equipmentId').innerHTML = '<option value="">-- Chọn thiết bị --</option>';
          document.getElementById('equipmentStatus').value = '';
          document.getElementById('priorityLevel').selectedIndex = 0;
          document.getElementById('notes').value = '';
          this.clearEquipmentDetails();
        },

        // 3.9. Giá trị cho form chỉnh sửa/xem báo hỏng
        valFormRepair_Edit_View(repairId) {
          const repair = appData.val_DataSC.find(item => 
            item[CONFIG_COLUMNS.DataSC.id] === repairId
          );

          if (repair) {
            // Fill form with repair data
            document.getElementById('repairId').value = repair[CONFIG_COLUMNS.DataSC.id];
            document.getElementById('requesterName').value = repair[CONFIG_COLUMNS.DataSC.hoten];
            document.getElementById('requesterPhone').value = repair[CONFIG_COLUMNS.DataSC.sdt];
            document.getElementById('repairPerson').value = repair[CONFIG_COLUMNS.DataSC.idusersua];
            
            this.updateRepairPersonPhone();
            
            // Load equipment details
            const equipmentId = repair[CONFIG_COLUMNS.DataSC.idthietbi];
            const equipment = appData.val_DSThietBi.find(eq => eq[CONFIG_COLUMNS.DSThietBi.id] === equipmentId);
            
            if (equipment) {
              document.getElementById('equipmentGroup').value = equipment[CONFIG_COLUMNS.DSThietBi.nhomtb];
              this.updateEquipmentList();
              document.getElementById('equipmentId').value = equipmentId;
              this.updateEquipmentDetails();
            }

            document.getElementById('equipmentStatus').value = repair[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao];
            document.getElementById('priorityLevel').value = repair[CONFIG_COLUMNS.DataSC.mucdo];
            document.getElementById('notes').value = repair[CONFIG_COLUMNS.DataSC.ghichu];
          }
        },

        // 3.10. En/Disable các trường trong form xem báo hỏng
        EnDisableField_View() {
          document.getElementById('requesterName').disabled = true;
          document.getElementById('requesterPhone').disabled = true;
          document.getElementById('repairPerson').disabled = true;
          document.getElementById('equipmentGroup').disabled = true;
          document.getElementById('equipmentId').disabled = true;
          document.getElementById('equipmentStatus').disabled = true;
          document.getElementById('priorityLevel').disabled = true;
          document.getElementById('notes').disabled = true;
        },

        // 3.11. En/Disable các trường trong form thêm báo hỏng
        EnDisableField_Add() {
          document.getElementById('requesterName').disabled = false;
          document.getElementById('requesterPhone').disabled = false;
          document.getElementById('repairPerson').disabled = false;
          document.getElementById('equipmentGroup').disabled = false;
          document.getElementById('equipmentId').disabled = false;
          document.getElementById('equipmentStatus').disabled = false; 
          document.getElementById('priorityLevel').disabled = false; 
          document.getElementById('notes').disabled = false; 
        },

        // 3.12. En/Disable các trường trong form chỉnh sửa
        EnDisableField_Edit() {
          document.getElementById('requesterName').disabled = false;
          document.getElementById('requesterPhone').disabled = false;
          document.getElementById('repairPerson').disabled = false;
          document.getElementById('equipmentGroup').disabled = false;
          document.getElementById('equipmentId').disabled = false;
          document.getElementById('equipmentStatus').disabled = false;
          document.getElementById('priorityLevel').disabled = false;
          document.getElementById('notes').disabled = false;
        },

        
        // 3.5. Hàm điền dữ liệu cho các dropdown list: Người sửa chữa, Nhóm thiết bị, Mức độ ưu tiên
        ListDropDowns() {
          // 3.5.1. Dropdown Người sửa chữa
        const repairPersonSelect = document.getElementById('repairPerson');
        repairPersonSelect.innerHTML = '<option value="">-- Chọn người sửa chữa --</option>';
        const repairPersons = appData.val_DSUserSua;
        for (let i = 1; i < repairPersons.length; i++) {
          const person = repairPersons[i];
          const option = document.createElement('option');
          option.value = person[CONFIG_COLUMNS.DSUserSua.id];
          option.textContent = person[CONFIG_COLUMNS.DSUserSua.hoten];
          repairPersonSelect.appendChild(option);
        }
          // 3.5.2. Dropdown Nhóm thiết bị
        const equipmentGroupSelect = document.getElementById('equipmentGroup');
        equipmentGroupSelect.innerHTML = '<option value="">-- Chọn nhóm thiết bị --</option>';
          // Lọc thiết bị thuộc đơn vị hiện tại
        const equipment = appData.val_DSThietBi;
        const departmentEquipment = equipment.filter(item => 
          item[CONFIG_COLUMNS.DSThietBi.donvi] == userData.id // Theo cột "Đơn vị_TB"
        );
          // Tạo Set để lưu các nhóm thiết bị không trùng lặp của đơn vị
        const departmentGroups = new Set();
        departmentEquipment.forEach(item => {
          if (item[CONFIG_COLUMNS.DSThietBi.nhomtb]) {
            departmentGroups.add(item[CONFIG_COLUMNS.DSThietBi.nhomtb]);
          }
        });
          // Lọc Nhóm thiết bị theo thiết bị
        const equipmentGroups = appData.val_DSNhomTB;
        for (let i = 1; i < equipmentGroups.length; i++) {
          const group = equipmentGroups[i];
          const groupName = group[CONFIG_COLUMNS.DSNhomTB.nhomtb];
          const groupID = group[CONFIG_COLUMNS.DSNhomTB.id];
          // Chỉ thêm nhóm thiết bị nếu đơn vị hiện tại có thiết bị thuộc nhóm đó
          if (departmentGroups.has(groupID)) {
            const option = document.createElement('option');
            option.value = groupID;
            option.textContent = groupName;
            equipmentGroupSelect.appendChild(option);
          }
        }
          // 3.5.3. Mức độ ưu tiên
        const prioritySelect = document.getElementById('priorityLevel');
        prioritySelect.innerHTML = '<option value="">-- Chọn mức độ ưu tiên --</option>';
        const enumSettings = appData.val_EnumSetting;
        const priorities = enumSettings.filter(item => item[1] === "Mức độ YC");
        for (let i = 0; i < priorities.length; i++) {
          const priority = priorities[i];
          const option = document.createElement('option');
          option.value = priority[0]; // ID
          option.textContent = priority[2]; // Tên mức độ
          prioritySelect.appendChild(option);
        }
        },

        // 3.13. Hàm điền dữ liệu cho các dropdown list: Người yêu cầu
        ListDropDowns_Requester() {
          const repairs = appData.val_DataSC;
          // Lọc báo hỏng thuộc đơn vị hiện tại
          const departmentRepairs = repairs.filter(item => 
            item[CONFIG_COLUMNS.DataSC.iduserdv] == userData.id
          );

          const requesters = new Set();

          // Lọc và thêm tên người yêu cầu không trùng lặp vào Set
          departmentRepairs.forEach(repair => {
            if (repair[CONFIG_COLUMNS.DataSC.hoten]) {
              requesters.add(repair[CONFIG_COLUMNS.DataSC.hoten]);
            }
          });

          // Dropdown Người yêu cầu
          const requesterList = document.getElementById('requesterList');
          requesterList.innerHTML = ''; // Xóa các tùy chọn cũ
          requesters.forEach(requester => {
            const option = document.createElement('option');
            option.value = requester;
            requesterList.appendChild(option);
          });

            // 3.5.10. Dropdown Tình trạng thiết bị
        const statusList = document.getElementById('statusList');
        statusList.innerHTML = '';
        const statuses = new Set();
        departmentRepairs.forEach(repair => {
          if (repair[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao]) {
            statuses.add(repair[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao]);
          }
        });
        statuses.forEach(status => {
          const option = document.createElement('option');
          option.value = status;
          statusList.appendChild(option);
        });
        },

        // 3. 14 Hàm cập nhật số điện thoại người báo sửa khi người báo sửa thay đổi
        updateRequesterPhone() {
          const Name_requester = document.getElementById('requesterName').value;
          const unitId = userData.id; // Giả sử userData.id là ID đơn vị của người dùng hiện tại
          console.log('Name_requester:', Name_requester);
          if (!Name_requester) {
            console.log('No requester selected');
            document.getElementById('requesterPhone').value = '';
            return;
          }

          // Tìm người yêu cầu trong appData.val_DataSC theo cả tên và ID đơn vị
          console.log('Finding requester with name:', Name_requester, 'and unit ID:', unitId);
          const Sdt_requester = appData.val_DataSC.find(item => 
            item[CONFIG_COLUMNS.DataSC.hoten] === Name_requester && 
            item[CONFIG_COLUMNS.DataSC.iduserdv] === unitId
          );
          console.log('Found requester:', Sdt_requester);

          if (Sdt_requester) {
            const phoneList = document.getElementById('phoneList');
            phoneList.innerHTML = ''; // Clear existing options
            if (Sdt_requester[CONFIG_COLUMNS.DataSC.sdt]) {
              const option = document.createElement('option');
              option.value = Sdt_requester[CONFIG_COLUMNS.DataSC.sdt];
              phoneList.appendChild(option);
              console.log('Added phone option:', option.value);
            }
          } else {
            console.log('No requester found, clearing phone field');
            document.getElementById('requesterPhone').value = '';
          }
        },

        // 3.14. Hàm cập nhật số điện thoại người sửa chữa khi người sửa chữa thay đổi
        updateRepairPersonPhone() {
          const repairPersonId = document.getElementById('repairPerson').value;
          if (!repairPersonId) {
            document.getElementById('repairPersonPhone').value = '';
            return;
          }
          
          const repairPerson = appData.val_DSUserSua.find(person => 
            person[CONFIG_COLUMNS.DSUserSua.id] === repairPersonId
          );
          if (repairPerson) {
            document.getElementById('repairPersonPhone').value = repairPerson[CONFIG_COLUMNS.DSUserSua.sdt] || '';
          }
        },

        // 3.14. Cập nhật danh sách thiết bị khi nhóm thiết bị thay đổi
        updateEquipmentList() {
          const selectedGroup = document.getElementById('equipmentGroup').value;
          const equipmentSelect = document.getElementById('equipmentId');
          
          equipmentSelect.innerHTML = '<option value="">-- Chọn thiết bị --</option>';
          
          if (!selectedGroup) return;
          
          const departmentEquipment = appData.val_DSThietBi.filter(item => 
            item[CONFIG_COLUMNS.DSThietBi.nhomtb] === selectedGroup && 
            item[CONFIG_COLUMNS.DSThietBi.donvi] == userData.id
          );
          
          departmentEquipment.forEach(item => {
            const option = document.createElement('option');
            option.value = item[CONFIG_COLUMNS.DSThietBi.id];
            option.textContent = item[CONFIG_COLUMNS.DSThietBi.mathietbi] + ' - ' + item[CONFIG_COLUMNS.DSThietBi.tentb];
            equipmentSelect.appendChild(option);
          });
          
          this.clearEquipmentDetails();
        },

        // 3.15. Xóa giá trị các trường thiết bị
        clearEquipmentDetails() {
          try {
            document.getElementById('equipmentName').value = '';
            document.getElementById('equipmentModel').value = '';
            document.getElementById('equipmentSerial').value = '';
            document.getElementById('equipmentManufacturer').value = '';
            document.getElementById('equipmentYear').value = '';
            document.getElementById('equipmentUseYear').value = '';
            document.getElementById('equipmentWarranty').value = '';
            document.getElementById('equipmentLocation').value = '';
          } catch (error) {
            console.error('Error in clearEquipmentDetails:', error);
          }
        },

        // 3.16. Cập nhật giá trị các trường thiết bị khi thiết bị thay đổi
        updateEquipmentDetails() {
          try {
            const equipmentIdElement = document.getElementById('equipmentId');
            if (!equipmentIdElement) {
              console.error('Equipment ID element not found');
              return;
            }

            const equipmentId = equipmentIdElement.value;
            this.clearEquipmentDetails();
            
            if (!equipmentId) return;
            
            const equipment = appData.val_DSThietBi.find(item => 
              item[CONFIG_COLUMNS.DSThietBi.id] === equipmentId
            );
            
            if (equipment) {
              document.getElementById('equipmentName').value = equipment[CONFIG_COLUMNS.DSThietBi.tentb] || '';
              document.getElementById('equipmentModel').value = equipment[CONFIG_COLUMNS.DSThietBi.model] || '';
              document.getElementById('equipmentSerial').value = equipment[CONFIG_COLUMNS.DSThietBi.serial] || '';
              document.getElementById('equipmentManufacturer').value = equipment[CONFIG_COLUMNS.DSThietBi.hangsx] || '';
              document.getElementById('equipmentYear').value = equipment[CONFIG_COLUMNS.DSThietBi.namsx] || '';
              document.getElementById('equipmentUseYear').value = equipment[CONFIG_COLUMNS.DSThietBi.namsd] || '';
              document.getElementById('equipmentWarranty').value = equipment[CONFIG_COLUMNS.DSThietBi.hanbaohanh] || '';
              document.getElementById('equipmentLocation').value = equipment[CONFIG_COLUMNS.DSThietBi.vitridat] || '';
            }
          } catch (error) {
            console.error('Error in updateEquipmentDetails:', error);
          }
        },

        // 3.17. Thu thập dữ liệu từ form
        collectFormData() {
          return {
            id_repair: document.getElementById('repairId').value,
            Name_NguoiYeuCau: document.getElementById('requesterName').value,
            SDT_NguoiYeuCau: document.getElementById('requesterPhone').value,
            ID_NguoiSua: document.getElementById('repairPerson').value,
            ID_ThietBi: document.getElementById('equipmentId').value,
            TinhTrang_ThietBi: document.getElementById('equipmentStatus').value,
            ID_MucDo_YeuCau: document.getElementById('priorityLevel').value,
            GhiChu_repair: document.getElementById('notes').value,
            trangThai_repair: CONFIG_ENUM.TRANGTHAI.BAO_HONG,
            timeupdate: new Date().toLocaleString('vi-VN', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: false
            })
          };
        },

        // 3.18. Chuẩn bị dữ liệu cho mảng Main_SC
        arr_MainSC_prepare(repairDataForm) {
          const currentDateTime = repairDataForm.timeupdate;
          const newRow = Array(appData.val_DataSC[0].length).fill("");

          newRow[CONFIG_COLUMNS.DataSC.id] = repairDataForm.id_repair;
          newRow[CONFIG_COLUMNS.DataSC.trangthai] = repairDataForm.trangThai_repair;
          newRow[CONFIG_COLUMNS.DataSC.mucdo] = repairDataForm.ID_MucDo_YeuCau;
          newRow[CONFIG_COLUMNS.DataSC.iduserdv] = userData.id;
          newRow[CONFIG_COLUMNS.DataSC.idusersua] = repairDataForm.ID_NguoiSua;
          newRow[CONFIG_COLUMNS.DataSC.idthietbi] = repairDataForm.ID_ThietBi;
          newRow[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao] = repairDataForm.TinhTrang_ThietBi;
          newRow[CONFIG_COLUMNS.DataSC.ngaydonvibao] = currentDateTime;
          newRow[CONFIG_COLUMNS.DataSC.ghichu] = repairDataForm.GhiChu_repair;
          newRow[CONFIG_COLUMNS.DataSC.hoten] = repairDataForm.Name_NguoiYeuCau;
          newRow[CONFIG_COLUMNS.DataSC.sdt] = repairDataForm.SDT_NguoiYeuCau;

          let historyEntry = `* Ngày ${currentDateTime}   - ${repairDataForm.Name_NguoiYeuCau}: Báo hỏng`;
          if (repairDataForm.GhiChu_repair?.trim()) {
            historyEntry += `\n   - Ghi chú: ${repairDataForm.GhiChu_repair}`;
          }
          newRow[CONFIG_COLUMNS.DataSC.history] = historyEntry;
          newRow[CONFIG_COLUMNS.DataSC.timeupdate] = currentDateTime;

          return newRow;
        },

        // 3.19. Chuẩn bị tin nhắn Telegram
        textTelegram_prepare(repairDataForm) {
          const thietbi = appData.val_DSThietBi.find(item => 
            item[CONFIG_COLUMNS.DSThietBi.id] === repairDataForm.ID_ThietBi
          );
          
          const mucdo = appData.val_EnumSetting.find(item => 
            item[0] === repairDataForm.ID_MucDo_YeuCau && item[1] === "Mức độ YC"
          );
          
          const nguoisua = appData.val_DSUserSua.find(item =>
            item[CONFIG_COLUMNS.DSUserSua.id] === repairDataForm.ID_NguoiSua
          );

          const thietbiInfo = {
            ten: thietbi ? thietbi[CONFIG_COLUMNS.DSThietBi.tentb] : 'Không xác định',
            model: thietbi ? thietbi[CONFIG_COLUMNS.DSThietBi.model] : 'Không xác định',
            serial: thietbi ? thietbi[CONFIG_COLUMNS.DSThietBi.serial] : 'Không xác định'
          };

          const mucdoText = mucdo ? mucdo[2] : 'Không xác định';
          const nguoisuaText = nguoisua ? nguoisua[CONFIG_COLUMNS.DSUserSua.hoten] : '';

          return `🔔 *BÁO HỎNG THIẾT BỊ MỚI* 🔔
━━━━━━━━━━━━━━━━━━━━━━━━
🆔 *ID:* ${repairDataForm.id_repair}
🏥 *Đơn vị báo hỏng:* ${userData.name}
🔧 *Thiết bị:* ${thietbiInfo.ten}
📋 *Model:* ${thietbiInfo.model}
🔢 *Serial:* ${thietbiInfo.serial}
⚠️ *Tình trạng:* ${repairDataForm.TinhTrang_ThietBi}
⏱️ *Mức độ ưu tiên:* ${mucdoText}
👤 *Người yêu cầu:* ${repairDataForm.Name_NguoiYeuCau} (${repairDataForm.SDT_NguoiYeuCau})
${nguoisuaText ? `👨‍🔧 *Người phụ trách:* ${nguoisuaText}` : ""}`;
        }
      };
    </script>
  </body>
</html> 
</html> 
</html> 