<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph·∫ßn m·ªÅm qu·∫£n l√Ω s·ª≠a ch·ªØa - B·ªánh vi·ªán ƒêa khoa B·∫Øc Giang</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    
    <!-- Google Platform -->
    <script src="https://apis.google.com/js/platform.js"></script>
    
    <style>
      body {
        background-color: #f8f9fa;
        font-family: Arial, sans-serif;
      }

      .container {
        max-width: 100%;
        margin-top: 20px;
      }
      
      /* Loading screen */
      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: #f4f4f4;
        z-index: 9999;
        transition: opacity 0.5s ease, visibility 0.5s ease;
      }

      .loading-screen.hidden {
        opacity: 0;
        visibility: hidden;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #ddd;
        border-top-color: #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .loading-message {
        margin-top: 20px;
        font-size: 16px;
        color: #333;
        text-align: center;
      }
      
      /* Login form */
      #loginSection {
        width: 500px;
        margin: 100px auto;
        padding: 20px;
        display: none;
      }
      
      .card {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        border: none;
        padding: 10px;
      }

      .card-header {
        background-color: #007bff;
        color: #fff;
        font-size: 1rem;
        font-weight: bold;
        text-align: center;
        padding: 5px;
      }

      .password-field {
        position: relative;
      }

      .toggle-password {
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        cursor: pointer;
      }
      
      /* Main sections */
      .section {
        display: none;
        padding: 5px;
      }

      .dashboard {
        margin-left: 10px;
        margin-right: 10px;
        display: none;
      }

      .nav-pills .nav-link.active {
        background-color: #007bff;
        color: #fff;
      }

      .tab-content .tab-pane {
        padding: 15px;
        padding-left: 10px;
        padding-right: 10px;
        border-top: none;
        background-color: #ffffff;
      }
      
      /* Tables */
      .custom-table {
        border-collapse: collapse;
        width: 100%;
        border: 1px solid #ddd;
        font-size: 18px;
      }

      .custom-table th,
      .custom-table td {
        text-align: left;
        padding: 12px;
      }

      .custom-table tr {
        border-bottom: 1px solid #ddd;
      }

      .custom-table tr.tb_header,
      .custom-table tr:hover {
        background-color: #f1f1f1;
      }
      
      /* Action buttons */
      .action-buttons button {
        padding: 5px 10px;
        margin: 2px;
        cursor: pointer;
      }

      .edit-button {
        background-color: #4CAF50;
        color: white;
        border: none;
      }

      .delete-button {
        background-color: #f44336;
        color: white;
        border: none;
      }
      
      /* Modal */
      .modal {
        z-index: 1050;
      }

      .modal-backdrop {
        z-index: 1040;
      }

      .modal-dialog {
        z-index: 1050;
        margin: 1.75rem auto;
      }

      .modal-content {
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        z-index: 1050;
      }
      
      .modal-header {
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
      }
      
      /* Password field styling */
      .input-group .btn-outline-secondary {
        border-color: #ced4da;
      }
      
      .input-group .btn-outline-secondary:hover {
        background-color: #f8f9fa;
      }
      
      /* Header styles */
      .app-header {
        background-color: #fff;
        border-bottom: 1px solid #ddd;
        padding: 10px 0;
        margin-bottom: 20px;
      }

      .app-logo {
        height: 50px;
        margin-right: 15px;
        flex-shrink: 0;
      }
      
      .app-title {
        color: #007bff;
        font-size: 1.5rem;
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }
      
      @media (max-width: 992px) {
        .app-title {
          font-size: 1.25rem;
        }
      }
      
      @media (max-width: 768px) {
        .app-title {
          font-size: 1rem;
        }
      }
      
      .user-profile {
        display: flex;
        align-items: center;
        cursor: pointer;
      }
      
      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
      }
      
      .dropdown-menu {
        min-width: 200px;
      }
    </style>
  </head>
  <body>
    <!-- Loading screen -->
    <div id="loading" class="loading-screen">
      <div class="spinner"></div>
      <div class="loading-message">ƒêang t·∫£i d·ªØ li·ªáu, vui l√≤ng ƒë·ª£i...</div>
    </div>
    
    <!-- Login section -->
    <div id="loginSection" class="container">
      <div class="card">
        <div class="card-header">
          ƒêƒÇNG NH·∫¨P<br>PH·∫¶N M·ªÄM QU·∫¢N L√ù S·ª¨A CH·ªÆA
        </div>
        <div class="card-body">
          <form id="loginForm">
            <div class="mb-3">
              <label for="username" class="form-label">T√™n ƒëƒÉng nh·∫≠p</label>
              <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-3 password-field">
              <label for="password" class="form-label">M·∫≠t kh·∫©u</label>
              <input type="password" class="form-control" id="password" required>
              <i class="toggle-password fas fa-eye-slash" onclick="togglePassword()"></i>
            </div>
            <button type="button" class="btn btn-primary w-100" onclick="login()">ƒêƒÉng nh·∫≠p</button>
          </form>
        </div>
      </div>
    </div>
    
    <!-- Main application -->
    <div id="mainApp" class="section">
      <!-- Header -->
      <div class="app-header">
        <div class="container">
          <div class="row align-items-center">
            <div class="col-md-8 d-flex align-items-center">
              <img src="https://drive.google.com/thumbnail?id=16gCExt-p9JflHcqZQ2nxWLDL65bpD-Tf&sz=s100" alt="Logo" class="app-logo">
              <span class="app-title">Ph·∫ßn m·ªÅm qu·∫£n l√Ω s·ª≠a ch·ªØa - B·ªánh vi·ªán ƒêa khoa B·∫Øc Giang</span>
            </div>
            <div class="col-md-4 text-end">
              <div class="dropdown">
                <div class="user-profile dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                  <img id="userAvatar" src="https://drive.google.com/thumbnail?id=1Y2obUC2vpgQLsD1JokCX8QY4olp3LjXe&sz=s100" alt="User Avatar" class="user-avatar">
                  <span id="userName">User Name</span>
                  <i class="fas fa-chevron-down ms-2"></i>
                </div>
                <ul class="dropdown-menu" aria-labelledby="userDropdown">
                  <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editProfileModal"><i class="fas fa-user-edit me-2"></i>Ch·ªânh s·ª≠a th√¥ng tin</a></li>
                  <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal"><i class="fas fa-key me-2"></i>ƒê·ªïi m·∫≠t kh·∫©u</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>ƒêƒÉng xu·∫•t</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Main content -->
      <div class="container dashboard">
        <div class="row mb-3">
          <div class="col-md-3">
            <button class="btn btn-success w-100" onclick="showAddRepairModal()" data-bs-toggle="modal" data-bs-target="#FormRepairModal">
              <i class="fas fa-plus me-2"></i>Th√™m b√°o h·ªèng
            </button>
          </div>
          <div class="col-md-6">
            <div class="input-group">
              <input type="text" class="form-control" id="searchInput" placeholder="Nh·∫≠p n·ªôi dung t√¨m ki·∫øm...">
              <button class="btn btn-primary" type="button" onclick="searchRepair()">
                <i class="fas fa-search me-2"></i>T√¨m ki·∫øm
              </button>
              <button class="btn btn-secondary" type="button" onclick="cancelSearch()">
                <i class="fas fa-times me-2"></i>H·ªßy t√¨m ki·∫øm
              </button>
            </div>
          </div>
        </div>
        
        <!-- Tabs -->
        <ul class="nav nav-pills mb-3" id="repairTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-baohong" data-bs-toggle="pill" data-bs-target="#baohong" type="button" role="tab">
              B√°o h·ªèng (0)
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-dangsua" data-bs-toggle="pill" data-bs-target="#dangsua" type="button" role="tab">
              ƒêang s·ª≠a (0)
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-baohanh" data-bs-toggle="pill" data-bs-target="#baohanh" type="button" role="tab">
              B·∫£o h√†nh (0)
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-suangoai" data-bs-toggle="pill" data-bs-target="#suangoai" type="button" role="tab">
              S·ª≠a ngo√†i (0)
            </button>
          </li>
        </ul>
        
        <!-- Tab content -->
        <div class="tab-content" id="repairTabsContent">
          <!-- B√°o h·ªèng tab -->
          <div class="tab-pane fade show active" id="baohong" role="tabpanel">
            <table class="custom-table">
              <thead>
                <tr class="tb_header">
                  <th style="width: 5%;">STT</th>
                  <th style="width: 75%;">N·ªôi dung</th>
                  <th style="width: 20%;">H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="history_baohong">
                <!-- Data will be populated dynamically -->
              </tbody>
            </table>
          </div>
          
          <!-- ƒêang s·ª≠a tab -->
          <div class="tab-pane fade" id="dangsua" role="tabpanel">
            <table class="custom-table">
              <thead>
                <tr class="tb_header">
                  <th style="width: 5%;">STT</th>
                  <th style="width: 75%;">N·ªôi dung</th>
                  <th style="width: 20%;">H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="history_dangsua">
                <!-- Data will be populated dynamically -->
              </tbody>
            </table>
          </div>
          
          <!-- B·∫£o h√†nh tab -->
          <div class="tab-pane fade" id="baohanh" role="tabpanel">
            <table class="custom-table">
              <thead>
                <tr class="tb_header">
                  <th style="width: 5%;">STT</th>
                  <th style="width: 75%;">N·ªôi dung</th>
                  <th style="width: 20%;">H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="history_baohanh">
                <!-- Data will be populated dynamically -->
              </tbody>
            </table>
          </div>
          
          <!-- S·ª≠a ngo√†i tab -->
          <div class="tab-pane fade" id="suangoai" role="tabpanel">
            <table class="custom-table">
              <thead>
                <tr class="tb_header">
                  <th style="width: 5%;">STT</th>
                  <th style="width: 75%;">N·ªôi dung</th>
                  <th style="width: 20%;">H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="history_suangoai">
                <!-- Data will be populated dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Add Repair Modal -->
    <div class="modal fade" id="FormRepairModal" tabindex="-1" aria-labelledby="FormRepairModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Th√™m b√°o h·ªèng m·ªõi</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="addRepairForm">
              <input type="hidden" id="repairId">
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="departmentName" class="form-label">ƒê∆°n v·ªã y√™u c·∫ßu</label>
                  <input type="text" class="form-control" id="departmentName" readonly>
                </div>
                <div class="col-md-6">
                  <label for="requesterName" class="form-label">Ng∆∞·ªùi y√™u c·∫ßu</label>
                  <input type="text" class="form-control" id="requesterName" list="requesterList">
                  <datalist id="requesterList"></datalist>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="requesterPhone" class="form-label">S·ªë ƒëi·ªán tho·∫°i y√™u c·∫ßu</label>
                  <input type="text" class="form-control" id="requesterPhone" list="phoneList">
                  <datalist id="phoneList"></datalist>
                </div>
                <div class="col-md-6">
                  <label for="repairPerson" class="form-label">Ng∆∞·ªùi s·ª≠a ch·ªØa</label>
                  <select class="form-select" id="repairPerson" onchange="updateRepairPersonPhone()"></select>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="repairPersonPhone" class="form-label">S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi s·ª≠a ch·ªØa</label>
                  <input type="text" class="form-control" id="repairPersonPhone" readonly>
                </div>
                <div class="col-md-6">
                  <label for="equipmentGroup" class="form-label">Nh√≥m thi·∫øt b·ªã</label>
                  <select class="form-select" id="equipmentGroup" onchange="updateEquipmentList()"></select>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="equipmentId" class="form-label">M√£ thi·∫øt b·ªã</label>
                  <select class="form-select" id="equipmentId" onchange="updateEquipmentDetails()"></select>
                </div>
                <div class="col-md-6">
                  <label for="equipmentName" class="form-label">T√™n thi·∫øt b·ªã</label>
                  <input type="text" class="form-control" id="equipmentName" readonly>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="equipmentModel" class="form-label">Model</label>
                  <input type="text" class="form-control" id="equipmentModel" readonly>
                </div>
                <div class="col-md-6">
                  <label for="equipmentSerial" class="form-label">Serial</label>
                  <input type="text" class="form-control" id="equipmentSerial" readonly>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="equipmentManufacturer" class="form-label">H√£ng s·∫£n xu·∫•t</label>
                  <input type="text" class="form-control" id="equipmentManufacturer" readonly>
                </div>
                <div class="col-md-6">
                  <label for="equipmentCountry" class="form-label">N∆∞·ªõc s·∫£n xu·∫•t</label>
                  <input type="text" class="form-control" id="equipmentCountry" readonly>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="equipmentYear" class="form-label">NƒÉm s·∫£n xu·∫•t</label>
                  <input type="text" class="form-control" id="equipmentYear" readonly>
                </div>
                <div class="col-md-6">
                  <label for="equipmentUseYear" class="form-label">NƒÉm ƒë∆∞a v√†o s·ª≠ d·ª•ng</label>
                  <input type="text" class="form-control" id="equipmentUseYear" readonly>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="equipmentWarranty" class="form-label">H·∫°n b·∫£o h√†nh</label>
                  <input type="text" class="form-control" id="equipmentWarranty" readonly>
                </div>
                <div class="col-md-6">
                  <label for="equipmentLocation" class="form-label">V·ªã tr√≠ ƒë·∫∑t</label>
                  <input type="text" class="form-control" id="equipmentLocation" readonly>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="equipmentStatus" class="form-label">T√¨nh tr·∫°ng thi·∫øt b·ªã</label>
                  <input type="text" class="form-control" id="equipmentStatus" list="statusList">
                  <datalist id="statusList"></datalist>
                </div>
                <div class="col-md-6">
                  <label for="priorityLevel" class="form-label">M·ª©c ƒë·ªô y√™u c·∫ßu</label>
                  <select class="form-select" id="priorityLevel"></select>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="notes" class="form-label">Ghi ch√∫</label>
                <textarea class="form-control" id="notes" rows="3"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button type="button" class="btn btn-primary" onclick="saveRepair()">L∆∞u</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit User Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Ch·ªânh s·ª≠a th√¥ng tin c√° nh√¢n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="profileName" class="form-label">T√™n ƒë∆°n v·ªã</label>
              <input type="text" class="form-control" id="profileName">
            </div>
            <div class="mb-3">
              <label for="profileEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="profileEmail">
            </div>
            <div class="mb-3">
              <label for="profileLogo" class="form-label">URL Logo (t√πy ch·ªçn)</label>
              <input type="text" class="form-control" id="profileLogo">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button type="button" class="btn btn-primary" onclick="saveProfile()">L∆∞u thay ƒë·ªïi</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">ƒê·ªïi m·∫≠t kh·∫©u</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3 position-relative">
              <label for="currentPassword" class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
              <div class="input-group">
                <input type="password" class="form-control" id="currentPassword">
                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordField('currentPassword')">
                  <i class="fas fa-eye-slash"></i>
                </button>
              </div>
            </div>
            <div class="mb-3 position-relative">
              <label for="newPassword" class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
              <div class="input-group">
                <input type="password" class="form-control" id="newPassword">
                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordField('newPassword')">
                  <i class="fas fa-eye-slash"></i>
                </button>
              </div>
            </div>
            <div class="mb-3 position-relative">
              <label for="confirmPassword" class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
              <div class="input-group">
                <input type="password" class="form-control" id="confirmPassword">
                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordField('confirmPassword')">
                  <i class="fas fa-eye-slash"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            <button type="button" class="btn btn-primary" onclick="saveNewPassword()">X√°c nh·∫≠n</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global data variables
      let userData = {};
      let appData = {};
      let CONFIG_COLUMNS = {};
      let CONFIG_ENUM = {};
      let Max_Count_RepairID = 0;
      let TrangThai_Form = 0;
      const CONFIG_HTML = {
          FORM_STATUS: {
            ADD: 1,
            EDIT: 2,
            VIEW: 3,
            DELETE: 4
          }
      };
      
      ///////////////////////////////////
      // 1. Nh√≥m h√†m x·ª≠ l√Ω d·ªØ li·ªáu ban ƒë·∫ßu
      ///////////////////////////////////
      // Data loading
      document.addEventListener('DOMContentLoaded', function() {
        // Load data
        loadAllData();
        
        // Initialize modals
        const modalElements = document.querySelectorAll('.modal');
        modalElements.forEach(element => {
          new bootstrap.Modal(element);
          
          // Add hidden.bs.modal event listener
          element.addEventListener('hidden.bs.modal', function() {
            // Remove modal backdrop
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
              backdrop.remove();
            }
            // Remove modal-open class and styles from body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
          });
        });
      });
      // 1.1 H√†m t·∫£i d·ªØ li·ªáu
      function loadAllData() {
        console.log('Starting to load data...');

        google.script.run
          .withSuccessHandler(handleDataLoaded)
          .withFailureHandler(handleScriptError)
          .getdata();
      }

      // 1.2 H√†m x·ª≠ l√Ω d·ªØ li·ªáu sau khi t·∫£i th√†nh c√¥ng
      function handleDataLoaded(dataJSON) {
        try {
          // Parse JSON data
          const data = JSON.parse(dataJSON);
          
          // Store data in global variables
          appData = data;
          CONFIG_COLUMNS = data.CONFIG_COLUMNS;
          CONFIG_ENUM = data.CONFIG_ENUM;
          
          // Initialize UI components
          initializeUI();
          
          // Hide loading screen
          document.getElementById('loading').classList.add('hidden');
          
          // Show login form
          document.getElementById('loginSection').style.display = 'block';
        } catch (error) {
          console.error("Error parsing data:", error);
          showError("L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu: " + error.message);
        }
      }

      ///////////////////////////////////
      // 2. Nh√≥m h√†m th√¥ng b√°o
      ///////////////////////////////////

      // 2.1 H√†m th√¥ng b√°o l·ªói
      function showError(message) {
        Swal.fire({
          icon: 'error',
          title: 'L·ªói',
          text: message,
          confirmButtonText: 'ƒê√≥ng'
        });
      }

      // 2.2 H√†m th√¥ng b√°o th√†nh c√¥ng
      function showSuccess(message) {
        Swal.fire({
          icon: 'success',
          title: 'Th√†nh c√¥ng',
          html: message.replace(/\n/g, '<br>'),
          confirmButtonText: 'ƒê√≥ng'
        });
      }

      // 2.3 H√†m th√¥ng b√°o x√°c nh·∫≠n
      function showConfirm(title, message, callback) {
        // Use SweetAlert for confirmation dialogs as it's already loaded
        Swal.fire({
          icon: 'question',
          title: title,
          text: message,
          showCancelButton: true,
          confirmButtonText: 'ƒê·ªìng √Ω',
          cancelButtonText: 'H·ªßy',
          backdrop: true,
          allowOutsideClick: true
        }).then((result) => {
          if (result.isConfirmed) {
            callback();
          }
        });
      }

      // 2.4 H√†m th√¥ng b√°o ƒëang t·∫£i
      function showLoading() {
        Swal.fire({
          title: 'ƒêang x·ª≠ l√Ω',
          text: 'Vui l√≤ng ƒë·ª£i...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });
      }

      // 2.5 H√†m x·ª≠ l√Ω l·ªói script
      function handleScriptError(error) {
        Swal.close();
        showError("L·ªói: " + error.message);
      }
      
      ///////////////////////////////////
      // 3. Nh√≥m h√†m x·ª≠ l√Ω ƒëƒÉng nh·∫≠p
      ///////////////////////////////////

      // 3.1 H√†m x√°c th·ª±c ƒëƒÉng nh·∫≠p
      function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (!username || !password) {
          showError("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u");
          return;
        }
        
        // Verify credentials
        const departmentUsers = appData.val_DSUserDV;
        
        // Skip header row
        for (let i = 1; i < departmentUsers.length; i++) {
          const user = departmentUsers[i];
          const userUsername = user[CONFIG_COLUMNS.DSUserDV.username];
          const userPassword = user[CONFIG_COLUMNS.DSUserDV.pass];
          
          if (username === userUsername && password === userPassword) {
            // Store user data
            userData = {
              id: user[CONFIG_COLUMNS.DSUserDV.id],
              name: user[CONFIG_COLUMNS.DSUserDV.donvi],
              username: user[CONFIG_COLUMNS.DSUserDV.username],
              pass: user[CONFIG_COLUMNS.DSUserDV.pass],
              kihieu: user[CONFIG_COLUMNS.DSUserDV.kihieu],
              email: user[CONFIG_COLUMNS.DSUserDV.email],
              logo: user[CONFIG_COLUMNS.DSUserDV.logo]
            };
            
            // Hide login form
            document.getElementById('loginSection').style.display = 'none';
            
            // Show main app
            document.getElementById('mainApp').style.display = 'block';
            document.querySelector('.dashboard').style.display = 'block';
            
            // Setup user interface
            setupUserInterface();
            
            // Load repair data
            updateRepairTables();
            
            return;
          }
        }
        
        // Invalid credentials
        showError("T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng");
      }

      // 3.2 H√†m Hi·ªÉn th·ªã/·∫©n m·∫≠t kh·∫©u
      function togglePassword() {
        const passwordInput = document.getElementById('password');
        const toggleIcon = document.querySelector('.toggle-password');
        
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          toggleIcon.classList.remove('fa-eye-slash');
          toggleIcon.classList.add('fa-eye');
        } else {
          passwordInput.type = 'password';
          toggleIcon.classList.remove('fa-eye');
          toggleIcon.classList.add('fa-eye-slash');
        }
      }
      
      ///////////////////////////////////
      // 4. Nh√≥m h√†m x·ª≠ l√Ω giao di·ªán ng∆∞·ªùi d√πng
      ///////////////////////////////////
      // 4.1 H√†m thi·∫øt l·∫≠p giao di·ªán
      function initializeUI() {
        // Kh·ªüi t·∫°o tab cho dashboard
        // T·∫°o m·ªôt instance c·ªßa Bootstrap Tab cho tab dashboard
        const dashboardTabs = new bootstrap.Tab(document.querySelector('#tab-dashboard'));
        
        // Kh·ªüi t·∫°o tooltips (g·ª£i √Ω khi hover)
        // L·∫•y t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ c√≥ thu·ªôc t√≠nh data-bs-toggle="tooltip"
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        // Kh·ªüi t·∫°o tooltip cho t·ª´ng ph·∫ßn t·ª≠
        tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Kh·ªüi t·∫°o popovers (h·ªôp th√¥ng tin popup)
        // L·∫•y t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ c√≥ thu·ªôc t√≠nh data-bs-toggle="popover" 
        const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        // Kh·ªüi t·∫°o popover cho t·ª´ng ph·∫ßn t·ª≠
        popoverTriggerList.map(function (popoverTriggerEl) {
          return new bootstrap.Popover(popoverTriggerEl);
        });
        
        // Kh·ªüi t·∫°o modals (h·ªôp tho·∫°i)
        // L·∫•y t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ c√≥ thu·ªôc t√≠nh data-bs-toggle="modal"
        const modalTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="modal"]'));
        // Kh·ªüi t·∫°o modal cho t·ª´ng ph·∫ßn t·ª≠
        modalTriggerList.map(function (modalTriggerEl) {
          return new bootstrap.Modal(document.querySelector(modalTriggerEl.getAttribute('data-bs-target')));
        });
        
        // S·ª≠a l·ªói modal kh√¥ng cho ph√©p nh·∫≠p li·ªáu
        // Duy·ªát qua t·∫•t c·∫£ c√°c modal v√† thi·∫øt l·∫≠p focus cho input
        document.querySelectorAll('.modal').forEach(modal => {
          setupModalFocus(modal);
        });
      }

      function setupModalFocus(modal) {
        modal.addEventListener('shown.bs.modal', function() {
          // T√¨m input field ƒë·∫ßu ti√™n c√≥ th·ªÉ edit
          const firstInput = this.querySelector('input:not([readonly]):not([disabled])');
          
          // Ch·ªâ focus n·∫øu t√¨m th·∫•y input field ph√π h·ª£p
          if (firstInput) {
            firstInput.focus();
            
            // Optional: Select all text trong input
            firstInput.select();
          }
        });
      }

      // 4.2 H√†m thi·∫øt l·∫≠p giao di·ªán sau khi ƒëƒÉng nh·∫≠p
      function setupUserInterface() {
        // Set user name and avatar
        document.getElementById('userName').textContent = userData.name;
        
        // Set avatar image if available
        if (userData.logo) {
          const logoLink = "https://drive.google.com/thumbnail?id=" + userData.logo + "&sz=s100";
          document.getElementById('userAvatar').src = logoLink;
        }
        // Set department name in repair form
        document.getElementById('departmentName').value = userData.name;
        
        // Populate dropdown lists
        populateDropdowns();
        
        // Reinitialize UI components to ensure modals and other Bootstrap components work properly
        initializeUI();
      }
      
      // 4.2 H√†m Hi·ªÉn th·ªã/·∫©n menu ng∆∞·ªùi d√πng
      function toggleUserMenu() {
        const userMenu = document.getElementById('userMenu');
        if (userMenu.style.display === 'none') {
          userMenu.style.display = 'block';
        } else {
          userMenu.style.display = 'none';
        }
      }
      
      
      ///////////////////////////////////
      // 5. NH√ìM H√ÄM X·ª¨ L√ù MENU DROPDOWN NG∆Ø·ªúI D√ôNG
      ///////////////////////////////////

      ///////////////////////////////////
      // 5.1. Nh√≥m h√†m x·ª≠ l√Ω h·ªì s∆° c√° nh√¢n
      ///////////////////////////////////
      // 5.1.1. H√†m s·ª≠a h·ªì s∆° ng∆∞·ªùi d√πng
      function editUserProfile() {
        // Hide user menu
        document.getElementById('userMenu').style.display = 'none';
        
        // Fill form with current user data
        document.getElementById('profileName').value = userData.name || '';
        document.getElementById('profileEmail').value = userData.email || '';
        document.getElementById('profileLogo').value = userData.logo || '';
        
        // Show modal using Bootstrap 5 syntax
        const modalElement = document.getElementById('editProfileModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
      
      // 5.1.2. H√†m l∆∞u th√¥ng tin h·ªì s∆° ng∆∞·ªùi d√πng
      function saveProfile() {
        // Get form values
        const name = document.getElementById('profileName').value;
        const email = document.getElementById('profileEmail').value;
        const logo = document.getElementById('profileLogo').value;
        
        // Validate form
        if (!name) {
          showError("Vui l√≤ng nh·∫≠p t√™n ƒë∆°n v·ªã");
          return;
        }
        
        if (!email) {
          showError("Vui l√≤ng nh·∫≠p email");
          return;
        }
        
        // Prepare data for update
        const profileData = {
          id: userData.id,
          donvi: name,
          email: email,
          logo: logo
        };
        
        // Show loading message
        showLoading();
        
        // Send update to server
        google.script.run
          .withSuccessHandler(handleProfileUpdated)
          .withFailureHandler(handleScriptError)
          .updateUserProfile(profileData);
      }
      
      // 5.1.3. H√†m x·ª≠ l√Ω c·∫≠p nh·∫≠t th√¥ng tin h·ªì s∆° ng∆∞·ªùi d√πng th√†nh c√¥ng
      function handleProfileUpdated(result) {
        Swal.close();
        
        if (result) {
          // Update user data
          for (let i = 1; i < appData.val_DSUserDV.length; i++) {
            if (appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.id] == userData.id) {
              appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.donvi] = document.getElementById('profileName').value;
              appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.email] = document.getElementById('profileEmail').value;
              appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.logo] = document.getElementById('profileLogo').value;
              break;
            }
          }
          
          // Update userData
          userData.name = document.getElementById('profileName').value;
          userData.email = document.getElementById('profileEmail').value;
          userData.logo = document.getElementById('profileLogo').value;
          
          // Update UI
          document.getElementById('userName').textContent = userData.name;
          if (userData.logo) {
            //document.getElementById('userAvatar').src = `https://drive.google.com/thumbnail?id=${userData.logo}&sz=s100`;
          }
          
          // Close modal
          bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
          
          // Show success message
          showSuccess("C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng");
        } else {
          showError("C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t th√¥ng tin");
        }
      }
      
      ///////////////////////////////////
      // 5.2. Nh√≥m h√†m x·ª≠ l√Ω m·∫≠t kh·∫©u
      ///////////////////////////////////

      // 5.2.1. H√†m thay ƒë·ªïi m·∫≠t kh·∫©u
      function changePassword() {
        // Hide user menu
        document.getElementById('userMenu').style.display = 'none';
        
        // Clear form
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        
        // Show modal using Bootstrap 5 syntax
        const modalElement = document.getElementById('changePasswordModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
      
      // 5.2.2. H√†m hi·ªÉn th·ªã m·∫≠t kh·∫©u
      function togglePasswordField(fieldId) {
        const passwordInput = document.getElementById(fieldId);
        const toggleButton = passwordInput.nextElementSibling;
        const toggleIcon = toggleButton.querySelector('i');
        
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          toggleIcon.classList.remove('fa-eye-slash');
          toggleIcon.classList.add('fa-eye');
        } else {
          passwordInput.type = 'password';
          toggleIcon.classList.remove('fa-eye');
          toggleIcon.classList.add('fa-eye-slash');
        }
      }
      
      // 5.2.3. H√†m l∆∞u m·∫≠t kh·∫©u m·ªõi
      function saveNewPassword() {
        // Get form values
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // Validate form
        if (!currentPassword) {
          showError("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i");
          return;
        }
        
        if (!newPassword) {
          showError("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi");
          return;
        }
        
        if (!confirmPassword) {
          showError("Vui l√≤ng x√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi");
          return;
        }
        
        if (newPassword !== confirmPassword) {
          showError("M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp");
          return;
        }
        
        // Verify current password (find user in departmentUsers by userData.id)
        let currentUserPassword = '';
        for (let i = 1; i < appData.val_DSUserDV.length; i++) {
          if (appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.id] == userData.id) {
            currentUserPassword = appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.pass];
            break;
          }
        }
        
        if (currentPassword !== currentUserPassword) {
          showError("M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng");
          return;
        }
        
        // Prepare data for update
        const passwordData = {
          id: userData.id,
          newPassword: newPassword
        };
        
        showLoading();
        
        // Send update to server
        google.script.run
          .withSuccessHandler(handlePasswordUpdated)
          .withFailureHandler(handleScriptError)
          .updateUserPassword(passwordData);
      }
      
      // 5.2.4. H√†m x·ª≠ l√Ω c·∫≠p nh·∫≠t m·∫≠t kh·∫©u th√†nh c√¥ng
      function handlePasswordUpdated(result) {
        Swal.close();
        
        if (result) {
          // Update password in the cached data
          for (let i = 1; i < appData.val_DSUserDV.length; i++) {
            if (appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.id] == userData.id) {
              appData.val_DSUserDV[i][CONFIG_COLUMNS.DSUserDV.pass] = document.getElementById('newPassword').value;
              break;
            }
          }
          
          // Close modal
          bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
          
          // Show success message
          showSuccess("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng");
        } else {
          showError("C√≥ l·ªói x·∫£y ra khi ƒë·ªïi m·∫≠t kh·∫©u");
        }
      }
      
      ///////////////////////////////////
      // 5.3. Nh√≥m h√†m ƒëƒÉng xu·∫•t
      ///////////////////////////////////
      // 5.3.1 H√†m ƒêƒÉng xu·∫•t
      function logout() {
        showConfirm("ƒêƒÉng xu·∫•t", "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng?", function() {
          // Reset user data
          userData = {};
          
          // Hide main app
          document.getElementById('mainApp').style.display = 'none';
          document.querySelector('.dashboard').style.display = 'none';
          document.getElementById('userMenu').style.display = 'none';
          
          // Show login form
          document.getElementById('loginSection').style.display = 'block';
          
          // Clear login form
          document.getElementById('username').value = '';
          document.getElementById('password').value = '';
          
          // Show success message
          showSuccess("ƒêƒÉng xu·∫•t th√†nh c√¥ng!");
        });
      }
      
      ///////////////////////////////////
      // 6. Nh√≥m h√†m x·ª≠ l√Ω t√¨m ki·∫øm
      ///////////////////////////////////
      
      // 6.2. H√†m t√¨m ki·∫øm b√°o h·ªèng
      function searchRepair() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        if (!searchTerm) {
          showError("Vui l√≤ng nh·∫≠p n·ªôi dung t√¨m ki·∫øm");
          return;
        }
        
        // Filter repair tables based on search term
        filterRepairTables(searchTerm);
      }
      
      // 6.3. H√†m l·ªçc b√°o h·ªèng
      function filterRepairTables(searchTerm) {
        try {
          // Get all table rows in all tabs
          const allTables = ['history_baohong', 'history_dangsua', 'history_baohanh', 'history_suangoai'];
          const tabIds = ['tab-baohong', 'tab-dangsua', 'tab-baohanh', 'tab-suangoai'];
          const tabNames = ['B√°o h·ªèng', 'ƒêang s·ª≠a', 'B·∫£o h√†nh', 'S·ª≠a ngo√†i'];
          
          let totalMatchCount = 0;
          let matchCountPerTab = [0, 0, 0, 0];
          
          // Search in each tab and count matches
          allTables.forEach((tableId, index) => {
            const tableBody = document.getElementById(tableId);
            const rows = tableBody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
              const content = rows[i].innerText.toLowerCase();
              if (content.includes(searchTerm)) {
                rows[i].style.display = '';
                totalMatchCount++;
                matchCountPerTab[index]++;
              } else {
                rows[i].style.display = 'none';
              }
            }
            
            // Update tab name with match count
            document.getElementById(tabIds[index]).textContent = `${tabNames[index]} (${matchCountPerTab[index]})`;
          });
          
          if (totalMatchCount === 0) {
            showError("Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p");
          } else {
            // Create a detailed message with counts per tab
            let detailMessage = `T√¨m th·∫•y ${totalMatchCount} k·∫øt qu·∫£ ph√π h·ª£p:\n`;
            allTables.forEach((tableId, index) => {
              if (matchCountPerTab[index] > 0) {
                detailMessage += `- ${tabNames[index]}: ${matchCountPerTab[index]} k·∫øt qu·∫£\n`;
              }
            });
            
            showSuccess(detailMessage);
          }
        } catch (error) {
          console.error('Error filtering repair tables:', error);
          showError('L·ªói khi l·ªçc d·ªØ li·ªáu t√¨m ki·∫øm: ' + error.message);
        }
      }
      
      // 6.4. H√†m h·ªßy t√¨m ki·∫øm b√°o h·ªèng
      function cancelSearch() {
        // Clear search input
        document.getElementById('searchInput').value = '';
        
        // Reset repair tables to show all items
        updateRepairTables();
      showSuccess("ƒê√£ h·ªßy t√¨m ki·∫øm v√† hi·ªÉn th·ªã l·∫°i t·∫•t c·∫£ d·ªØ li·ªáu");
      }

      ///////////////////////////////////
      // 7. Nh√≥m h√†m x·ª≠ l√Ω hi·ªÉn th·ªã danh s√°ch s·ª≠a ch·ªØa
      ///////////////////////////////////
      // 7.1. H√†m c·∫≠p nh·∫≠t t·∫•t c·∫£ c√°c b·∫£ng b√°o h·ªèng
      function updateRepairTables() {
        const countBaoHong = updateTableBaoHong();
        const countDangSua = updateTableDangSua();
        const countBaoHanh = updateTableBaoHanh();
        const countSuaNgoai = updateTableSuaNgoai();
        
        // Calculate total count
        const totalCount = countBaoHong + countDangSua + countBaoHanh + countSuaNgoai;
        
        // Log counts to console for debugging
        console.log(`T·ªïng s·ªë: ${totalCount} | B√°o h·ªèng: ${countBaoHong} | ƒêang s·ª≠a: ${countDangSua} | B·∫£o h√†nh: ${countBaoHanh} | S·ª≠a ngo√†i: ${countSuaNgoai}`);
        
        return {
          total: totalCount,
          baoHong: countBaoHong,
          dangSua: countDangSua,
          baoHanh: countBaoHanh,
          suaNgoai: countSuaNgoai
        };
      }
      
      // 7.2. H√†m c·∫≠p nh·∫≠t b·∫£ng b√°o h·ªèng
      function updateTableBaoHong() {
        try {
          // Get table body
          const tableBody = document.getElementById('history_baohong');
          tableBody.innerHTML = '';
          
          // Counter for repair items
          let count = 0;
          
          // Process data
          appData.val_DataSC.slice(1).forEach(item => {
            // Check if this is a "b√°o h·ªèng" item for current user
            if (item[CONFIG_COLUMNS.DataSC.trangthai] == CONFIG_ENUM.TRANGTHAI.BAO_HONG && item[CONFIG_COLUMNS.DataSC.iduserdv] == userData.id) {
              count++;
              
              // Create row
              const row = document.createElement('tr');
              
              // STT cell
              const sttCell = document.createElement('td');
              sttCell.textContent = count;
              row.appendChild(sttCell);
              
              // Get equipment and repair person info
              const equipmentId = item[CONFIG_COLUMNS.DataSC.idthietbi];
              const equipment = appData.val_DSThietBi.find(eq => eq[CONFIG_COLUMNS.DSThietBi.id] === equipmentId);
              
              const repairPersonId = item[CONFIG_COLUMNS.DataSC.idusersua];
              const repairPerson = appData.val_DSUserSua.find(rp => rp[CONFIG_COLUMNS.DSUserSua.id] === repairPersonId);
              
              // Content cell
              const contentCell = document.createElement('td');
              contentCell.innerHTML = `
                üõ†Ô∏è ${item[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao]} ‚ö†Ô∏è ${item[CONFIG_COLUMNS.DataSC.id]}
                <br>- Th√¥ng tin thi·∫øt b·ªã: ‚ôüÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.tentb] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.model] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.serial] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.nuocsx] : ''}
                <br>- Th√¥ng tin ng∆∞·ªùi s·ª≠a: üë®${repairPerson ? repairPerson[CONFIG_COLUMNS.DSUserSua.hoten] : ''} 
                üìÖ${item[CONFIG_COLUMNS.DataSC.ngaydonvibao]}
              `;
              row.appendChild(contentCell);
              
              // Action cell
              const actionCell = document.createElement('td');
              actionCell.classList.add('action-buttons');
              
              // View button
              const viewBtn = document.createElement('button');
              viewBtn.classList.add('btn', 'btn-success', 'btn-sm', 'me-1');
              viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
              viewBtn.title = 'Xem chi ti·∫øt';
              viewBtn.onclick = () => viewRepair(item[CONFIG_COLUMNS.DataSC.id]);
              actionCell.appendChild(viewBtn);

              // Edit button
              const editBtn = document.createElement('button');
              editBtn.classList.add('btn', 'btn-primary', 'btn-sm', 'me-1');
              editBtn.innerHTML = '<i class="fas fa-edit"></i>';
              editBtn.title = 'Ch·ªânh s·ª≠a';
              editBtn.onclick = () => editRepair(item[CONFIG_COLUMNS.DataSC.id]);
              actionCell.appendChild(editBtn);
              
              // Delete button
              const deleteBtn = document.createElement('button');
              deleteBtn.classList.add('btn', 'btn-danger', 'btn-sm', 'me-1');
              deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
              deleteBtn.title = 'X√≥a';
              deleteBtn.onclick = () => deleteRepair(item[CONFIG_COLUMNS.DataSC.id]);
              actionCell.appendChild(deleteBtn);
              
              row.appendChild(actionCell);
              
              // Add row to table
              tableBody.appendChild(row);
            }
          });
          
          // Update tab count
          document.getElementById('tab-baohong').textContent = `B√°o h·ªèng (${count})`;
          
          // Return the count for potential use elsewhere
          return count;
        } catch (error) {
          console.error('Error updating b√°o h·ªèng table:', error);
          showError('L·ªói khi c·∫≠p nh·∫≠t b·∫£ng b√°o h·ªèng: ' + error.message);
          return 0;
        }
      }
      
      // 7.3. H√†m c·∫≠p nh·∫≠t b·∫£ng ƒëang s·ª≠a
      function updateTableDangSua() {
        try {
          // Get table body
          const tableBody = document.getElementById('history_dangsua');
          tableBody.innerHTML = '';
          
          // Counter for repair items
          let count = 0;
          
          // Process data
          appData.val_DataSC.slice(1).forEach(item => {
            // Check if this is a "ƒëang s·ª≠a" item for current user
            if (item[CONFIG_COLUMNS.DataSC.trangthai] == CONFIG_ENUM.TRANGTHAI.DANG_SUA && item[CONFIG_COLUMNS.DataSC.iduserdv] == userData.id) {
              count++;
              
              // Create row
              const row = document.createElement('tr');
              
              // STT cell
              const sttCell = document.createElement('td');
              sttCell.textContent = count;
              row.appendChild(sttCell);
              
              // Get equipment and repair person info
              const equipmentId = item[CONFIG_COLUMNS.DataSC.idthietbi];
              const equipment = appData.val_DSThietBi.find(eq => eq[CONFIG_COLUMNS.DSThietBi.id] === equipmentId);
              
              const repairPersonId = item[CONFIG_COLUMNS.DataSC.idusersua];
              const repairPerson = appData.val_DSUserSua.find(rp => rp[CONFIG_COLUMNS.DSUserSua.id] === repairPersonId);
              
              // Content cell
              const contentCell = document.createElement('td');
              contentCell.innerHTML = `
                üõ†Ô∏è ${item[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao]} ‚ö†Ô∏è ${item[CONFIG_COLUMNS.DataSC.id]}
                <br>- Th√¥ng tin thi·∫øt b·ªã: ‚ôüÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.tentb] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.model] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.serial] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.nuocsx] : ''}
                <br>- Th√¥ng tin ng∆∞·ªùi s·ª≠a: üë®${repairPerson ? repairPerson[CONFIG_COLUMNS.DSUserSua.hoten] : ''} 
                üìÖ${item[CONFIG_COLUMNS.DataSC.ngaydonvibao]}
              `;
              row.appendChild(contentCell);
              
              // Action cell
              const actionCell = document.createElement('td');
              actionCell.classList.add('action-buttons');
              
              // View button
              const viewBtn = document.createElement('button');
              viewBtn.classList.add('btn', 'btn-success', 'btn-sm', 'me-1');
              viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
              viewBtn.title = 'Xem chi ti·∫øt';
              viewBtn.onclick = () => viewRepair(item[CONFIG_COLUMNS.DataSC.id]);
              actionCell.appendChild(viewBtn);
              
              row.appendChild(actionCell);
              
              // Add row to table
              tableBody.appendChild(row);
            }
          });
          
          // Update tab count
          document.getElementById('tab-dangsua').textContent = `ƒêang s·ª≠a (${count})`;
          
          // Return the count for potential use elsewhere
          return count;
        } catch (error) {
          console.error('Error updating ƒëang s·ª≠a table:', error);
          showError('L·ªói khi c·∫≠p nh·∫≠t b·∫£ng ƒëang s·ª≠a: ' + error.message);
          return 0;
        }
      }
      
      // 7.4. H√†m c·∫≠p nh·∫≠t b·∫£ng b·∫£o h√†nh
      function updateTableBaoHanh() {
        try {
          // Get table body
          const tableBody = document.getElementById('history_baohanh');
          tableBody.innerHTML = '';
          
          // Counter for repair items
          let count = 0;
          
          // Process data
          appData.val_DataSC.slice(1).forEach(item => {
            // Check if this is a "b·∫£o h√†nh" item for current user
            if (item[CONFIG_COLUMNS.DataSC.trangthai] == CONFIG_ENUM.TRANGTHAI.BAO_HANH && item[CONFIG_COLUMNS.DataSC.iduserdv] == userData.id) {
              count++;
              
              // Create row
              const row = document.createElement('tr');
              
              // STT cell
              const sttCell = document.createElement('td');
              sttCell.textContent = count;
              row.appendChild(sttCell);
              
              // Get equipment and repair person info
              const equipmentId = item[CONFIG_COLUMNS.DataSC.idthietbi];
              const equipment = appData.val_DSThietBi.find(eq => eq[CONFIG_COLUMNS.DSThietBi.id] === equipmentId);
              
              const repairPersonId = item[CONFIG_COLUMNS.DataSC.idusersua];
              const repairPerson = appData.val_DSUserSua.find(rp => rp[CONFIG_COLUMNS.DSUserSua.id] === repairPersonId);
              
              // Content cell
              const contentCell = document.createElement('td');
              contentCell.innerHTML = `
                üõ†Ô∏è ${item[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao]} ‚ö†Ô∏è ${item[CONFIG_COLUMNS.DataSC.id]}
                <br>- Th√¥ng tin thi·∫øt b·ªã: ‚ôüÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.tentb] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.model] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.serial] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.nuocsx] : ''}
                <br>- Th√¥ng tin ng∆∞·ªùi s·ª≠a: üë®${repairPerson ? repairPerson[CONFIG_COLUMNS.DSUserSua.hoten] : ''} 
                üìÖ${item[CONFIG_COLUMNS.DataSC.ngaydonvibao]}
              `;
              row.appendChild(contentCell);
              
              // Action cell
              const actionCell = document.createElement('td');
              actionCell.classList.add('action-buttons');
              
              // View button
              const viewBtn = document.createElement('button');
              viewBtn.classList.add('btn', 'btn-success', 'btn-sm', 'me-1');
              viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
              viewBtn.title = 'Xem chi ti·∫øt';
              viewBtn.onclick = () => viewRepair(item[CONFIG_COLUMNS.DataSC.id]);
              actionCell.appendChild(viewBtn);
              
              row.appendChild(actionCell);
              
              // Add row to table
              tableBody.appendChild(row);
            }
          });
          
          // Update tab count
          document.getElementById('tab-baohanh').textContent = `B·∫£o h√†nh (${count})`;
          
          // Return the count for potential use elsewhere
          return count;
        } catch (error) {
          console.error('Error updating b·∫£o h√†nh table:', error);
          showError('L·ªói khi c·∫≠p nh·∫≠t b·∫£ng b·∫£o h√†nh: ' + error.message);
          return 0;
        }
      }
      
      // 7.5. H√†m c·∫≠p nh·∫≠t b·∫£ng s·ª≠a ngo√†i
      function updateTableSuaNgoai() {
        try {
          // Get table body
          const tableBody = document.getElementById('history_suangoai');
          tableBody.innerHTML = '';
          
          // Counter for repair items
          let count = 0;
          
          // Process data
          appData.val_DataSC.slice(1).forEach(item => {
            // Check if this is a "s·ª≠a ngo√†i" item for current user
            if (item[CONFIG_COLUMNS.DataSC.trangthai] == CONFIG_ENUM.TRANGTHAI.SUA_NGOAI && item[CONFIG_COLUMNS.DataSC.iduserdv] == userData.id) {
              count++;
              
              // Create row
              const row = document.createElement('tr');
              
              // STT cell
              const sttCell = document.createElement('td');
              sttCell.textContent = count;
              row.appendChild(sttCell);
              
              // Get equipment and repair person info
              const equipmentId = item[CONFIG_COLUMNS.DataSC.idthietbi];
              const equipment = appData.val_DSThietBi.find(eq => eq[CONFIG_COLUMNS.DSThietBi.id] === equipmentId);
              
              const repairPersonId = item[CONFIG_COLUMNS.DataSC.idusersua];
              const repairPerson = appData.val_DSUserSua.find(rp => rp[CONFIG_COLUMNS.DSUserSua.id] === repairPersonId);
              
              // Content cell
              const contentCell = document.createElement('td');
              contentCell.innerHTML = `
                üõ†Ô∏è ${item[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao]} ‚ö†Ô∏è ${item[CONFIG_COLUMNS.DataSC.id]}
                <br>- Th√¥ng tin thi·∫øt b·ªã: ‚ôüÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.tentb] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.model] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.serial] : ''} 
                ‚öôÔ∏è${equipment ? equipment[CONFIG_COLUMNS.DSThietBi.nuocsx] : ''}
                <br>- Th√¥ng tin ng∆∞·ªùi s·ª≠a: üë®${repairPerson ? repairPerson[CONFIG_COLUMNS.DSUserSua.hoten] : ''} 
                üìÖ${item[CONFIG_COLUMNS.DataSC.ngaydonvibao]}
              `;
              row.appendChild(contentCell);
              
              // Action cell
              const actionCell = document.createElement('td');
              actionCell.classList.add('action-buttons');
              
              // View button
              const viewBtn = document.createElement('button');
              viewBtn.classList.add('btn', 'btn-success', 'btn-sm', 'me-1');
              viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
              viewBtn.title = 'Xem chi ti·∫øt';
              viewBtn.onclick = () => viewRepair(item[CONFIG_COLUMNS.DataSC.id]);
              actionCell.appendChild(viewBtn);
              
              row.appendChild(actionCell);
              
              // Add row to table
              tableBody.appendChild(row);
            }
          });
          
          // Update tab count
          document.getElementById('tab-suangoai').textContent = `S·ª≠a ngo√†i (${count})`;
          
          // Return the count for potential use elsewhere
          return count;
        } catch (error) {
          console.error('Error updating s·ª≠a ngo√†i table:', error);
          showError('L·ªói khi c·∫≠p nh·∫≠t b·∫£ng s·ª≠a ngo√†i: ' + error.message);
          return 0;
        }
      }
      
      ///////////////////////////////////
      // 8. NH√ìM H√ÄM X·ª¨ L√ù FORM D·ªÆ LI·ªÜU (TH√äM, S·ª¨A, X√ìA)
      ///////////////////////////////////

      // 8.1. H√†m t·∫°o ID s·ª≠a ch·ªØa
      function generateRepairID() {
        const Time_now = new Date();
        
        // T√¨m Max_Count_RepairID
        if (Max_Count_RepairID == 0) {
          // L·ªçc d·ªØ li·ªáu theo ƒë∆°n v·ªã
          let userDeptRepairs = [];
          if (appData.val_DataSC && appData.val_DataSC.length > 0 && userData.id) {
              userDeptRepairs = appData.val_DataSC.filter(function(row) {
                  return row[CONFIG_COLUMNS.DataSC.iduserdv] === userData.id;
              });
          }
          
          // L·ªçc l·∫•y gi√° tr·ªã v√† t√¨m s·ªë l·ªõn nh·∫•t trong c·ªôt ID
          if (userDeptRepairs.length > 0) {
                const sequenceNumbers = userDeptRepairs
                    .map(row => {
                        const parts = row[CONFIG_COLUMNS.DataSC.id]?.split('.');
                        // Check if ID has correct format and year matches current year
                        if (parts?.length === 4) {
                            const currentYear = Time_now.getFullYear().toString().slice(-2);
                            const idYear = parts[2].slice(0, 2);
                            return idYear === currentYear ? parseInt(parts[3], 10) : 0;
                        }
                        return 0;
                    })
                    .filter(num => !isNaN(num));
              
              // Find the maximum sequence number
              if (sequenceNumbers.length > 0) {
                      Max_Count_RepairID = Math.max(...sequenceNumbers);
                  }
              }
        }

        const sequenceNumber = ("000" + (Max_Count_RepairID + 1)).slice(-3);
        console.log('Formatted sequence number:', sequenceNumber);

        // L·∫•y th·ªùi gian hi·ªán t·∫°i theo ƒë·ªãnh d·∫°ng yymmdd
        const year = Time_now.getFullYear().toString().slice(-2);
        const month = ("0" + (Time_now.getMonth() + 1)).slice(-2);
        const day = ("0" + Time_now.getDate()).slice(-2);
        const datePart = year + month + day;
        console.log('Generated date part:', datePart);
        
        // T·∫°o ID s·ª≠a ch·ªØa  
        const repairID = "SC." + userData.kihieu + "." + datePart + "." + sequenceNumber;
        console.log('Generated repair ID:', repairID);
        
        return repairID;
      }
      
      // 8.2. H√†m ƒëi·ªÅn d·ªØ li·ªáu cho c√°c dropdown list: Ng∆∞·ªùi s·ª≠a ch·ªØa, Nh√≥m thi·∫øt b·ªã, M·ª©c ƒë·ªô ∆∞u ti√™n
      function populateDropdowns() {
        // Populate repair persons dropdown
        const repairPersonSelect = document.getElementById('repairPerson');
        repairPersonSelect.innerHTML = '<option value="">-- Ch·ªçn ng∆∞·ªùi s·ª≠a ch·ªØa --</option>';
        
        const repairPersons = appData.val_DSUserSua;
        for (let i = 1; i < repairPersons.length; i++) {
          const person = repairPersons[i];
          const option = document.createElement('option');
          option.value = person[CONFIG_COLUMNS.DSUserSua.id];
          option.textContent = person[CONFIG_COLUMNS.DSUserSua.hoten];
          repairPersonSelect.appendChild(option);
        }
        
        // Populate equipment groups dropdown (Nh√≥m thi·∫øt b·ªã)
        const equipmentGroupSelect = document.getElementById('equipmentGroup');
        equipmentGroupSelect.innerHTML = '<option value="">-- Ch·ªçn nh√≥m thi·∫øt b·ªã --</option>';
        // L·ªçc thi·∫øt b·ªã thu·ªôc ƒë∆°n v·ªã hi·ªán t·∫°i
        const equipment = appData.val_DSThietBi;
        const departmentEquipment = equipment.filter(item => 
          item[CONFIG_COLUMNS.DSThietBi.donvi] == userData.id // Theo c·ªôt "ƒê∆°n v·ªã_TB"
        );

        // T·∫°o Set ƒë·ªÉ l∆∞u c√°c nh√≥m thi·∫øt b·ªã kh√¥ng tr√πng l·∫∑p c·ªßa ƒë∆°n v·ªã
        const departmentGroups = new Set();
        departmentEquipment.forEach(item => {
          if (item[CONFIG_COLUMNS.DSThietBi.nhomtb]) {
            departmentGroups.add(item[CONFIG_COLUMNS.DSThietBi.nhomtb]);
          }
        });
        
        // L·ªçc danh s√°ch nh√≥m thi·∫øt b·ªã ch·ªâ l·∫•y c√°c nh√≥m c·ªßa ƒë∆°n v·ªã hi·ªán t·∫°i
        const equipmentGroups = appData.val_DSNhomTB;
        for (let i = 1; i < equipmentGroups.length; i++) {
          const group = equipmentGroups[i];
          const groupName = group[CONFIG_COLUMNS.DSNhomTB.nhomtb];
          const groupID = group[CONFIG_COLUMNS.DSNhomTB.id];
          // Ch·ªâ th√™m nh√≥m thi·∫øt b·ªã n·∫øu ƒë∆°n v·ªã hi·ªán t·∫°i c√≥ thi·∫øt b·ªã thu·ªôc nh√≥m ƒë√≥
          if (departmentGroups.has(groupID)) {
            const option = document.createElement('option');
            option.value = groupID;
            option.textContent = groupName;
            equipmentGroupSelect.appendChild(option);
          }
        }
        
        // Populate priority levels dropdown (M·ª©c ƒë·ªô ∆∞u ti√™n)
        const prioritySelect = document.getElementById('priorityLevel');
        prioritySelect.innerHTML = '<option value="">-- Ch·ªçn m·ª©c ƒë·ªô ∆∞u ti√™n --</option>';
        
        const enumSettings = appData.val_EnumSetting;
        const priorities = enumSettings.filter(item => item[1] === "M·ª©c ƒë·ªô YC");
        
        for (let i = 0; i < priorities.length; i++) {
          const priority = priorities[i];
          const option = document.createElement('option');
          option.value = priority[0]; // ID
          option.textContent = priority[2]; // T√™n m·ª©c ƒë·ªô
          prioritySelect.appendChild(option);
        }
        
        // Populate requester lists with previous requesters for this department (Danh s√°ch ng∆∞·ªùi y√™u c·∫ßu tr∆∞·ªõc ƒë√¢y)
        const repairs = appData.val_DataSC;
        const departmentRepairs = repairs.filter(item => 
          item[CONFIG_COLUMNS.DataSC.iduserdv] == userData.id
        );
        
        const requesters = new Set();
        const phones = new Set();
        departmentRepairs.forEach(repair => {
          if (repair[CONFIG_COLUMNS.DataSC.hoten]) {
            requesters.add(repair[CONFIG_COLUMNS.DataSC.hoten]);
          }
          if (repair[CONFIG_COLUMNS.DataSC.sdt]) {
            phones.add(repair[CONFIG_COLUMNS.DataSC.sdt]);
          }
        });
        
        // Danh s√°ch ng∆∞·ªùi y√™u c·∫ßu
        const requesterList = document.getElementById('requesterList');
        requesters.forEach(requester => {
          const option = document.createElement('option');
          option.value = requester;
          requesterList.appendChild(option);
        });
        
        // Danh s√°ch s·ªë ƒëi·ªán tho·∫°i
        const phoneList = document.getElementById('phoneList');
        phones.forEach(phone => {
          const option = document.createElement('option');
          option.value = phone;
          phoneList.appendChild(option);
        });
        
        // Populate equipment status datalist (Danh s√°ch t√¨nh tr·∫°ng thi·∫øt b·ªã)
        const statusList = document.getElementById('statusList');
        statusList.innerHTML = '';
        
        const statuses = new Set();
        departmentRepairs.forEach(repair => {
          if (repair[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao]) {
            statuses.add(repair[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao]);
          }
        });
        
        statuses.forEach(status => {
          const option = document.createElement('option');
          option.value = status;
          statusList.appendChild(option);
        });
      }

      // 8.3. H√†m c·∫≠p nh·∫≠t s·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi s·ª≠a ch·ªØa khi ng∆∞·ªùi s·ª≠a ch·ªØa thay ƒë·ªïi
      function updateRepairPersonPhone() {
        const repairPersonId = document.getElementById('repairPerson').value;
        if (!repairPersonId) {
          document.getElementById('repairPersonPhone').value = '';
          return;
        }
        
        const repairPersons = appData.val_DSUserSua;
        for (let i = 1; i < repairPersons.length; i++) {
          const person = repairPersons[i];
          if (person[CONFIG_COLUMNS.DSUserSua.id] === repairPersonId) {
            document.getElementById('repairPersonPhone').value = person[CONFIG_COLUMNS.DSUserSua.sdt] || '';
            break;
          }
        }
      }
      
      // 8.4. H√†m c·∫≠p nh·∫≠t danh s√°ch thi·∫øt b·ªã khi nh√≥m thi·∫øt b·ªã thay ƒë·ªïi
      function updateEquipmentList() {
        // L·∫•y gi√° tr·ªã nh√≥m thi·∫øt b·ªã ƒë√£ ch·ªçn t·ª´ ph·∫ßn t·ª≠ c√≥ id 'equipmentGroup'
        const selectedGroup = document.getElementById('equipmentGroup').value;
        // L·∫•y ph·∫ßn t·ª≠ select c√≥ id 'equipmentId' ƒë·ªÉ hi·ªÉn th·ªã danh s√°ch thi·∫øt b·ªã
        const equipmentSelect = document.getElementById('equipmentId');
        
        // ƒê·∫∑t l·∫°i n·ªôi dung HTML c·ªßa ph·∫ßn t·ª≠ select v·ªõi m·ªôt option m·∫∑c ƒë·ªãnh
        equipmentSelect.innerHTML = '<option value="">-- Ch·ªçn thi·∫øt b·ªã --</option>';
        
        // N·∫øu kh√¥ng c√≥ nh√≥m thi·∫øt b·ªã n√†o ƒë∆∞·ª£c ch·ªçn, tho√°t kh·ªèi h√†m
        if (!selectedGroup) {
          return;
        }
        
        // L·∫•y d·ªØ li·ªáu danh s√°ch thi·∫øt b·ªã t·ª´ appData
        const equipment = appData.val_DSThietBi;
        
        // L·ªçc danh s√°ch thi·∫øt b·ªã theo nh√≥m thi·∫øt b·ªã ƒë√£ ch·ªçn V√Ä theo ƒë∆°n v·ªã hi·ªán t·∫°i
        const filteredEquipment = equipment.filter(item => 
          item[CONFIG_COLUMNS.DSThietBi.nhomtb] === selectedGroup && 
          item[CONFIG_COLUMNS.DSThietBi.donvi] == userData.id
        );
        
        // Duy·ªát qua danh s√°ch thi·∫øt b·ªã ƒë√£ l·ªçc
        for (let i = 0; i < filteredEquipment.length; i++) {
          const item = filteredEquipment[i];
          // T·∫°o ph·∫ßn t·ª≠ option m·ªõi
          const option = document.createElement('option');
          // ƒê·∫∑t gi√° tr·ªã cho option l√† id c·ªßa thi·∫øt b·ªã
          option.value = item[CONFIG_COLUMNS.DSThietBi.id];
          option.textContent = item[CONFIG_COLUMNS.DSThietBi.mathietbi] + ' - ' + item[CONFIG_COLUMNS.DSThietBi.tentb];
          equipmentSelect.appendChild(option);
        }
        
          // X√≥a t·∫•t c·∫£ c√°c tr∆∞·ªùng th√¥ng tin thi·∫øt b·ªã
          document.getElementById('equipmentName').value = '';
          document.getElementById('equipmentModel').value = '';
          document.getElementById('equipmentSerial').value = '';
          document.getElementById('equipmentManufacturer').value = '';
          document.getElementById('equipmentCountry').value = '';
          document.getElementById('equipmentYear').value = '';
          document.getElementById('equipmentUseYear').value = '';
          document.getElementById('equipmentWarranty').value = '';
          document.getElementById('equipmentLocation').value = '';
      }
      
      // 8.5. H√†m c·∫≠p nh·∫≠t chi ti·∫øt thi·∫øt b·ªã khi thi·∫øt b·ªã thay ƒë·ªïi
      function updateEquipmentDetails() {
        const equipmentId = document.getElementById('equipmentId').value;
        
        // Clear equipment fields
        document.getElementById('equipmentName').value = '';
        document.getElementById('equipmentModel').value = '';
        document.getElementById('equipmentSerial').value = '';
        document.getElementById('equipmentManufacturer').value = '';
        document.getElementById('equipmentCountry').value = '';
        document.getElementById('equipmentYear').value = '';
        document.getElementById('equipmentUseYear').value = '';
        document.getElementById('equipmentWarranty').value = '';
        document.getElementById('equipmentLocation').value = '';
        
        if (!equipmentId) {
          return;
        }
        
        const equipment = appData.val_DSThietBi;
        for (let i = 1; i < equipment.length; i++) {
          const item = equipment[i];
          if (item[CONFIG_COLUMNS.DSThietBi.id] === equipmentId) {
            document.getElementById('equipmentName').value = item[CONFIG_COLUMNS.DSThietBi.tentb] || '';
            document.getElementById('equipmentModel').value = item[CONFIG_COLUMNS.DSThietBi.model] || '';
            document.getElementById('equipmentSerial').value = item[CONFIG_COLUMNS.DSThietBi.serial] || '';
            document.getElementById('equipmentManufacturer').value = item[CONFIG_COLUMNS.DSThietBi.hangsx] || '';
            document.getElementById('equipmentCountry').value = item[CONFIG_COLUMNS.DSThietBi.nuocsx] || '';
            document.getElementById('equipmentYear').value = item[CONFIG_COLUMNS.DSThietBi.namsx] || '';
            document.getElementById('equipmentUseYear').value = item[CONFIG_COLUMNS.DSThietBi.namsd] || '';
            document.getElementById('equipmentWarranty').value = item[CONFIG_COLUMNS.DSThietBi.hanbaohanh] || '';
            document.getElementById('equipmentLocation').value = item[CONFIG_COLUMNS.DSThietBi.vitridat] || '';
            break;
          }
        }
      }

      // 8.6. H√†m l∆∞u d·ªØ li·ªáu b√°o h·ªèng
      function saveRepair() {
        // Validate form
        const repairDataForm = {
            id_repair: document.getElementById('repairId').value, //ID b√°o h·ªèng
            Name_NguoiYeuCau: document.getElementById('requesterName').value, //Ng∆∞·ªùi y√™u c·∫ßu
            SDT_NguoiYeuCau: document.getElementById('requesterPhone').value, //S·ªë ƒëi·ªán tho·∫°i y√™u c·∫ßu
            ID_NguoiSua: document.getElementById('repairPerson').value, //Ng∆∞·ªùi s·ª≠a ch·ªØa
            ID_ThietBi: document.getElementById('equipmentId').value, //Thi·∫øt b·ªã
            TinhTrang_ThietBi: document.getElementById('equipmentStatus').value, //T√¨nh tr·∫°ng thi·∫øt b·ªã
            ID_MucDo_YeuCau: document.getElementById('priorityLevel').value, //M·ª©c ƒë·ªô ∆∞u ti√™n
            GhiChu_repair: document.getElementById('notes').value,
            trangThai_repair: CONFIG_ENUM.TRANGTHAI.BAO_HONG,
            timeupdate: new Date().toLocaleString('vi-VN', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: false
            })
        };

        //Ki·ªÉm tra d·ªØ li·ªáu
        if (!repairDataForm.Name_NguoiYeuCau) {
          showError("Vui l√≤ng nh·∫≠p ng∆∞·ªùi y√™u c·∫ßu");
          return;
        }
        
        if (!repairDataForm.SDT_NguoiYeuCau) {
          showError("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i y√™u c·∫ßu");
          return;
        }
        
        if (!repairDataForm.TinhTrang_ThietBi) {
          showError("Vui l√≤ng nh·∫≠p t√¨nh tr·∫°ng thi·∫øt b·ªã");
          return;
        }
        
        if (!repairDataForm.ID_ThietBi) {
          showError("Vui l√≤ng ch·ªçn thi·∫øt b·ªã");
          return;
        }
        
        if (!repairDataForm.ID_MucDo_YeuCau) {
          showError("Vui l√≤ng ch·ªçn m·ª©c ƒë·ªô ∆∞u ti√™n");
          return;
        }
        
        //D·ªØ li·ªáu m·∫£ng ƒë·ªÉ ghi v√†o Main_SC
        console.log('Processing repair form data:', repairDataForm);

        const arr_repairDataMain = arr_MainSC_prepare(repairDataForm);
        console.log('Prepared main repair data:', arr_repairDataMain);

        // Text Telegram
        const textTelegram = textTelegram_prepare(repairDataForm);
        console.log('Prepared Telegram text:', textTelegram);

        // ID Telegram ng∆∞·ªùi s·ª≠a ch·ªØa
        const idTelegram_UserRepair = appData.val_DSUserSua.find(item => item[CONFIG_COLUMNS.DSUserSua.id] === repairDataForm.ID_NguoiSua)?.[CONFIG_COLUMNS.DSUserSua.usetele] || '';
        console.log('Prepared Telegram ID:', idTelegram_UserRepair);

        // Prepare data for saving
        const repairData = {
          TrangThai_Form: TrangThai_Form,
          arr_repairDataMain: arr_repairDataMain,
          idTelegram_UserRepair: idTelegram_UserRepair,
          textTelegram: textTelegram
        };
        
        // Log repair data to console for debugging
        console.log('Repair data being submitted:', repairData);
        
        // Show loading message
        showLoading();
          console.log('TrangThai_Form:', TrangThai_Form);
          if (TrangThai_Form === CONFIG_HTML.FORM_STATUS.ADD) {
            // Add new repair
            google.script.run
              .withSuccessHandler(handleAddRepair)
              .withFailureHandler(handleScriptError)
              .SC_thembaohong(repairData);
          }
      }
      
      // 8.7. H√†m chu·∫©n b·ªã d·ªØ li·ªáu cho m·∫£ng Main_SC
      function arr_MainSC_prepare(repairDataForm) {
        // Get current date time
        const currentDateTime = repairDataForm.timeupdate;

        // Initialize empty array with correct length based on CONFIG_COLUMNS
        const newRow = Array(appData.val_DataSC[0].length).fill(""); // Initialize with empty values matching the width of val_DataSC

        // Set values for required fields
        newRow[CONFIG_COLUMNS.DataSC.id] = repairDataForm.id_repair;
        newRow[CONFIG_COLUMNS.DataSC.trangthai] = repairDataForm.trangThai_repair;
        newRow[CONFIG_COLUMNS.DataSC.mucdo] = repairDataForm.ID_MucDo_YeuCau;
        newRow[CONFIG_COLUMNS.DataSC.iduserdv] = userData.id; // From global userData
        newRow[CONFIG_COLUMNS.DataSC.idusersua] = repairDataForm.ID_NguoiSua;
        newRow[CONFIG_COLUMNS.DataSC.idthietbi] = repairDataForm.ID_ThietBi;
        newRow[CONFIG_COLUMNS.DataSC.tinhtrangtbdvbao] = repairDataForm.TinhTrang_ThietBi;
        newRow[CONFIG_COLUMNS.DataSC.ngaydonvibao] = currentDateTime;
        newRow[CONFIG_COLUMNS.DataSC.ghichu] = repairDataForm.GhiChu_repair;
        newRow[CONFIG_COLUMNS.DataSC.hoten] = repairDataForm.Name_NguoiYeuCau;
        newRow[CONFIG_COLUMNS.DataSC.sdt] = repairDataForm.SDT_NguoiYeuCau;
        
        // Create history entry with optional ghi ch√∫
        let historyEntry = `* Ng√†y ${currentDateTime}   - ${repairDataForm.Name_NguoiYeuCau}: B√°o h·ªèng`;
        if (repairDataForm.GhiChu_repair && repairDataForm.GhiChu_repair.trim() !== '') {
            historyEntry += `\n   - Ghi ch√∫: ${repairDataForm.GhiChu_repair}`;
        }
        newRow[CONFIG_COLUMNS.DataSC.history] = historyEntry;
        newRow[CONFIG_COLUMNS.DataSC.timeupdate] = currentDateTime;
        return newRow;
      }
      
      // 8.8. H√†m chu·∫©n b·ªã d·ªØ li·ªáu cho text Telegram
      function textTelegram_prepare(repairDataForm) {
        // L·∫•y th√¥ng tin thi·∫øt b·ªã t·ª´ appData
        const thietbi = appData.val_DSThietBi.find(item => 
            item[CONFIG_COLUMNS.DSThietBi.id] === repairDataForm.ID_ThietBi
        );
        
        // L·∫•y th√¥ng tin m·ª©c ƒë·ªô ∆∞u ti√™n
        const mucdo = appData.val_EnumSetting.find(item => 
            item[0] === repairDataForm.ID_MucDo_YeuCau && item[1] === "M·ª©c ƒë·ªô YC"
        );
        
        // L·∫•y th√¥ng tin ng∆∞·ªùi s·ª≠a
        const nguoisua = appData.val_DSUserSua.find(item =>
            item[CONFIG_COLUMNS.DSUserSua.id] === repairDataForm.ID_NguoiSua
        );

        // Chu·∫©n b·ªã c√°c gi√° tr·ªã cho message
        const thietbiInfo = {
            ten: thietbi ? thietbi[CONFIG_COLUMNS.DSThietBi.tentb] : 'Kh√¥ng x√°c ƒë·ªãnh',
            model: thietbi ? thietbi[CONFIG_COLUMNS.DSThietBi.model] : 'Kh√¥ng x√°c ƒë·ªãnh',
            serial: thietbi ? thietbi[CONFIG_COLUMNS.DSThietBi.serial] : 'Kh√¥ng x√°c ƒë·ªãnh'
        };

        const mucdoText = mucdo ? mucdo[2] : 'Kh√¥ng x√°c ƒë·ªãnh';
        const nguoisuaText = nguoisua ? nguoisua[CONFIG_COLUMNS.DSUserSua.hoten] : '';

        // Format message with emojis and proper formatting
        const message = `üîî *B√ÅO H·ªéNG THI·∫æT B·ªä M·ªöI* üîî
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üÜî *ID:* ${repairDataForm.id_repair}
üè• *ƒê∆°n v·ªã b√°o h·ªèng:* ${userData.name}
üîß *Thi·∫øt b·ªã:* ${thietbiInfo.ten}
üìã *Model:* ${thietbiInfo.model}
üî¢ *Serial:* ${thietbiInfo.serial}
‚ö†Ô∏è *T√¨nh tr·∫°ng:* ${repairDataForm.TinhTrang_ThietBi}
‚è±Ô∏è *M·ª©c ƒë·ªô ∆∞u ti√™n:* ${mucdoText}
üë§ *Ng∆∞·ªùi y√™u c·∫ßu:* ${repairDataForm.Name_NguoiYeuCau} (${repairDataForm.SDT_NguoiYeuCau})
${nguoisuaText ? `üë®‚Äçüîß *Ng∆∞·ªùi ph·ª• tr√°ch:* ${nguoisuaText}` : ""}`;

        return message;
      }

      // 8.7. H√†m x·ª≠ l√Ω th√™m b√°o h·ªèng th√†nh c√¥ng
      function handleAddRepair(result) {
        try {
          Swal.close();
          
          if (result) {
            // Close modal and remove backdrop properly
            const modalElement = document.getElementById('FormRepairModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
              modal.hide();
              // Remove modal backdrop
              const backdrop = document.querySelector('.modal-backdrop');
              if (backdrop) {
                backdrop.remove();
              }
              // Remove modal-open class from body
              document.body.classList.remove('modal-open');
              document.body.style.overflow = '';
              document.body.style.paddingRight = '';
            }

            // Update appData with new repair data
            appData.val_DataSC.push(result);
            
            // C·∫≠p nh·∫≠t Max_Count_RepairID
            Max_Count_RepairID = Max_Count_RepairID + 1;
            if (Max_Count_RepairID > 999) {
              Max_Count_RepairID = 0;
            }
            // Refresh repair tables to show new data
            updateRepairTables();
            
            // Show success message
            showSuccess("Th√™m b√°o h·ªèng th√†nh c√¥ng");
          } else {
            showError("C√≥ l·ªói x·∫£y ra khi th√™m b√°o h·ªèng");
          }
        } catch (error) {
          console.error("Error in handleSaveRepair:", error);
          showError("C√≥ l·ªói x·∫£y ra: " + error.message);
        }
      }
      
      // 8.9. H√†m hi·ªÉn th·ªã modal th√™m b√°o h·ªèng
      function showAddRepairModal() {
        console.log('showAddRepairModal function called');
        TrangThai_Form = CONFIG_HTML.FORM_STATUS.ADD;
        // Reset form
        document.getElementById('repairId').value = generateRepairID();
        document.getElementById('equipmentId').innerHTML = '<option value="">-- Ch·ªçn thi·∫øt b·ªã --</option>';
        document.getElementById('equipmentName').value = '';
        document.getElementById('equipmentModel').value = '';
        document.getElementById('equipmentSerial').value = '';
        document.getElementById('equipmentManufacturer').value = '';
        document.getElementById('equipmentCountry').value = '';
        document.getElementById('equipmentYear').value = '';
        document.getElementById('equipmentUseYear').value = '';
        document.getElementById('equipmentWarranty').value = '';
        document.getElementById('equipmentLocation').value = '';
        document.getElementById('equipmentStatus').value = '';
        document.getElementById('priorityLevel').selectedIndex = 0;
        document.getElementById('notes').value = '';
        
        // Show modal using Bootstrap 5 syntax
        const modalElement = document.getElementById('FormRepairModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }

      // 8.10. H√†m hi·ªÉn th·ªã modal s·ª≠a b√°o h·ªèng
      function editRepair(repairId) {
        TrangThai_Form = CONFIG_HTML.FORM_STATUS.EDIT;
      }
      
      // 8.11. H√†m hi·ªÉn th·ªã modal xem chi ti·∫øt b√°o h·ªèng
      function viewRepair(repairId) {
        TrangThai_Form = CONFIG_HTML.FORM_STATUS.VIEW;
      }
      
      // 8.12. H√†m x√≥a b√°o h·ªèng
      function deleteRepair(repairId) {
        TrangThai_Form = CONFIG_HTML.FORM_STATUS.DELETE;
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√°o h·ªèng n√†y?')) {
          google.script.run
            .withSuccessHandler(function(result) {
              if (result) {
                loadAllData();
                alert('X√≥a b√°o h·ªèng th√†nh c√¥ng');
              } else {
                alert('C√≥ l·ªói x·∫£y ra khi x√≥a b√°o h·ªèng');
              }
            })
            .withFailureHandler(handleScriptError)
            .SC_delete(repairId);
        }
      }
    </script>
  </body>
</html> 
</html> 