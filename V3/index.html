<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phần mềm quản lý sửa chữa - Bệnh viện Đa khoa Bắc Giang</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.css">
  <style>
    /* Global Styles */
    :root {
      --primary-color: #0d6efd;
      --secondary-color: #6c757d;
      --success-color: #198754;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #0dcaf0;
      --light-color: #f8f9fa;
      --dark-color: #212529;
    }
    
    body {
      background-color: #f5f5f5;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
    }
    
    /* Loading Screen - Cải thiện màn hình loading */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(255, 255, 255, 0.95);
      z-index: 9999;
      transition: opacity 0.5s, visibility 0.5s;
    }
    
    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(13, 110, 253, 0.2);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .loading-message {
      margin-top: 15px;
      font-size: 20px;
      color: var(--primary-color);
      font-weight: 600;
      text-align: center;
      max-width: 80%;
    }
    
    .loading-error {
      margin-top: 20px;
      text-align: center;
    }
    
    .loading-progress {
      width: 250px;
      margin-top: 20px;
    }
    
    .progress {
      height: 10px;
      background-color: rgba(13, 110, 253, 0.1);
      border-radius: 5px;
      overflow: hidden;
    }
    
    .progress-bar {
      transition: width 0.3s ease;
    }
    
    /* Card and Table Styles */
    .card {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 0.5rem;
      border: none;
      margin-bottom: 1.5rem;
    }
    
    .card-header {
      border-top-left-radius: 0.5rem !important;
      border-top-right-radius: 0.5rem !important;
      font-weight: 600;
    }
    
    .table {
      margin-bottom: 0;
    }
    
    .table th {
      background-color: #f8f9fa;
      font-weight: 600;
      vertical-align: middle;
    }
    
    .table td {
      vertical-align: middle;
      padding: 0.75rem;
    }
    
    /* Button Styles */
    .btn {
      border-radius: 0.25rem;
      font-weight: 500;
      padding: 0.375rem 0.75rem;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
      background-color: #0b5ed7;
      border-color: #0a58ca;
    }
    
    .btn-secondary {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }
    
    .btn-success {
      background-color: var(--success-color);
      border-color: var(--success-color);
    }
    
    .btn-danger {
      background-color: var(--danger-color);
      border-color: var(--danger-color);
    }
    
    .btn-warning {
      background-color: var(--warning-color);
      border-color: var(--warning-color);
    }
    
    .btn-info {
      background-color: var(--info-color);
      border-color: var(--info-color);
    }
    
    /* Form Styles */
    .form-control, .form-select {
      padding: 0.375rem 0.75rem;
      font-size: 1rem;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: #86b7fe;
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .input-group-text {
      background-color: #f8f9fa;
      border: 1px solid #ced4da;
    }
    
    /* Modal Styles */
    .modal-content {
      border-radius: 0.5rem;
      border: none;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
      padding: 1rem;
    }
    
    .modal-footer {
      border-bottom-left-radius: 0.5rem;
      border-bottom-right-radius: 0.5rem;
      padding: 1rem;
    }
    
    /* Navigation Tabs */
    .nav-pills .nav-link {
      color: #495057;
      background-color: #f8f9fa;
      border-radius: 0.25rem;
      margin-right: 0.25rem;
      margin-bottom: 0.25rem;
      padding: 0.5rem 1rem;
      font-weight: 500;
    }
    
    .nav-pills .nav-link.active {
      background-color: var(--primary-color);
      color: #fff;
    }
    
    /* Table Action Buttons */
    .action-btn {
      padding: 0.25rem 0.5rem;
      margin: 0.125rem;
      font-size: 0.875rem;
    }
    
    .action-btn i {
      margin-right: 0.25rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .card-header h5 {
        font-size: 1.1rem;
      }
      
      .action-btn {
        padding: 0.2rem 0.4rem;
        font-size: 0.8rem;
      }
      
      .action-btn i {
        margin-right: 0;
      }
      
      .action-btn span {
        display: none;
      }
      
      .table th, .table td {
        padding: 0.5rem;
      }
      
      .navbar-brand span {
        font-size: 0.9rem;
      }
    }
    
    /* Custom repair status styles */
    .repair-content {
      white-space: pre-line;
      line-height: 1.5;
    }
    
    .repair-id {
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .repair-status {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.875rem;
      font-weight: 500;
      margin-right: 0.5rem;
    }
    
    .repair-status-baohong {
      background-color: var(--danger-color);
      color: white;
    }
    
    .repair-status-dangsua {
      background-color: var(--warning-color);
      color: black;
    }
    
    .repair-status-baohanh {
      background-color: var(--info-color);
      color: white;
    }
    
    .repair-status-suangoai {
      background-color: var(--secondary-color);
      color: white;
    }
    
    /* Toggle password visibility */
    .toggle-password {
      cursor: pointer;
    }
    
    .toggle-password i {
      opacity: 0.6;
    }
    
    .toggle-password:hover i {
      opacity: 1;
    }
  </style> 
</head>
<body>
  <!-- Màn hình loading -->
  <div id="loadingScreen" class="loading-screen">
    <div class="spinner"></div>
    <p id="loadingMessage" class="loading-message">Đang tải dữ liệu...</p>
    <div id="loadingError" class="loading-error d-none">
      <p class="text-danger mb-3">Có lỗi khi tải dữ liệu!</p>
      <button class="btn btn-primary" onclick="retryLoading()">
        <i class="fas fa-sync-alt me-2"></i>Thử lại
      </button>
    </div>
    <div class="loading-progress mt-3">
      <div class="progress" style="height: 10px; width: 250px;">
        <div id="loadingProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
      </div>
    </div>
  </div>
  
  <!-- Phần đăng nhập -->
  <div id="loginSection" class="section" style="display: block;">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
          <div class="card shadow">
            <div class="card-header bg-primary text-white text-center py-3">
              <img src="https://drive.google.com/uc?export=view&id=YOUR_LOGO_ID" alt="Logo" class="img-fluid mb-2" style="max-height: 60px;">
              <h4 class="mb-0">ĐĂNG NHẬP</h4>
              <p class="small mb-0">Phần mềm quản lý sửa chữa thiết bị</p>
            </div>
            <div class="card-body p-4">
              <form id="loginForm" onsubmit="return false;">
                <div class="mb-3">
                  <label for="username" class="form-label">Tên đăng nhập</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                    <input type="text" class="form-control" id="username" placeholder="Tên đăng nhập" required>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="password" class="form-label">Mật khẩu</label>
                  <div class="input-group password-field">
                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                    <input type="password" class="form-control" id="password" placeholder="Mật khẩu" required>
                    <span class="input-group-text toggle-password" onclick="togglePassword()">
                      <i class="fas fa-eye"></i>
                    </span>
                  </div>
                </div>
                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-primary" id="loginButton" onclick="handleLogin()">
                    <i class="fas fa-sign-in-alt me-2"></i>Đăng nhập
                  </button>
                </div>
              </form>
            </div>
            <div class="card-footer text-center py-3 bg-light">
              <p class="mb-0">Bệnh viện Đa khoa Bắc Giang</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Phần bảng điều khiển -->
  <div id="dashboardSection" class="section" style="display: none;">
    <!-- Header -->
    <header class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="#">
          <img src="https://drive.google.com/uc?export=view&id=YOUR_LOGO_ID" alt="Logo" class="me-2" height="40">
          <span>PHẦN MỀM QUẢN LÝ SỬA CHỮA</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                <i class="fas fa-user-circle fa-lg me-2"></i>
                <span id="userDisplayName">Người dùng</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#" onclick="showChangePasswordModal()"><i class="fas fa-key me-2"></i>Đổi mật khẩu</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </header>
    
    <!-- Main content -->
    <div class="container-fluid py-3">
      <div class="row mb-3">
        <div class="col-12">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-2">
            <button id="addRepairBtn" class="btn btn-success me-2 mb-2">
              <i class="fas fa-plus-circle me-2"></i>Thêm báo hỏng
            </button>
            <div class="d-flex flex-grow-1 mb-2" style="max-width: 500px;">
              <input type="text" id="searchInput" class="form-control me-2" placeholder="Tìm kiếm...">
              <button id="searchBtn" class="btn btn-primary">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tabs -->
      <ul class="nav nav-pills mb-3" id="repairTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="bao-hong-tab" data-bs-toggle="tab" data-bs-target="#bao-hong" type="button" role="tab">
            Báo hỏng <span id="bao-hong-count" class="badge bg-danger">0</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="dang-sua-tab" data-bs-toggle="tab" data-bs-target="#dang-sua" type="button" role="tab">
            Đang sửa <span id="dang-sua-count" class="badge bg-warning">0</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="bao-hanh-tab" data-bs-toggle="tab" data-bs-target="#bao-hanh" type="button" role="tab">
            Bảo hành <span id="bao-hanh-count" class="badge bg-info">0</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="sua-ngoai-tab" data-bs-toggle="tab" data-bs-target="#sua-ngoai" type="button" role="tab">
            Sửa ngoài <span id="sua-ngoai-count" class="badge bg-secondary">0</span>
          </button>
        </li>
      </ul>
      
      <!-- Tab content -->
      <div class="tab-content" id="repairTabContent">
        <!-- Báo hỏng -->
        <div class="tab-pane fade show active" id="bao-hong" role="tabpanel">
          <div class="card">
            <div class="card-header bg-danger text-white">
              <h5 class="mb-0">Danh sách BÁO HỎNG</h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="baoHongTable">
                  <thead class="table-light">
                    <tr>
                      <th width="5%">STT</th>
                      <th width="70%">Nội dung</th>
                      <th width="25%">Hành động</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Dữ liệu sẽ được điền vào đây bằng JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Đang sửa -->
        <div class="tab-pane fade" id="dang-sua" role="tabpanel">
          <div class="card">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">Danh sách ĐANG SỬA</h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="dangSuaTable">
                  <thead class="table-light">
                    <tr>
                      <th width="5%">STT</th>
                      <th width="70%">Nội dung</th>
                      <th width="25%">Hành động</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Dữ liệu sẽ được điền vào đây bằng JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Bảo hành -->
        <div class="tab-pane fade" id="bao-hanh" role="tabpanel">
          <div class="card">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">Danh sách BẢO HÀNH</h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="baoHanhTable">
                  <thead class="table-light">
                    <tr>
                      <th width="5%">STT</th>
                      <th width="70%">Nội dung</th>
                      <th width="25%">Hành động</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Dữ liệu sẽ được điền vào đây bằng JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Sửa ngoài -->
        <div class="tab-pane fade" id="sua-ngoai" role="tabpanel">
          <div class="card">
            <div class="card-header bg-secondary text-white">
              <h5 class="mb-0">Danh sách SỬA NGOÀI</h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="suaNgoaiTable">
                  <thead class="table-light">
                    <tr>
                      <th width="5%">STT</th>
                      <th width="70%">Nội dung</th>
                      <th width="25%">Hành động</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Dữ liệu sẽ được điền vào đây bằng JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal đổi mật khẩu -->
  <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Đổi mật khẩu</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="changePasswordForm">
            <div class="mb-3">
              <label for="oldPassword" class="form-label">Mật khẩu cũ</label>
              <input type="password" class="form-control" id="oldPassword" required>
            </div>
            <div class="mb-3">
              <label for="newPassword" class="form-label">Mật khẩu mới</label>
              <input type="password" class="form-control" id="newPassword" required>
            </div>
            <div class="mb-3">
              <label for="confirmPassword" class="form-label">Xác nhận mật khẩu mới</label>
              <input type="password" class="form-control" id="confirmPassword" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" id="savePasswordBtn">Lưu thay đổi</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal báo hỏng -->
  <div class="modal fade" id="repairModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="repairModalTitle">Thêm báo hỏng</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="repairForm">
            <input type="hidden" id="repairId">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="donViYeuCau" class="form-label">Đơn vị yêu cầu</label>
                <input type="text" class="form-control" id="donViYeuCau" readonly>
              </div>
              <div class="col-md-6">
                <label for="mucDoYeuCau" class="form-label">Mức độ yêu cầu</label>
                <select class="form-select" id="mucDoYeuCau" required>
                  <!-- Options will be loaded dynamically -->
                </select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="nguoiYeuCau" class="form-label">Người yêu cầu</label>
                <input type="text" class="form-control" id="nguoiYeuCau" list="nguoiYeuCauList" required>
                <datalist id="nguoiYeuCauList"></datalist>
              </div>
              <div class="col-md-6">
                <label for="sdtYeuCau" class="form-label">Số điện thoại yêu cầu</label>
                <input type="text" class="form-control" id="sdtYeuCau" list="sdtYeuCauList" required>
                <datalist id="sdtYeuCauList"></datalist>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="nguoiSuaChua" class="form-label">Người sửa chữa</label>
                <select class="form-select" id="nguoiSuaChua" required>
                  <!-- Options will be loaded dynamically -->
                </select>
              </div>
              <div class="col-md-6">
                <label for="sdtNguoiSua" class="form-label">Số điện thoại người sửa</label>
                <input type="text" class="form-control" id="sdtNguoiSua" readonly>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="nhomThietBi" class="form-label">Nhóm thiết bị</label>
                <select class="form-select" id="nhomThietBi" required>
                  <!-- Options will be loaded dynamically -->
                </select>
              </div>
              <div class="col-md-6">
                <label for="maThietBi" class="form-label">Mã thiết bị</label>
                <select class="form-select" id="maThietBi" required>
                  <!-- Options will be loaded dynamically -->
                </select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="tenThietBi" class="form-label">Tên thiết bị</label>
                <input type="text" class="form-control" id="tenThietBi" readonly>
              </div>
              <div class="col-md-6">
                <label for="modelThietBi" class="form-label">Model</label>
                <input type="text" class="form-control" id="modelThietBi" readonly>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="serialThietBi" class="form-label">Serial</label>
                <input type="text" class="form-control" id="serialThietBi" readonly>
              </div>
              <div class="col-md-6">
                <label for="hangSanXuat" class="form-label">Hãng sản xuất</label>
                <input type="text" class="form-control" id="hangSanXuat" readonly>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="nuocSanXuat" class="form-label">Nước sản xuất</label>
                <input type="text" class="form-control" id="nuocSanXuat" readonly>
              </div>
              <div class="col-md-4">
                <label for="namSanXuat" class="form-label">Năm sản xuất</label>
                <input type="text" class="form-control" id="namSanXuat" readonly>
              </div>
              <div class="col-md-4">
                <label for="namSuDung" class="form-label">Năm sử dụng</label>
                <input type="text" class="form-control" id="namSuDung" readonly>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="hanBaoHanh" class="form-label">Hạn bảo hành</label>
                <input type="text" class="form-control" id="hanBaoHanh" readonly>
              </div>
              <div class="col-md-6">
                <label for="viTriDat" class="form-label">Vị trí đặt</label>
                <input type="text" class="form-control" id="viTriDat" readonly>
              </div>
            </div>
            <div class="mb-3">
              <label for="tinhTrangThietBi" class="form-label">Tình trạng thiết bị</label>
              <textarea class="form-control" id="tinhTrangThietBi" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label for="ghiChu" class="form-label">Ghi chú</label>
              <textarea class="form-control" id="ghiChu" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" id="saveRepairBtn">Lưu</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- JavaScript libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>
  
  <script>
    // Biến lưu trữ dữ liệu ứng dụng
    let appData = {
      userData: null,
      allData: null,
      partialDataProgress: 0,
      partialDataLoaded: false,
      partialDataErrors: [] // Thêm để theo dõi lỗi
    };
    
    // Biến lưu timeout ID
    let loadingTimeoutId = null;
    
    // ==== CÁC HÀM TIỆN ÍCH ====
    /**
     * Ẩn màn hình loading
     */
    function hideLoading() {
      document.getElementById('loadingScreen').classList.add('hidden');
      // Xóa timeout nếu có
      if (loadingTimeoutId) {
        clearTimeout(loadingTimeoutId);
        loadingTimeoutId = null;
      }
    }
    
    /**
     * Hiển thị màn hình loading
     * @param {number} timeoutSeconds - Thời gian tối đa chờ (giây)
     */
    function showLoading(timeoutSeconds = 30) {
      document.getElementById('loadingScreen').classList.remove('hidden');
      
      // Ẩn thông báo lỗi nếu có
      document.getElementById('loadingError').classList.add('d-none');
      
      // Reset thanh tiến độ
      const progressBar = document.getElementById('loadingProgressBar');
      if (progressBar) {
        progressBar.style.width = '0%';
        progressBar.classList.add('progress-bar-animated', 'bg-primary');
        progressBar.classList.remove('bg-danger');
      }
      
      // Cài đặt timeout để tránh trường hợp loading quá lâu
      if (loadingTimeoutId) {
        clearTimeout(loadingTimeoutId);
      }
      
      loadingTimeoutId = setTimeout(() => {
        // Hiển thị lỗi và nút thử lại thay vì ẩn loading screen
        document.getElementById('loadingError').classList.remove('d-none');
        document.getElementById('loadingMessage').textContent = 'Quá thời gian chờ phản hồi từ máy chủ';
        
        // Dừng spinner
        const progressBar = document.getElementById('loadingProgressBar');
        if (progressBar) {
          progressBar.style.width = '100%';
          progressBar.classList.remove('progress-bar-animated', 'bg-primary');
          progressBar.classList.add('bg-danger');
        }
        
        console.error('Loading timeout exceeded');
      }, timeoutSeconds * 1000);
    }
    
    /**
     * Cập nhật tiến độ tải
     * @param {number} percent - Phần trăm tiến độ (0-100)
     * @param {string} message - Thông báo hiển thị
     */
    function updateLoadingProgress(percent, message) {
      const progressBar = document.getElementById('loadingProgressBar');
      const loadingMessage = document.getElementById('loadingMessage');
      
      if (progressBar) {
        progressBar.style.width = `${percent}%`;
      }
      
      if (loadingMessage && message) {
        loadingMessage.textContent = message;
      }
    }
    
    /**
     * Thử lại tải dữ liệu
     */
    function retryLoading() {
      // Reset UI
      updateLoadingProgress(0, 'Đang tải dữ liệu... (0%)');
      document.getElementById('loadingError').classList.add('d-none');
      
      const progressBar = document.getElementById('loadingProgressBar');
      if (progressBar) {
        progressBar.classList.add('progress-bar-animated', 'bg-primary');
        progressBar.classList.remove('bg-danger');
      }
      
      // Tải lại dữ liệu
      loadAllData();
    }
    
    /**
     * Hiển thị thông báo
     * @param {string} title - Tiêu đề thông báo
     * @param {string} message - Nội dung thông báo
     * @param {string} icon - Biểu tượng (success, error, warning, info)
     */
    function showAlert(title, message, icon = 'info') {
      Swal.fire({
        title: title,
        text: message,
        icon: icon,
        confirmButtonText: 'Đồng ý',
        confirmButtonColor: '#0d6efd'
      });
    }
    
    /**
     * Chuyển đổi hiển thị giữa các màn hình
     * @param {string} sectionId - ID của màn hình cần hiển thị
     */
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(section => {
        section.style.display = 'none';
      });
      document.getElementById(sectionId).style.display = 'block';
    }
    
    /**
     * Format ngày theo định dạng dd/mm/yyyy
     * @param {Date|string} date - Đối tượng Date hoặc chuỗi ngày
     * @returns {string} Ngày đã định dạng
     */
    function formatDate(date) {
      if (!date) return '';
      
      const d = new Date(date);
      if (isNaN(d.getTime())) return date; // Trả về nguyên mẫu nếu không phải ngày hợp lệ
      
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      
      return `${day}/${month}/${year}`;
    }
    
    /**
     * Chuyển đổi hiển thị mật khẩu
     */
    function togglePassword() {
      const passwordField = document.getElementById('password');
      const icon = document.querySelector('.toggle-password i');
      
      if (passwordField.type === 'password') {
        passwordField.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        passwordField.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    }
    
    // ==== CÁC HÀM XỬ LÝ ĐĂNG NHẬP ====
    /**
     * Xử lý đăng nhập
     */
    function handleLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      if (!username || !password) {
        showAlert('Lỗi đăng nhập', 'Vui lòng nhập tên đăng nhập và mật khẩu', 'error');
        return;
      }
      
      showLoading();
      
      google.script.run
        .withSuccessHandler(processLoginResult)
        .withFailureHandler(handleLoginError)
        .login(username, password);
    }
    
    /**
     * Xử lý kết quả đăng nhập
     * @param {Object} result - Kết quả đăng nhập
     */
    function processLoginResult(result) {
      if (result.success) {
        // Lưu dữ liệu người dùng
        appData.userData = result.userData;
        
        // Hiển thị tên người dùng
        const userDisplayName = document.getElementById('userDisplayName');
        userDisplayName.textContent = result.isTechUser 
          ? result.userData.hoTen 
          : result.userData.donVi;
        
        // Chuyển đến màn hình chính
        showSection('dashboardSection');
        
        // Tải dữ liệu
        loadAllData();
      } else {
        hideLoading();
        showAlert('Lỗi đăng nhập', result.message, 'error');
      }
    }
    
    /**
     * Xử lý lỗi đăng nhập
     * @param {Error} error - Lỗi
     */
    function handleLoginError(error) {
      hideLoading();
      showAlert('Lỗi hệ thống', `Không thể đăng nhập: ${error.message}`, 'error');
    }
    
    /**
     * Đăng xuất
     */
    function logout() {
      // Xóa dữ liệu ứng dụng
      appData = {
        userData: null,
        allData: null
      };
      
      // Reset các trường nhập liệu
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      
      // Chuyển về màn hình đăng nhập
      showSection('loginSection');
    }
    
    // ==== CÁC HÀM TẢI DỮ LIỆU ====
    /**
     * Tải dữ liệu ứng dụng
     */
    function loadAllData() {
      // Hiển thị màn hình loading với timeout 120 giây
      showLoading(120);
      
      // Reset thông tin lỗi
      appData.partialDataErrors = [];
      
      // Thêm thông tin debug
      console.log('Bắt đầu tải dữ liệu...');
      updateLoadingProgress(0, 'Đang tải dữ liệu... (0%)');
      
      // Sử dụng phương pháp tải từng phần
      appData.partialDataProgress = 0;
      appData.partialDataLoaded = false;
      
      // Luôn sử dụng phương pháp tải từng phần để đảm bảo ổn định
      loadDataInParts();
    }
    
    /**
     * Tải dữ liệu theo từng phần
     */
    function loadDataInParts() {
      updateLoadingProgress(5, 'Đang tải dữ liệu thiết yếu... (5%)');
      
      // Đặt lại timeout để tránh hết thời gian
      if (loadingTimeoutId) {
        clearTimeout(loadingTimeoutId);
        loadingTimeoutId = setTimeout(() => {
          document.getElementById('loadingError').classList.remove('d-none');
          document.getElementById('loadingMessage').textContent = 'Quá thời gian chờ phản hồi từ máy chủ';
          
          // Dừng spinner
          const progressBar = document.getElementById('loadingProgressBar');
          if (progressBar) {
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated', 'bg-primary');
            progressBar.classList.add('bg-danger');
          }
          
          console.error('Loading timeout exceeded');
        }, 120 * 1000);
      }
      
      // Tải dữ liệu thiết yếu (đăng nhập, thông tin cơ bản)
      google.script.run
        .withSuccessHandler(function(jsonData) {
          try {
            console.log('Đã nhận dữ liệu thiết yếu, độ dài: ' + jsonData.length);
            // Kiểm tra dữ liệu có phải JSON hợp lệ không
            if (!jsonData || jsonData.trim() === '') {
              throw new Error('Dữ liệu trống');
            }
            
            const essentialData = JSON.parse(jsonData);
            
            // Kiểm tra lỗi trong phản hồi
            if (essentialData.error) {
              throw new Error(essentialData.message || 'Lỗi không xác định từ máy chủ');
            }
            
            appData.allData = appData.allData || {};
            
            // Ghép dữ liệu
            Object.assign(appData.allData, essentialData);
            
            appData.partialDataProgress += 30;
            updateLoadingProgress(appData.partialDataProgress, 
              `Đang tải dữ liệu chính... (${appData.partialDataProgress}%)`);
            
            // Đặt lại timeout
            if (loadingTimeoutId) {
              clearTimeout(loadingTimeoutId);
              loadingTimeoutId = setTimeout(() => {
                document.getElementById('loadingError').classList.remove('d-none');
                document.getElementById('loadingMessage').textContent = 'Quá thời gian chờ phản hồi từ máy chủ';
                
                // Dừng spinner
                const progressBar = document.getElementById('loadingProgressBar');
                if (progressBar) {
                  progressBar.style.width = '100%';
                  progressBar.classList.remove('progress-bar-animated', 'bg-primary');
                  progressBar.classList.add('bg-danger');
                }
                
                console.error('Loading timeout exceeded');
              }, 120 * 1000);
            }
            
            // Tiếp tục tải dữ liệu chính
            loadMainData();
          } catch (error) {
            console.error('Lỗi khi xử lý dữ liệu thiết yếu:', error);
            appData.partialDataErrors.push('essential: ' + error.message);
            // Vẫn tiếp tục tải phần còn lại
            appData.partialDataProgress += 30;
            updateLoadingProgress(appData.partialDataProgress, 
              `Đang tải dữ liệu chính... (${appData.partialDataProgress}%)`);
            loadMainData();
          }
        })
        .withFailureHandler(function(error) {
          console.error('Lỗi khi tải dữ liệu thiết yếu:', error);
          appData.partialDataErrors.push('essential: ' + error.message);
          // Vẫn tiếp tục tải phần còn lại
          appData.partialDataProgress += 30;
          updateLoadingProgress(appData.partialDataProgress, 
            `Đang tải dữ liệu chính... (${appData.partialDataProgress}%)`);
          loadMainData();
        })
        .getPartialData('essential');
    }
    
    /**
     * Tải dữ liệu chính (sửa chữa, thiết bị)
     */
    function loadMainData() {
      // Đặt lại timeout để tránh hết thời gian
      if (loadingTimeoutId) {
        clearTimeout(loadingTimeoutId);
        loadingTimeoutId = setTimeout(() => {
          document.getElementById('loadingError').classList.remove('d-none');
          document.getElementById('loadingMessage').textContent = 'Quá thời gian chờ phản hồi từ máy chủ';
          
          // Dừng spinner
          const progressBar = document.getElementById('loadingProgressBar');
          if (progressBar) {
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated', 'bg-primary');
            progressBar.classList.add('bg-danger');
          }
          
          console.error('Loading timeout exceeded');
        }, 120 * 1000);
      }
      
      google.script.run
        .withSuccessHandler(function(jsonData) {
          try {
            console.log('Đã nhận dữ liệu chính, độ dài: ' + jsonData.length);
            // Kiểm tra dữ liệu có phải JSON hợp lệ không
            if (!jsonData || jsonData.trim() === '') {
              throw new Error('Dữ liệu trống');
            }
            
            const mainData = JSON.parse(jsonData);
            
            // Kiểm tra lỗi trong phản hồi
            if (mainData.error) {
              throw new Error(mainData.message || 'Lỗi không xác định từ máy chủ');
            }
            
            appData.allData = appData.allData || {};
            
            // Ghép dữ liệu
            Object.assign(appData.allData, mainData);
            
            appData.partialDataProgress += 50;
            updateLoadingProgress(appData.partialDataProgress, 
              `Đang tải dữ liệu bổ sung... (${appData.partialDataProgress}%)`);
            
            // Đặt lại timeout
            if (loadingTimeoutId) {
              clearTimeout(loadingTimeoutId);
              loadingTimeoutId = setTimeout(() => {
                document.getElementById('loadingError').classList.remove('d-none');
                document.getElementById('loadingMessage').textContent = 'Quá thời gian chờ phản hồi từ máy chủ';
                
                // Dừng spinner
                const progressBar = document.getElementById('loadingProgressBar');
                if (progressBar) {
                  progressBar.style.width = '100%';
                  progressBar.classList.remove('progress-bar-animated', 'bg-primary');
                  progressBar.classList.add('bg-danger');
                }
                
                console.error('Loading timeout exceeded');
              }, 120 * 1000);
            }
            
            // Tiếp tục tải dữ liệu phụ
            loadSecondaryData();
          } catch (error) {
            console.error('Lỗi khi xử lý dữ liệu chính:', error);
            appData.partialDataErrors.push('main: ' + error.message);
            // Vẫn tiếp tục tải phần còn lại
            appData.partialDataProgress += 50;
            updateLoadingProgress(appData.partialDataProgress, 
              `Đang tải dữ liệu bổ sung... (${appData.partialDataProgress}%)`);
            loadSecondaryData();
          }
        })
        .withFailureHandler(function(error) {
          console.error('Lỗi khi tải dữ liệu chính:', error);
          appData.partialDataErrors.push('main: ' + error.message);
          // Vẫn tiếp tục tải phần còn lại
          appData.partialDataProgress += 50;
          updateLoadingProgress(appData.partialDataProgress, 
            `Đang tải dữ liệu bổ sung... (${appData.partialDataProgress}%)`);
          loadSecondaryData();
        })
        .getPartialData('main');
    }
    
    /**
     * Tải dữ liệu phụ (cài đặt, nhóm thiết bị)
     */
    function loadSecondaryData() {
      // Đặt lại timeout để tránh hết thời gian
      if (loadingTimeoutId) {
        clearTimeout(loadingTimeoutId);
        loadingTimeoutId = setTimeout(() => {
          document.getElementById('loadingError').classList.remove('d-none');
          document.getElementById('loadingMessage').textContent = 'Quá thời gian chờ phản hồi từ máy chủ';
          
          // Dừng spinner
          const progressBar = document.getElementById('loadingProgressBar');
          if (progressBar) {
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated', 'bg-primary');
            progressBar.classList.add('bg-danger');
          }
          
          console.error('Loading timeout exceeded');
        }, 120 * 1000);
      }
      
      google.script.run
        .withSuccessHandler(function(jsonData) {
          try {
            console.log('Đã nhận dữ liệu phụ, độ dài: ' + jsonData.length);
            // Kiểm tra dữ liệu có phải JSON hợp lệ không
            if (!jsonData || jsonData.trim() === '') {
              throw new Error('Dữ liệu trống');
            }
            
            const secondaryData = JSON.parse(jsonData);
            
            // Kiểm tra lỗi trong phản hồi
            if (secondaryData.error) {
              throw new Error(secondaryData.message || 'Lỗi không xác định từ máy chủ');
            }
            
            appData.allData = appData.allData || {};
            
            // Ghép dữ liệu
            Object.assign(appData.allData, secondaryData);
            
            appData.partialDataProgress = 90;
            updateLoadingProgress(appData.partialDataProgress, 
              `Đang cập nhật giao diện... (${appData.partialDataProgress}%)`);
            
            // Dữ liệu đã tải xong, cập nhật giao diện
            appData.partialDataLoaded = true;
          } catch (error) {
            console.error('Lỗi khi xử lý dữ liệu phụ:', error);
            appData.partialDataErrors.push('secondary: ' + error.message);
            // Tiếp tục với dữ liệu đã có
            appData.partialDataProgress = 90;
            updateLoadingProgress(appData.partialDataProgress, 
              `Đang cập nhật giao diện... (${appData.partialDataProgress}%)`);
          } finally {
            // Kiểm tra dữ liệu tối thiểu để tiếp tục
            if (!appData.allData) {
              appData.allData = {};
            }
            
            try {
              // Cập nhật giao diện với dữ liệu đã có
              updateDashboard();
              
              updateLoadingProgress(100, 'Hoàn tất!');
              
              // Nếu có lỗi, hiển thị cảnh báo
              if (appData.partialDataErrors.length > 0) {
                showAlert('Cảnh báo', 'Một số dữ liệu có thể không đầy đủ. Vui lòng làm mới trang nếu có vấn đề.', 'warning');
                console.warn('Có lỗi khi tải dữ liệu:', appData.partialDataErrors);
              }
              
              // Đợi một chút để người dùng thấy 100% rồi mới ẩn
              setTimeout(() => {
                hideLoading();
              }, 500);
            } catch (uiError) {
              console.error('Lỗi khi cập nhật giao diện:', uiError);
              document.getElementById('loadingError').classList.remove('d-none');
              document.getElementById('loadingMessage').textContent = 'Lỗi khi cập nhật giao diện';
              
              // Dừng spinner
              const progressBar = document.getElementById('loadingProgressBar');
              if (progressBar) {
                progressBar.style.width = '100%';
                progressBar.classList.remove('progress-bar-animated', 'bg-primary');
                progressBar.classList.add('bg-danger');
              }
            }
          }
        })
        .withFailureHandler(function(error) {
          console.error('Lỗi khi tải dữ liệu phụ:', error);
          appData.partialDataErrors.push('secondary: ' + error.message);
          
          // Tiếp tục với dữ liệu đã có
          appData.partialDataProgress = 90;
          updateLoadingProgress(appData.partialDataProgress, 
            `Đang cập nhật giao diện... (${appData.partialDataProgress}%)`);
          
          try {
            // Cập nhật giao diện với dữ liệu đã có
            updateDashboard();
            
            updateLoadingProgress(100, 'Hoàn tất!');
            
            // Hiển thị cảnh báo
            showAlert('Cảnh báo', 'Một số dữ liệu có thể không đầy đủ. Vui lòng làm mới trang nếu có vấn đề.', 'warning');
            
            // Đợi một chút để người dùng thấy 100% rồi mới ẩn
            setTimeout(() => {
              hideLoading();
            }, 500);
          } catch (uiError) {
            console.error('Lỗi khi cập nhật giao diện:', uiError);
            document.getElementById('loadingError').classList.remove('d-none');
            document.getElementById('loadingMessage').textContent = 'Lỗi khi cập nhật giao diện';
            
            // Dừng spinner
            const progressBar = document.getElementById('loadingProgressBar');
            if (progressBar) {
              progressBar.style.width = '100%';
              progressBar.classList.remove('progress-bar-animated', 'bg-primary');
              progressBar.classList.add('bg-danger');
            }
          }
        })
        .getPartialData('secondary');
    }
    
    /**
     * Xử lý dữ liệu ứng dụng
     * @param {string} jsonData - Dữ liệu JSON
     */
    function processAppData(jsonData) {
      try {
        console.log('Đã nhận dữ liệu từ server, đang xử lý...');
        updateLoadingProgress(50, 'Đang xử lý dữ liệu... (50%)');
        
        appData.allData = JSON.parse(jsonData);
        
        // Kiểm tra dữ liệu cơ bản
        if (!appData.allData || !appData.allData.val_DSUserDV || !appData.allData.val_DSThietBi) {
          hideLoading();
          showAlert('Lỗi dữ liệu', 'Dữ liệu tải về không đầy đủ. Vui lòng làm mới trang và thử lại.', 'error');
          console.error('Data incomplete:', appData.allData);
          return;
        }
        
        updateLoadingProgress(80, 'Đang cập nhật giao diện... (80%)');
        
        // Cập nhật giao diện
        console.log('Cập nhật giao diện...');
        updateDashboard();
        
        updateLoadingProgress(100, 'Hoàn tất!');
        
        console.log('Tải dữ liệu thành công');
        
        // Đợi một chút để người dùng thấy 100% rồi mới ẩn
        setTimeout(() => {
          hideLoading();
        }, 500);
      } catch (error) {
        console.error('Lỗi khi xử lý dữ liệu:', error);
        handleLoadingError(error, 'Không thể xử lý dữ liệu');
      }
    }
    
    /**
     * Xử lý lỗi tải dữ liệu
     * @param {Error} error - Lỗi
     */
    function handleDataError(error) {
      console.error('Lỗi khi tải dữ liệu:', error);
      handleLoadingError(error, 'Không thể tải dữ liệu');
    }
    
    /**
     * Xử lý lỗi màn hình loading
     * @param {Error} error - Lỗi
     * @param {string} prefix - Tiền tố thông báo lỗi
     */
    function handleLoadingError(error, prefix) {
      // Xóa timeout nếu có
      if (loadingTimeoutId) {
        clearTimeout(loadingTimeoutId);
        loadingTimeoutId = null;
      }
      
      // Hiển thị nút thử lại
      document.getElementById('loadingError').classList.remove('d-none');
      
      // Dừng spinner
      const progressBar = document.getElementById('loadingProgressBar');
      if (progressBar) {
        progressBar.style.width = '100%';
        progressBar.classList.remove('progress-bar-animated', 'bg-primary');
        progressBar.classList.add('bg-danger');
      }
      
      // Cập nhật thông báo lỗi
      const loadingMessage = document.getElementById('loadingMessage');
      if (loadingMessage) {
        loadingMessage.textContent = 'Có lỗi xảy ra khi tải dữ liệu!';
      }
      
      // Hiển thị thông báo chi tiết
      let errorMessage = `${prefix}: ${error.message || 'Lỗi không xác định'}`;
      let errorDetails = '';
      
      // Phân tích lỗi thường gặp
      if (error.message && error.message.includes('timed out') || error.message && error.message.includes('timeout')) {
        errorDetails = 'Máy chủ phản hồi quá chậm, vui lòng thử lại sau.';
      } else if (error.message && error.message.includes('Failed to execute')) {
        errorDetails = 'Có vấn đề khi thực thi script, vui lòng làm mới trang.';
      } else if (error.message && error.message.includes('Authorization')) {
        errorDetails = 'Cần đăng nhập lại hoặc có vấn đề về quyền truy cập.';
      } else {
        errorDetails = 'Vui lòng làm mới trang và thử lại.';
      }
      
      if (errorDetails) {
        errorMessage += `\n${errorDetails}`;
      }
      
      console.error('Chi tiết lỗi:', error);
      showAlert('Lỗi tải dữ liệu', errorMessage, 'error');
    }
    
    // ==== CÁC HÀM CẬP NHẬT GIAO DIỆN ====
    /**
     * Cập nhật bảng điều khiển
     */
    function updateDashboard() {
      if (!appData.allData || !appData.userData) {
        console.error('Dữ liệu không đầy đủ để cập nhật giao diện');
        return;
      }
      
      try {
        // Kiểm tra dữ liệu MainSC có tồn tại không
        if (!appData.allData.val_MainSC) {
          console.error('Thiếu dữ liệu val_MainSC');
          document.getElementById('bao-hong-count').textContent = '0';
          document.getElementById('dang-sua-count').textContent = '0';
          document.getElementById('bao-hanh-count').textContent = '0';
          document.getElementById('sua-ngoai-count').textContent = '0';
          
          // Hiển thị thông báo trong các bảng
          updateRepairTable('baoHongTable', []);
          updateRepairTable('dangSuaTable', []);
          updateRepairTable('baoHanhTable', []);
          updateRepairTable('suaNgoaiTable', []);
          
          // Hiển thị thông báo lỗi
          showAlert('Dữ liệu chưa đầy đủ', 'Chưa nhận được dữ liệu sửa chữa. Vui lòng làm mới trang.', 'warning');
          return;
        }
        
        // Lọc dữ liệu theo đơn vị người dùng
        const userUnitId = appData.userData.id;
        const repairData = appData.allData.val_MainSC.filter(row => 
          row && row.length > CONFIG.COLUMNS.MainSC.DON_VI_DataSC && row[CONFIG.COLUMNS.MainSC.DON_VI_DataSC] === userUnitId
        );
        
        // Phân loại theo trạng thái
        let baoHongData = [], dangSuaData = [], baoHanhData = [], suaNgoaiData = [];
        
        try {
          baoHongData = repairData.filter(row => 
            row && row.length > CONFIG.COLUMNS.MainSC.TRANG_THAI_DataSC && 
            row[CONFIG.COLUMNS.MainSC.TRANG_THAI_DataSC] === CONFIG.REPAIR_STATUS.BAO_HONG
          );
          dangSuaData = repairData.filter(row => 
            row && row.length > CONFIG.COLUMNS.MainSC.TRANG_THAI_DataSC && 
            row[CONFIG.COLUMNS.MainSC.TRANG_THAI_DataSC] === CONFIG.REPAIR_STATUS.DANG_SUA
          );
          baoHanhData = repairData.filter(row => 
            row && row.length > CONFIG.COLUMNS.MainSC.TRANG_THAI_DataSC && 
            row[CONFIG.COLUMNS.MainSC.TRANG_THAI_DataSC] === CONFIG.REPAIR_STATUS.BAO_HANH
          );
          suaNgoaiData = repairData.filter(row => 
            row && row.length > CONFIG.COLUMNS.MainSC.TRANG_THAI_DataSC && 
            row[CONFIG.COLUMNS.MainSC.TRANG_THAI_DataSC] === CONFIG.REPAIR_STATUS.SUA_NGOAI
          );
        } catch (e) {
          console.error('Lỗi khi phân loại dữ liệu:', e);
        }
        
        // Cập nhật số lượng
        document.getElementById('bao-hong-count').textContent = baoHongData.length;
        document.getElementById('dang-sua-count').textContent = dangSuaData.length;
        document.getElementById('bao-hanh-count').textContent = baoHanhData.length;
        document.getElementById('sua-ngoai-count').textContent = suaNgoaiData.length;
        
        // Cập nhật các bảng
        updateRepairTable('baoHongTable', baoHongData);
        updateRepairTable('dangSuaTable', dangSuaData);
        updateRepairTable('baoHanhTable', baoHanhData);
        updateRepairTable('suaNgoaiTable', suaNgoaiData);
        
        // Thiết lập các combobox
        try {
          setupDropdowns();
        } catch (e) {
          console.error('Lỗi khi thiết lập dropdowns:', e);
        }
        
      } catch (error) {
        console.error('Lỗi khi cập nhật giao diện:', error);
        // Thông báo lỗi cho người dùng
        showAlert('Lỗi hiển thị', 'Có lỗi khi hiển thị dữ liệu. Vui lòng làm mới trang.', 'error');
      }
    }
    
    /**
     * Cập nhật bảng báo sửa
     * @param {string} tableId - ID của bảng
     * @param {Array} data - Dữ liệu bảng
     */
    function updateRepairTable(tableId, data) {
      try {
        const table = document.getElementById(tableId);
        if (!table) {
          console.error(`Không tìm thấy bảng với ID: ${tableId}`);
          return;
        }
        
        const tbody = table.querySelector('tbody');
        if (!tbody) {
          console.error(`Không tìm thấy phần tbody trong bảng ${tableId}`);
          return;
        }
        
        tbody.innerHTML = '';
        
        if (!data || !Array.isArray(data) || data.length === 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="3" class="text-center">Không có dữ liệu</td>`;
          tbody.appendChild(tr);
          return;
        }
        
        data.forEach((row, index) => {
          try {
            if (!row || !Array.isArray(row)) return;
            
            // Đảm bảo có đủ cột dữ liệu
            const hasMinimumColumns = row.length > Math.max(
              CONFIG.COLUMNS.MainSC.ID_DataSC,
              CONFIG.COLUMNS.MainSC.THIET_BI_DataSC,
              CONFIG.COLUMNS.MainSC.HO_TEN_DataSC,
              CONFIG.COLUMNS.MainSC.THOI_GIAN_DV_BAO_DataSC,
              CONFIG.COLUMNS.MainSC.TINH_TRANG_TB_DV_BAO_DataSC
            );
            
            if (!hasMinimumColumns) return;
            
            const repairId = row[CONFIG.COLUMNS.MainSC.ID_DataSC] || 'N/A';
            const deviceId = row[CONFIG.COLUMNS.MainSC.THIET_BI_DataSC];
            const deviceInfo = findDeviceById(deviceId);
            
            // Tạo nội dung hiển thị
            const deviceName = deviceInfo ? deviceInfo[CONFIG.COLUMNS.DSThietBi.TEN_THIET_BI_TB] : 'Không xác định';
            const deviceModel = deviceInfo ? deviceInfo[CONFIG.COLUMNS.DSThietBi.MODEL_TB] : '';
            const deviceSerial = deviceInfo ? deviceInfo[CONFIG.COLUMNS.DSThietBi.SERIAL_TB] : '';
            const deviceOrigin = deviceInfo ? deviceInfo[CONFIG.COLUMNS.DSThietBi.NUOC_SAN_XUAT_TB] : '';
            const reporterName = row[CONFIG.COLUMNS.MainSC.HO_TEN_DataSC] || '';
            const reportDate = formatDate(row[CONFIG.COLUMNS.MainSC.THOI_GIAN_DV_BAO_DataSC]);
            const issueDescription = row[CONFIG.COLUMNS.MainSC.TINH_TRANG_TB_DV_BAO_DataSC] || '';
            
            const content = `
              <div class="repair-content">
                <span class="repair-id">⚠️ ${repairId}</span>
                <p>🛠️ ${issueDescription}</p>
                <p>- Thông tin thiết bị: ♟️${deviceName} ⚙️${deviceModel} ⚙️${deviceSerial} ⚙️${deviceOrigin}</p>
                <p>- Thông tin người sửa: 👨${reporterName} 📅${reportDate}</p>
              </div>
            `;
            
            // Tạo nút hành động
            let actionButtons = `
              <button class="btn btn-sm btn-info action-btn" onclick="viewRepairDetails('${repairId}')">
                <i class="fas fa-eye"></i><span>Xem</span>
              </button>
            `;
            
            // Thêm nút sửa/xóa cho Báo hỏng
            if (tableId === 'baoHongTable') {
              actionButtons += `
                <button class="btn btn-sm btn-primary action-btn" onclick="editRepair('${repairId}')">
                  <i class="fas fa-edit"></i><span>Sửa</span>
                </button>
                <button class="btn btn-sm btn-danger action-btn" onclick="deleteRepair('${repairId}')">
                  <i class="fas fa-trash"></i><span>Xóa</span>
                </button>
              `;
            }
            
            // Thêm nút xuất báo cáo
            actionButtons += `
              <button class="btn btn-sm btn-success action-btn" onclick="exportRepair('${repairId}', 'pdf')">
                <i class="fas fa-file-pdf"></i><span>PDF</span>
              </button>
              <button class="btn btn-sm btn-secondary action-btn" onclick="exportRepair('${repairId}', 'doc')">
                <i class="fas fa-file-word"></i><span>Word</span>
              </button>
            `;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="text-center">${index + 1}</td>
              <td>${content}</td>
              <td class="text-center">${actionButtons}</td>
            `;
            tbody.appendChild(tr);
          } catch (rowError) {
            console.error('Lỗi khi xử lý dòng dữ liệu:', rowError);
          }
        });
      } catch (error) {
        console.error('Lỗi khi cập nhật bảng:', error);
      }
    }
    
    /**
     * Tìm thiết bị theo ID
     * @param {string} deviceId - ID thiết bị
     * @returns {Array|null} Dữ liệu thiết bị
     */
    function findDeviceById(deviceId) {
      if (!appData.allData || !deviceId) return null;
      
      try {
        if (!appData.allData.val_DSThietBi || !Array.isArray(appData.allData.val_DSThietBi)) {
          console.warn('Thiếu dữ liệu thiết bị hoặc dữ liệu không đúng định dạng');
          return null;
        }
        
        return appData.allData.val_DSThietBi.find(row => 
          row && 
          row.length > CONFIG.COLUMNS.DSThietBi.ID_TB && 
          row[CONFIG.COLUMNS.DSThietBi.ID_TB] === deviceId
        ) || null;
      } catch (error) {
        console.error('Lỗi khi tìm thiết bị:', error);
        return null;
      }
    }
    
    /**
     * Thiết lập các dropdown
     */
    function setupDropdowns() {
      // Thiết lập dropdown mức độ yêu cầu
      const mucDoSelect = document.getElementById('mucDoYeuCau');
      if (mucDoSelect) {
        mucDoSelect.innerHTML = '';
        
        if (appData.allData.mucDoList) {
          appData.allData.mucDoList.forEach(item => {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.ten;
            mucDoSelect.appendChild(option);
          });
        }
      }
      
      // Thiết lập dropdown người sửa chữa
      const nguoiSuaSelect = document.getElementById('nguoiSuaChua');
      if (nguoiSuaSelect) {
        nguoiSuaSelect.innerHTML = '';
        
        if (appData.allData.val_DSUserSua) {
          appData.allData.val_DSUserSua.forEach(row => {
            if (row && row.length > CONFIG.COLUMNS.DSUserSua.ID_USC) {
              const option = document.createElement('option');
              option.value = row[CONFIG.COLUMNS.DSUserSua.ID_USC];
              option.textContent = row[CONFIG.COLUMNS.DSUserSua.HO_VA_TEN_USC] || 'Không xác định';
              option.dataset.sdt = (row.length > CONFIG.COLUMNS.DSUserSua.SO_DIEN_THOAI_USC) ? 
                (row[CONFIG.COLUMNS.DSUserSua.SO_DIEN_THOAI_USC] || '') : '';
              nguoiSuaSelect.appendChild(option);
            }
          });
        } else {
          console.warn('Thiếu dữ liệu val_DSUserSua');
        }
      }
      
      // Thiết lập dropdown nhóm thiết bị
      const nhomThietBiSelect = document.getElementById('nhomThietBi');
      if (nhomThietBiSelect) {
        nhomThietBiSelect.innerHTML = '';
        
        if (appData.allData.val_DSNhomTB) {
          try {
            const uniqueGroups = [...new Set(appData.allData.val_DSNhomTB
              .filter(row => row && row.length > CONFIG.COLUMNS.DSNhomTB.NHOM_THIET_BI_NTB)
              .map(row => row[CONFIG.COLUMNS.DSNhomTB.NHOM_THIET_BI_NTB])
              .filter(Boolean)
            )];
            
            uniqueGroups.forEach(group => {
              const option = document.createElement('option');
              option.value = group;
              option.textContent = group;
              nhomThietBiSelect.appendChild(option);
            });
          } catch (e) {
            console.error('Lỗi khi xử lý danh sách nhóm thiết bị:', e);
          }
        } else {
          console.warn('Thiếu dữ liệu val_DSNhomTB');
        }
      }
      
      // Thiết lập danh sách gợi ý người yêu cầu
      const nguoiYeuCauList = document.getElementById('nguoiYeuCauList');
      if (nguoiYeuCauList) {
        nguoiYeuCauList.innerHTML = '';
        
        if (appData.allData.val_MainSC) {
          try {
            // Lọc theo người dùng hiện tại
            const userUnitId = appData.userData.id;
            const unitRepairs = appData.allData.val_MainSC.filter(row => 
              row && row.length > CONFIG.COLUMNS.MainSC.DON_VI_DataSC && 
              row[CONFIG.COLUMNS.MainSC.DON_VI_DataSC] === userUnitId
            );
            
            // Lấy danh sách người yêu cầu độc đáo
            const uniqueRequesters = [...new Set(unitRepairs
              .filter(row => row && row.length > CONFIG.COLUMNS.MainSC.HO_TEN_DataSC)
              .map(row => row[CONFIG.COLUMNS.MainSC.HO_TEN_DataSC])
              .filter(Boolean)
            )];
            
            uniqueRequesters.forEach(requester => {
              const option = document.createElement('option');
              option.value = requester;
              nguoiYeuCauList.appendChild(option);
            });
          } catch (e) {
            console.error('Lỗi khi xử lý danh sách người yêu cầu:', e);
          }
        }
      }
      
      // Thiết lập danh sách gợi ý số điện thoại
      const sdtYeuCauList = document.getElementById('sdtYeuCauList');
      if (sdtYeuCauList) {
        sdtYeuCauList.innerHTML = '';
        
        if (appData.allData.val_MainSC) {
          try {
            // Lọc theo người dùng hiện tại
            const userUnitId = appData.userData.id;
            const unitRepairs = appData.allData.val_MainSC.filter(row => 
              row && row.length > CONFIG.COLUMNS.MainSC.DON_VI_DataSC && 
              row[CONFIG.COLUMNS.MainSC.DON_VI_DataSC] === userUnitId
            );
            
            const uniquePhones = [...new Set(unitRepairs
              .filter(row => row && row.length > CONFIG.COLUMNS.MainSC.SO_DIEN_THOAI_DataSC)
              .map(row => row[CONFIG.COLUMNS.MainSC.SO_DIEN_THOAI_DataSC])
              .filter(Boolean)
            )];
            
            uniquePhones.forEach(phone => {
              const option = document.createElement('option');
              option.value = phone;
              sdtYeuCauList.appendChild(option);
            });
          } catch (e) {
            console.error('Lỗi khi xử lý danh sách số điện thoại:', e);
          }
        }
      }
    }
    
    // ==== CÁC HÀM XỬ LÝ SỰ KIỆN ====
    /**
     * Khởi tạo khi trang đã tải xong
     */
    window.onload = function() {
      // Xử lý sự kiện thay đổi người sửa chữa
      document.getElementById('nguoiSuaChua').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        document.getElementById('sdtNguoiSua').value = selectedOption.dataset.sdt || '';
      });
      
      // Xử lý sự kiện thay đổi nhóm thiết bị
      document.getElementById('nhomThietBi').addEventListener('change', function() {
        const selectedGroup = this.value;
        updateDeviceList(selectedGroup);
      });
      
      // Xử lý sự kiện thay đổi mã thiết bị
      document.getElementById('maThietBi').addEventListener('change', function() {
        const selectedDeviceId = this.value;
        updateDeviceDetails(selectedDeviceId);
      });
      
      // Xử lý nút thêm báo hỏng
      document.getElementById('addRepairBtn').addEventListener('click', function() {
        openAddRepairModal();
      });
      
      // Xử lý nút lưu báo hỏng
      document.getElementById('saveRepairBtn').addEventListener('click', function() {
        saveRepair();
      });
      
      // Xử lý nút lưu mật khẩu
      document.getElementById('savePasswordBtn').addEventListener('click', function() {
        changePassword();
      });
      
      // Xử lý tìm kiếm
      document.getElementById('searchBtn').addEventListener('click', function() {
        searchRepairs();
      });
      
      // Xử lý tìm kiếm khi nhấn Enter
      document.getElementById('searchInput').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
          searchRepairs();
        }
      });
    };
    
    /**
     * Cập nhật danh sách thiết bị theo nhóm
     * @param {string} groupName - Tên nhóm thiết bị
     */
    function updateDeviceList(groupName) {
      const deviceSelect = document.getElementById('maThietBi');
      deviceSelect.innerHTML = '';
      
      // Thêm lựa chọn mặc định
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = '-- Chọn thiết bị --';
      deviceSelect.appendChild(defaultOption);
      
      // Lọc thiết bị theo nhóm
      const devices = appData.allData.val_DSThietBi.filter(row => 
        row[CONFIG.COLUMNS.DSThietBi.NHOM_THIET_BI_TB] === groupName
      );
      
      // Thêm các thiết bị
      devices.forEach(device => {
        const option = document.createElement('option');
        option.value = device[CONFIG.COLUMNS.DSThietBi.ID_TB];
        option.textContent = `${device[CONFIG.COLUMNS.DSThietBi.MA_THIET_BI_TB]} - ${device[CONFIG.COLUMNS.DSThietBi.TEN_THIET_BI_TB]}`;
        deviceSelect.appendChild(option);
      });
    }
    
    /**
     * Cập nhật thông tin chi tiết thiết bị
     * @param {string} deviceId - ID thiết bị
     */
    function updateDeviceDetails(deviceId) {
      if (!deviceId) {
        // Clear device details
        document.getElementById('tenThietBi').value = '';
        document.getElementById('modelThietBi').value = '';
        document.getElementById('serialThietBi').value = '';
        document.getElementById('hangSanXuat').value = '';
        document.getElementById('nuocSanXuat').value = '';
        document.getElementById('namSanXuat').value = '';
        document.getElementById('namSuDung').value = '';
        document.getElementById('hanBaoHanh').value = '';
        document.getElementById('viTriDat').value = '';
        return;
      }
      
      // Find the device
      const device = findDeviceById(deviceId);
      if (!device) return;
      
      // Update device details
      document.getElementById('tenThietBi').value = device[CONFIG.COLUMNS.DSThietBi.TEN_THIET_BI_TB] || '';
      document.getElementById('modelThietBi').value = device[CONFIG.COLUMNS.DSThietBi.MODEL_TB] || '';
      document.getElementById('serialThietBi').value = device[CONFIG.COLUMNS.DSThietBi.SERIAL_TB] || '';
      document.getElementById('hangSanXuat').value = device[CONFIG.COLUMNS.DSThietBi.HANG_SAN_XUAT_TB] || '';
      document.getElementById('nuocSanXuat').value = device[CONFIG.COLUMNS.DSThietBi.NUOC_SAN_XUAT_TB] || '';
      document.getElementById('namSanXuat').value = device[CONFIG.COLUMNS.DSThietBi.NAM_SAN_XUAT_TB] || '';
      document.getElementById('namSuDung').value = device[CONFIG.COLUMNS.DSThietBi.THOI_GIAN_DUA_VAO_SU_DUNG_TB] || '';
      document.getElementById('hanBaoHanh').value = device[CONFIG.COLUMNS.DSThietBi.HAN_BAO_HANH_TB] || '';
      document.getElementById('viTriDat').value = device[CONFIG.COLUMNS.DSThietBi.VI_TRI_DAT_TB] || '';
    }
    
    /**
     * Mở modal thêm báo hỏng mới
     */
    function openAddRepairModal() {
      // Reset form
      document.getElementById('repairForm').reset();
      document.getElementById('repairId').value = '';
      
      // Điền thông tin đơn vị yêu cầu
      document.getElementById('donViYeuCau').value = appData.userData.donVi || '';
      
      // Hiển thị modal
      const repairModal = new bootstrap.Modal(document.getElementById('repairModal'));
      repairModal.show();
    }
    
    /**
     * Lưu báo cáo sửa chữa
     */
    function saveRepair() {
      // Validate form
      const form = document.getElementById('repairForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Hiển thị loading
      showLoading();
      
      // Thu thập dữ liệu form
      const repairData = {
        iduserdv: appData.userData.id,
        idusersua: document.getElementById('nguoiSuaChua').value,
        idthietbi: document.getElementById('maThietBi').value,
        tinhtrangtbdvbao: document.getElementById('tinhTrangThietBi').value,
        hoten: document.getElementById('nguoiYeuCau').value,
        sdt: document.getElementById('sdtYeuCau').value,
        ghichu: document.getElementById('ghiChu').value,
        mucDo: document.getElementById('mucDoYeuCau').value,
        donvi: appData.userData.kiHieu || 'XX'
      };
      
      // Gửi yêu cầu tạo báo cáo sửa chữa
      google.script.run
        .withSuccessHandler(onSaveRepairSuccess)
        .withFailureHandler(onSaveRepairError)
        .createRepairReport(repairData);
    }
    
    /**
     * Xử lý khi lưu báo cáo thành công
     * @param {Object} result - Kết quả từ server
     */
    function onSaveRepairSuccess(result) {
      hideLoading();
      
      if (result.success) {
        // Ẩn modal
        const repairModal = bootstrap.Modal.getInstance(document.getElementById('repairModal'));
        repairModal.hide();
        
        // Thông báo thành công
        showAlert('Thành công', result.message, 'success');
        
        // Tải lại dữ liệu
        loadAllData();
      } else {
        showAlert('Lỗi', result.message, 'error');
      }
    }
    
    /**
     * Xử lý khi lưu báo cáo bị lỗi
     * @param {Error} error - Lỗi
     */
    function onSaveRepairError(error) {
      hideLoading();
      showAlert('Lỗi hệ thống', `Không thể lưu báo cáo: ${error.message}`, 'error');
    }
    
    /**
     * Đổi mật khẩu
     */
    function changePassword() {
      // Validate form
      const form = document.getElementById('changePasswordForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // Kiểm tra mật khẩu mới và xác nhận
      if (newPassword !== confirmPassword) {
        showAlert('Lỗi', 'Mật khẩu mới và xác nhận mật khẩu không khớp', 'error');
        return;
      }
      
      // Hiển thị loading
      showLoading();
      
      // Gửi yêu cầu đổi mật khẩu
      google.script.run
        .withSuccessHandler(onChangePasswordSuccess)
        .withFailureHandler(onChangePasswordError)
        .changePassword(appData.userData.id, oldPassword, newPassword, !!appData.userData.hoTen);
    }
    
    /**
     * Xử lý khi đổi mật khẩu thành công
     * @param {Object} result - Kết quả từ server
     */
    function onChangePasswordSuccess(result) {
      hideLoading();
      
      if (result.success) {
        // Ẩn modal
        const passwordModal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
        passwordModal.hide();
        
        // Reset form
        document.getElementById('changePasswordForm').reset();
        
        // Thông báo thành công
        showAlert('Thành công', result.message, 'success');
      } else {
        showAlert('Lỗi', result.message, 'error');
      }
    }
    
    /**
     * Xử lý khi đổi mật khẩu bị lỗi
     * @param {Error} error - Lỗi
     */
    function onChangePasswordError(error) {
      hideLoading();
      showAlert('Lỗi hệ thống', `Không thể đổi mật khẩu: ${error.message}`, 'error');
    }
    
    /**
     * Tìm kiếm báo cáo
     */
    function searchRepairs() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      if (!searchTerm) {
        updateDashboard(); // Nếu không có từ khóa, hiển thị tất cả
        return;
      }
      
      if (!appData.allData || !appData.userData) return;
      
      // Lọc dữ liệu theo đơn vị người dùng
      const userUnitId = appData.userData.id;
      const repairData = appData.allData.val_MainSC.filter(row => 
        row[CONFIG.COLUMNS.MainSC.DON_VI_DataSC] === userUnitId
      );
      
      // Lọc theo từ khóa
      const filteredData = repairData.filter(row => {
        // Lấy thông tin thiết bị
        const deviceId = row[CONFIG.COLUMNS.MainSC.THIET_BI_DataSC];
        const deviceInfo = findDeviceById(deviceId);
        
        // Tìm kiếm trong các trường
        const repairId = row[CONFIG.COLUMNS.MainSC.ID_DataSC] || '';
        const deviceName = deviceInfo ? deviceInfo[CONFIG.COLUMNS.DSThietBi.TEN_THIET_BI_TB] || '' : '';
        const deviceModel = deviceInfo ? deviceInfo[CONFIG.COLUMNS.DSThietBi.MODEL_TB] || '' : '';
        const deviceSerial = deviceInfo ? deviceInfo[CONFIG.COLUMNS.DSThietBi.SERIAL_TB] || '' : '';
        const issueDescription = row[CONFIG.COLUMNS.MainSC.TINH_TRANG_TB_DV_BAO_DataSC] || '';
        const reporterName = row[CONFIG.COLUMNS.MainSC.HO_TEN_DataSC] || '';
        
        // Kiểm tra xem từ khóa có trùng với bất kỳ trường nào
        return repairId.toLowerCase().includes(searchTerm) ||
          deviceName.toLowerCase().includes(searchTerm) ||
          deviceModel.toLowerCase().includes(searchTerm) ||
          deviceSerial.toLowerCase().includes(searchTerm) ||
          issueDescription.toLowerCase().includes(searchTerm) ||
          reporterName.toLowerCase().includes(searchTerm);
      });
      
      // Phân loại theo trạng thái
      const baoHongData = filteredData.filter(row => row[CONFIG.COLUMNS.MainSC.TRANG_THAI_DataSC] === CONFIG.REPAIR_STATUS.BAO_HONG);
      const dangSuaData = filteredData.filter(row => row[CONFIG.COLUMNS.MainSC.TRANG_THAI_DataSC] === CONFIG.REPAIR_STATUS.DANG_SUA);
      const baoHanhData = filteredData.filter(row => row[CONFIG.COLUMNS.MainSC.TRANG_THAI_DataSC] === CONFIG.REPAIR_STATUS.BAO_HANH);
      const suaNgoaiData = filteredData.filter(row => row[CONFIG.COLUMNS.MainSC.TRANG_THAI_DataSC] === CONFIG.REPAIR_STATUS.SUA_NGOAI);
      
      // Cập nhật số lượng
      document.getElementById('bao-hong-count').textContent = baoHongData.length;
      document.getElementById('dang-sua-count').textContent = dangSuaData.length;
      document.getElementById('bao-hanh-count').textContent = baoHanhData.length;
      document.getElementById('sua-ngoai-count').textContent = suaNgoaiData.length;
      
      // Cập nhật các bảng
      updateRepairTable('baoHongTable', baoHongData);
      updateRepairTable('dangSuaTable', dangSuaData);
      updateRepairTable('baoHanhTable', baoHanhData);
      updateRepairTable('suaNgoaiTable', suaNgoaiData);
    }
    
    /**
     * Xem chi tiết báo cáo
     * @param {string} repairId - ID báo cáo sửa chữa
     */
    function viewRepairDetails(repairId) {
      showAlert('Thông báo', 'Chức năng xem chi tiết đang được phát triển.', 'info');
    }
    
    /**
     * Sửa báo cáo
     * @param {string} repairId - ID báo cáo sửa chữa
     */
    function editRepair(repairId) {
      showAlert('Thông báo', 'Chức năng sửa báo cáo đang được phát triển.', 'info');
    }
    
    /**
     * Xóa báo cáo
     * @param {string} repairId - ID báo cáo sửa chữa
     */
    function deleteRepair(repairId) {
      Swal.fire({
        title: 'Xác nhận xóa',
        text: `Bạn có chắc chắn muốn xóa báo cáo ${repairId}?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Xóa',
        cancelButtonText: 'Hủy',
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6'
      }).then((result) => {
        if (result.isConfirmed) {
          showAlert('Thông báo', 'Chức năng xóa báo cáo đang được phát triển.', 'info');
        }
      });
    }
    
    /**
     * Xuất báo cáo
     * @param {string} repairId - ID báo cáo sửa chữa
     * @param {string} format - Định dạng (pdf, doc)
     */
    function exportRepair(repairId, format) {
      showAlert('Thông báo', 'Chức năng xuất báo cáo đang được phát triển.', 'info');
    }
    
    /**
     * Hiển thị modal đổi mật khẩu
     */
    function showChangePasswordModal() {
      // Reset form
      document.getElementById('changePasswordForm').reset();
      
      // Hiển thị modal
      const passwordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
      passwordModal.show();
    }
    </script> 
</body>
</html> 