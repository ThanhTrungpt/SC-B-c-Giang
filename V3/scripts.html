<script>
// Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu ·ª©ng d·ª•ng
let appData = {
  userData: null,
  allData: null,
  partialDataProgress: 0,
  partialDataLoaded: false,
  partialDataErrors: [] // Th√™m ƒë·ªÉ theo d√µi l·ªói
};

// Bi·∫øn l∆∞u timeout ID
let loadingTimeoutId = null;

// ==== C√ÅC H√ÄM TI·ªÜN √çCH ====
/**
 * ·∫®n m√†n h√¨nh loading
 */
function hideLoading() {
  document.getElementById('loadingScreen').classList.add('hidden');
  // X√≥a timeout n·∫øu c√≥
  if (loadingTimeoutId) {
    clearTimeout(loadingTimeoutId);
    loadingTimeoutId = null;
  }
}

/**
 * Hi·ªÉn th·ªã m√†n h√¨nh loading
 * @param {number} timeoutSeconds - Th·ªùi gian t·ªëi ƒëa ch·ªù (gi√¢y)
 */
function showLoading(timeoutSeconds = 30) {
  document.getElementById('loadingScreen').classList.remove('hidden');
  
  // ·∫®n th√¥ng b√°o l·ªói n·∫øu c√≥
  document.getElementById('loadingError').classList.add('d-none');
  
  // Reset thanh ti·∫øn ƒë·ªô
  const progressBar = document.getElementById('loadingProgressBar');
  if (progressBar) {
    progressBar.style.width = '0%';
    progressBar.classList.add('progress-bar-animated', 'bg-primary');
    progressBar.classList.remove('bg-danger');
  }
  
  // C√†i ƒë·∫∑t timeout ƒë·ªÉ tr√°nh tr∆∞·ªùng h·ª£p loading qu√° l√¢u
  if (loadingTimeoutId) {
    clearTimeout(loadingTimeoutId);
  }
  
  loadingTimeoutId = setTimeout(() => {
    // Hi·ªÉn th·ªã l·ªói v√† n√∫t th·ª≠ l·∫°i thay v√¨ ·∫©n loading screen
    document.getElementById('loadingError').classList.remove('d-none');
    document.getElementById('loadingMessage').textContent = 'Qu√° th·ªùi gian ch·ªù ph·∫£n h·ªìi t·ª´ m√°y ch·ªß';
    
    // D·ª´ng spinner
    const progressBar = document.getElementById('loadingProgressBar');
    if (progressBar) {
      progressBar.style.width = '100%';
      progressBar.classList.remove('progress-bar-animated', 'bg-primary');
      progressBar.classList.add('bg-danger');
    }
    
    console.error('Loading timeout exceeded');
  }, timeoutSeconds * 1000);
}

/**
 * C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô t·∫£i
 * @param {number} percent - Ph·∫ßn trƒÉm ti·∫øn ƒë·ªô (0-100)
 * @param {string} message - Th√¥ng b√°o hi·ªÉn th·ªã
 */
function updateLoadingProgress(percent, message) {
  const progressBar = document.getElementById('loadingProgressBar');
  const loadingMessage = document.getElementById('loadingMessage');
  
  if (progressBar) {
    progressBar.style.width = `${percent}%`;
  }
  
  if (loadingMessage && message) {
    loadingMessage.textContent = message;
  }
}

/**
 * Th·ª≠ l·∫°i t·∫£i d·ªØ li·ªáu
 */
function retryLoading() {
  // Reset UI
  updateLoadingProgress(0, 'ƒêang t·∫£i d·ªØ li·ªáu... (0%)');
  document.getElementById('loadingError').classList.add('d-none');
  
  const progressBar = document.getElementById('loadingProgressBar');
  if (progressBar) {
    progressBar.classList.add('progress-bar-animated', 'bg-primary');
    progressBar.classList.remove('bg-danger');
  }
  
  // T·∫£i l·∫°i d·ªØ li·ªáu
  loadAllData();
}

/**
 * Hi·ªÉn th·ªã th√¥ng b√°o
 * @param {string} title - Ti√™u ƒë·ªÅ th√¥ng b√°o
 * @param {string} message - N·ªôi dung th√¥ng b√°o
 * @param {string} icon - Bi·ªÉu t∆∞·ª£ng (success, error, warning, info)
 */
function showAlert(title, message, icon = 'info') {
  Swal.fire({
    title: title,
    text: message,
    icon: icon,
    confirmButtonText: 'ƒê·ªìng √Ω',
    confirmButtonColor: '#0d6efd'
  });
}

/**
 * Chuy·ªÉn ƒë·ªïi hi·ªÉn th·ªã gi·ªØa c√°c m√†n h√¨nh
 * @param {string} sectionId - ID c·ªßa m√†n h√¨nh c·∫ßn hi·ªÉn th·ªã
 */
function showSection(sectionId) {
  document.querySelectorAll('.section').forEach(section => {
    section.style.display = 'none';
  });
  document.getElementById(sectionId).style.display = 'block';
}

/**
 * Format ng√†y theo ƒë·ªãnh d·∫°ng dd/mm/yyyy
 * @param {Date|string} date - ƒê·ªëi t∆∞·ª£ng Date ho·∫∑c chu·ªói ng√†y
 * @returns {string} Ng√†y ƒë√£ ƒë·ªãnh d·∫°ng
 */
function formatDate(date) {
  if (!date) return '';
  
  const d = new Date(date);
  if (isNaN(d.getTime())) return date; // Tr·∫£ v·ªÅ nguy√™n m·∫´u n·∫øu kh√¥ng ph·∫£i ng√†y h·ª£p l·ªá
  
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  
  return `${day}/${month}/${year}`;
}

/**
 * Chuy·ªÉn ƒë·ªïi hi·ªÉn th·ªã m·∫≠t kh·∫©u
 */
function togglePassword() {
  const passwordField = document.getElementById('password');
  const icon = document.querySelector('.toggle-password i');
  
  if (passwordField.type === 'password') {
    passwordField.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    passwordField.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

// ==== C√ÅC H√ÄM X·ª¨ L√ù ƒêƒÇNG NH·∫¨P ====
/**
 * X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
 */
function handleLogin() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  
  if (!username || !password) {
    showAlert('L·ªói ƒëƒÉng nh·∫≠p', 'Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u', 'error');
    return;
  }
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(processLoginResult)
    .withFailureHandler(handleLoginError)
    .login(username, password);
}

/**
 * X·ª≠ l√Ω k·∫øt qu·∫£ ƒëƒÉng nh·∫≠p
 * @param {Object} result - K·∫øt qu·∫£ ƒëƒÉng nh·∫≠p
 */
function processLoginResult(result) {
  if (result.success) {
    // L∆∞u d·ªØ li·ªáu ng∆∞·ªùi d√πng
    appData.userData = result.userData;
    
    // Hi·ªÉn th·ªã t√™n ng∆∞·ªùi d√πng
    const userDisplayName = document.getElementById('userDisplayName');
    userDisplayName.textContent = result.isTechUser 
      ? result.userData.hoTen 
      : result.userData.donVi;
    
    // Chuy·ªÉn ƒë·∫øn m√†n h√¨nh ch√≠nh
    showSection('dashboardSection');
    
    // T·∫£i d·ªØ li·ªáu
    loadAllData();
  } else {
    hideLoading();
    showAlert('L·ªói ƒëƒÉng nh·∫≠p', result.message, 'error');
  }
}

/**
 * X·ª≠ l√Ω l·ªói ƒëƒÉng nh·∫≠p
 * @param {Error} error - L·ªói
 */
function handleLoginError(error) {
  hideLoading();
  showAlert('L·ªói h·ªá th·ªëng', `Kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p: ${error.message}`, 'error');
}

/**
 * ƒêƒÉng xu·∫•t
 */
function logout() {
  // X√≥a d·ªØ li·ªáu ·ª©ng d·ª•ng
  appData = {
    userData: null,
    allData: null
  };
  
  // Reset c√°c tr∆∞·ªùng nh·∫≠p li·ªáu
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
  
  // Chuy·ªÉn v·ªÅ m√†n h√¨nh ƒëƒÉng nh·∫≠p
  showSection('loginSection');
}

// ==== C√ÅC H√ÄM T·∫¢I D·ªÆ LI·ªÜU ====
/**
 * T·∫£i d·ªØ li·ªáu ·ª©ng d·ª•ng
 */
function loadAllData() {
  // Hi·ªÉn th·ªã m√†n h√¨nh loading v·ªõi timeout 120 gi√¢y
  showLoading(120);
  
  // Reset th√¥ng tin l·ªói
  appData.partialDataErrors = [];
  
  // Th√™m th√¥ng tin debug
  console.log('B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu...');
  updateLoadingProgress(0, 'ƒêang t·∫£i d·ªØ li·ªáu... (0%)');
  
  // S·ª≠ d·ª•ng ph∆∞∆°ng ph√°p t·∫£i t·ª´ng ph·∫ßn
  appData.partialDataProgress = 0;
  appData.partialDataLoaded = false;
  
  // Lu√¥n s·ª≠ d·ª•ng ph∆∞∆°ng ph√°p t·∫£i t·ª´ng ph·∫ßn ƒë·ªÉ ƒë·∫£m b·∫£o ·ªïn ƒë·ªãnh
  loadDataInParts();
}

/**
 * T·∫£i d·ªØ li·ªáu theo t·ª´ng ph·∫ßn
 */
function loadDataInParts() {
  updateLoadingProgress(5, 'ƒêang t·∫£i d·ªØ li·ªáu thi·∫øt y·∫øu... (5%)');
  
  // ƒê·∫∑t l·∫°i timeout ƒë·ªÉ tr√°nh h·∫øt th·ªùi gian
  if (loadingTimeoutId) {
    clearTimeout(loadingTimeoutId);
    loadingTimeoutId = setTimeout(() => {
      document.getElementById('loadingError').classList.remove('d-none');
      document.getElementById('loadingMessage').textContent = 'Qu√° th·ªùi gian ch·ªù ph·∫£n h·ªìi t·ª´ m√°y ch·ªß';
      
      // D·ª´ng spinner
      const progressBar = document.getElementById('loadingProgressBar');
      if (progressBar) {
        progressBar.style.width = '100%';
        progressBar.classList.remove('progress-bar-animated', 'bg-primary');
        progressBar.classList.add('bg-danger');
      }
      
      console.error('Loading timeout exceeded');
    }, 120 * 1000);
  }
  
  // T·∫£i d·ªØ li·ªáu thi·∫øt y·∫øu (ƒëƒÉng nh·∫≠p, th√¥ng tin c∆° b·∫£n)
  google.script.run
    .withSuccessHandler(function(jsonData) {
      try {
        console.log('ƒê√£ nh·∫≠n d·ªØ li·ªáu thi·∫øt y·∫øu, ƒë·ªô d√†i: ' + jsonData.length);
        // Ki·ªÉm tra d·ªØ li·ªáu c√≥ ph·∫£i JSON h·ª£p l·ªá kh√¥ng
        if (!jsonData || jsonData.trim() === '') {
          throw new Error('D·ªØ li·ªáu tr·ªëng');
        }
        
        const essentialData = JSON.parse(jsonData);
        
        // Ki·ªÉm tra l·ªói trong ph·∫£n h·ªìi
        if (essentialData.error) {
          throw new Error(essentialData.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ m√°y ch·ªß');
        }
        
        appData.allData = appData.allData || {};
        
        // Gh√©p d·ªØ li·ªáu
        Object.assign(appData.allData, essentialData);
        
        appData.partialDataProgress += 30;
        updateLoadingProgress(appData.partialDataProgress, 
          `ƒêang t·∫£i d·ªØ li·ªáu ch√≠nh... (${appData.partialDataProgress}%)`);
        
        // ƒê·∫∑t l·∫°i timeout
        if (loadingTimeoutId) {
          clearTimeout(loadingTimeoutId);
          loadingTimeoutId = setTimeout(() => {
            document.getElementById('loadingError').classList.remove('d-none');
            document.getElementById('loadingMessage').textContent = 'Qu√° th·ªùi gian ch·ªù ph·∫£n h·ªìi t·ª´ m√°y ch·ªß';
            
            // D·ª´ng spinner
            const progressBar = document.getElementById('loadingProgressBar');
            if (progressBar) {
              progressBar.style.width = '100%';
              progressBar.classList.remove('progress-bar-animated', 'bg-primary');
              progressBar.classList.add('bg-danger');
            }
            
            console.error('Loading timeout exceeded');
          }, 120 * 1000);
        }
        
        // Ti·∫øp t·ª•c t·∫£i d·ªØ li·ªáu ch√≠nh
        loadMainData();
      } catch (error) {
        console.error('L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu thi·∫øt y·∫øu:', error);
        appData.partialDataErrors.push('essential: ' + error.message);
        // V·∫´n ti·∫øp t·ª•c t·∫£i ph·∫ßn c√≤n l·∫°i
        appData.partialDataProgress += 30;
        updateLoadingProgress(appData.partialDataProgress, 
          `ƒêang t·∫£i d·ªØ li·ªáu ch√≠nh... (${appData.partialDataProgress}%)`);
        loadMainData();
      }
    })
    .withFailureHandler(function(error) {
      console.error('L·ªói khi t·∫£i d·ªØ li·ªáu thi·∫øt y·∫øu:', error);
      appData.partialDataErrors.push('essential: ' + error.message);
      // V·∫´n ti·∫øp t·ª•c t·∫£i ph·∫ßn c√≤n l·∫°i
      appData.partialDataProgress += 30;
      updateLoadingProgress(appData.partialDataProgress, 
        `ƒêang t·∫£i d·ªØ li·ªáu ch√≠nh... (${appData.partialDataProgress}%)`);
      loadMainData();
    })
    .getPartialData('essential');
}

/**
 * T·∫£i d·ªØ li·ªáu ch√≠nh (s·ª≠a ch·ªØa, thi·∫øt b·ªã)
 */
function loadMainData() {
  // ƒê·∫∑t l·∫°i timeout ƒë·ªÉ tr√°nh h·∫øt th·ªùi gian
  if (loadingTimeoutId) {
    clearTimeout(loadingTimeoutId);
    loadingTimeoutId = setTimeout(() => {
      document.getElementById('loadingError').classList.remove('d-none');
      document.getElementById('loadingMessage').textContent = 'Qu√° th·ªùi gian ch·ªù ph·∫£n h·ªìi t·ª´ m√°y ch·ªß';
      
      // D·ª´ng spinner
      const progressBar = document.getElementById('loadingProgressBar');
      if (progressBar) {
        progressBar.style.width = '100%';
        progressBar.classList.remove('progress-bar-animated', 'bg-primary');
        progressBar.classList.add('bg-danger');
      }
      
      console.error('Loading timeout exceeded');
    }, 120 * 1000);
  }
  
  google.script.run
    .withSuccessHandler(function(jsonData) {
      try {
        console.log('ƒê√£ nh·∫≠n d·ªØ li·ªáu ch√≠nh, ƒë·ªô d√†i: ' + jsonData.length);
        // Ki·ªÉm tra d·ªØ li·ªáu c√≥ ph·∫£i JSON h·ª£p l·ªá kh√¥ng
        if (!jsonData || jsonData.trim() === '') {
          throw new Error('D·ªØ li·ªáu tr·ªëng');
        }
        
        const mainData = JSON.parse(jsonData);
        
        // Ki·ªÉm tra l·ªói trong ph·∫£n h·ªìi
        if (mainData.error) {
          throw new Error(mainData.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ m√°y ch·ªß');
        }
        
        appData.allData = appData.allData || {};
        
        // Gh√©p d·ªØ li·ªáu
        Object.assign(appData.allData, mainData);
        
        appData.partialDataProgress += 50;
        updateLoadingProgress(appData.partialDataProgress, 
          `ƒêang t·∫£i d·ªØ li·ªáu b·ªï sung... (${appData.partialDataProgress}%)`);
        
        // ƒê·∫∑t l·∫°i timeout
        if (loadingTimeoutId) {
          clearTimeout(loadingTimeoutId);
          loadingTimeoutId = setTimeout(() => {
            document.getElementById('loadingError').classList.remove('d-none');
            document.getElementById('loadingMessage').textContent = 'Qu√° th·ªùi gian ch·ªù ph·∫£n h·ªìi t·ª´ m√°y ch·ªß';
            
            // D·ª´ng spinner
            const progressBar = document.getElementById('loadingProgressBar');
            if (progressBar) {
              progressBar.style.width = '100%';
              progressBar.classList.remove('progress-bar-animated', 'bg-primary');
              progressBar.classList.add('bg-danger');
            }
            
            console.error('Loading timeout exceeded');
          }, 120 * 1000);
        }
        
        // Ti·∫øp t·ª•c t·∫£i d·ªØ li·ªáu ph·ª•
        loadSecondaryData();
      } catch (error) {
        console.error('L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu ch√≠nh:', error);
        appData.partialDataErrors.push('main: ' + error.message);
        // V·∫´n ti·∫øp t·ª•c t·∫£i ph·∫ßn c√≤n l·∫°i
        appData.partialDataProgress += 50;
        updateLoadingProgress(appData.partialDataProgress, 
          `ƒêang t·∫£i d·ªØ li·ªáu b·ªï sung... (${appData.partialDataProgress}%)`);
        loadSecondaryData();
      }
    })
    .withFailureHandler(function(error) {
      console.error('L·ªói khi t·∫£i d·ªØ li·ªáu ch√≠nh:', error);
      appData.partialDataErrors.push('main: ' + error.message);
      // V·∫´n ti·∫øp t·ª•c t·∫£i ph·∫ßn c√≤n l·∫°i
      appData.partialDataProgress += 50;
      updateLoadingProgress(appData.partialDataProgress, 
        `ƒêang t·∫£i d·ªØ li·ªáu b·ªï sung... (${appData.partialDataProgress}%)`);
      loadSecondaryData();
    })
    .getPartialData('main');
}

/**
 * T·∫£i d·ªØ li·ªáu ph·ª• (c√†i ƒë·∫∑t, nh√≥m thi·∫øt b·ªã)
 */
function loadSecondaryData() {
  // ƒê·∫∑t l·∫°i timeout ƒë·ªÉ tr√°nh h·∫øt th·ªùi gian
  if (loadingTimeoutId) {
    clearTimeout(loadingTimeoutId);
    loadingTimeoutId = setTimeout(() => {
      document.getElementById('loadingError').classList.remove('d-none');
      document.getElementById('loadingMessage').textContent = 'Qu√° th·ªùi gian ch·ªù ph·∫£n h·ªìi t·ª´ m√°y ch·ªß';
      
      // D·ª´ng spinner
      const progressBar = document.getElementById('loadingProgressBar');
      if (progressBar) {
        progressBar.style.width = '100%';
        progressBar.classList.remove('progress-bar-animated', 'bg-primary');
        progressBar.classList.add('bg-danger');
      }
      
      console.error('Loading timeout exceeded');
    }, 120 * 1000);
  }
  
  google.script.run
    .withSuccessHandler(function(jsonData) {
      try {
        console.log('ƒê√£ nh·∫≠n d·ªØ li·ªáu ph·ª•, ƒë·ªô d√†i: ' + jsonData.length);
        // Ki·ªÉm tra d·ªØ li·ªáu c√≥ ph·∫£i JSON h·ª£p l·ªá kh√¥ng
        if (!jsonData || jsonData.trim() === '') {
          throw new Error('D·ªØ li·ªáu tr·ªëng');
        }
        
        const secondaryData = JSON.parse(jsonData);
        
        // Ki·ªÉm tra l·ªói trong ph·∫£n h·ªìi
        if (secondaryData.error) {
          throw new Error(secondaryData.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ m√°y ch·ªß');
        }
        
        appData.allData = appData.allData || {};
        
        // Gh√©p d·ªØ li·ªáu
        Object.assign(appData.allData, secondaryData);
        
        appData.partialDataProgress = 90;
        updateLoadingProgress(appData.partialDataProgress, 
          `ƒêang c·∫≠p nh·∫≠t giao di·ªán... (${appData.partialDataProgress}%)`);
        
        // D·ªØ li·ªáu ƒë√£ t·∫£i xong, c·∫≠p nh·∫≠t giao di·ªán
        appData.partialDataLoaded = true;
      } catch (error) {
        console.error('L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu ph·ª•:', error);
        appData.partialDataErrors.push('secondary: ' + error.message);
        // Ti·∫øp t·ª•c v·ªõi d·ªØ li·ªáu ƒë√£ c√≥
        appData.partialDataProgress = 90;
        updateLoadingProgress(appData.partialDataProgress, 
          `ƒêang c·∫≠p nh·∫≠t giao di·ªán... (${appData.partialDataProgress}%)`);
      } finally {
        // Ki·ªÉm tra d·ªØ li·ªáu t·ªëi thi·ªÉu ƒë·ªÉ ti·∫øp t·ª•c
        if (!appData.allData) {
          appData.allData = {};
        }
        
        try {
          // C·∫≠p nh·∫≠t giao di·ªán v·ªõi d·ªØ li·ªáu ƒë√£ c√≥
          updateDashboard();
          
          updateLoadingProgress(100, 'Ho√†n t·∫•t!');
          
          // N·∫øu c√≥ l·ªói, hi·ªÉn th·ªã c·∫£nh b√°o
          if (appData.partialDataErrors.length > 0) {
            showAlert('C·∫£nh b√°o', 'M·ªôt s·ªë d·ªØ li·ªáu c√≥ th·ªÉ kh√¥ng ƒë·∫ßy ƒë·ªß. Vui l√≤ng l√†m m·ªõi trang n·∫øu c√≥ v·∫•n ƒë·ªÅ.', 'warning');
            console.warn('C√≥ l·ªói khi t·∫£i d·ªØ li·ªáu:', appData.partialDataErrors);
          }
          
          // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y 100% r·ªìi m·ªõi ·∫©n
          setTimeout(() => {
            hideLoading();
          }, 500);
        } catch (uiError) {
          console.error('L·ªói khi c·∫≠p nh·∫≠t giao di·ªán:', uiError);
          document.getElementById('loadingError').classList.remove('d-none');
          document.getElementById('loadingMessage').textContent = 'L·ªói khi c·∫≠p nh·∫≠t giao di·ªán';
          
          // D·ª´ng spinner
          const progressBar = document.getElementById('loadingProgressBar');
          if (progressBar) {
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated', 'bg-primary');
            progressBar.classList.add('bg-danger');
          }
        }
      }
    })
    .withFailureHandler(function(error) {
      console.error('L·ªói khi t·∫£i d·ªØ li·ªáu ph·ª•:', error);
      appData.partialDataErrors.push('secondary: ' + error.message);
      
      // Ti·∫øp t·ª•c v·ªõi d·ªØ li·ªáu ƒë√£ c√≥
      appData.partialDataProgress = 90;
      updateLoadingProgress(appData.partialDataProgress, 
        `ƒêang c·∫≠p nh·∫≠t giao di·ªán... (${appData.partialDataProgress}%)`);
      
      try {
        // C·∫≠p nh·∫≠t giao di·ªán v·ªõi d·ªØ li·ªáu ƒë√£ c√≥
        updateDashboard();
        
        updateLoadingProgress(100, 'Ho√†n t·∫•t!');
        
        // Hi·ªÉn th·ªã c·∫£nh b√°o
        showAlert('C·∫£nh b√°o', 'M·ªôt s·ªë d·ªØ li·ªáu c√≥ th·ªÉ kh√¥ng ƒë·∫ßy ƒë·ªß. Vui l√≤ng l√†m m·ªõi trang n·∫øu c√≥ v·∫•n ƒë·ªÅ.', 'warning');
        
        // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y 100% r·ªìi m·ªõi ·∫©n
        setTimeout(() => {
          hideLoading();
        }, 500);
      } catch (uiError) {
        console.error('L·ªói khi c·∫≠p nh·∫≠t giao di·ªán:', uiError);
        document.getElementById('loadingError').classList.remove('d-none');
        document.getElementById('loadingMessage').textContent = 'L·ªói khi c·∫≠p nh·∫≠t giao di·ªán';
        
        // D·ª´ng spinner
        const progressBar = document.getElementById('loadingProgressBar');
        if (progressBar) {
          progressBar.style.width = '100%';
          progressBar.classList.remove('progress-bar-animated', 'bg-primary');
          progressBar.classList.add('bg-danger');
        }
      }
    })
    .getPartialData('secondary');
}

/**
 * X·ª≠ l√Ω d·ªØ li·ªáu ·ª©ng d·ª•ng
 * @param {string} jsonData - D·ªØ li·ªáu JSON
 */
function processAppData(jsonData) {
  try {
    console.log('ƒê√£ nh·∫≠n d·ªØ li·ªáu t·ª´ server, ƒëang x·ª≠ l√Ω...');
    updateLoadingProgress(50, 'ƒêang x·ª≠ l√Ω d·ªØ li·ªáu... (50%)');
    
    appData.allData = JSON.parse(jsonData);
    
    // Ki·ªÉm tra d·ªØ li·ªáu c∆° b·∫£n
    if (!appData.allData || !appData.allData.val_DSUserDV || !appData.allData.val_DSThietBi) {
      hideLoading();
      showAlert('L·ªói d·ªØ li·ªáu', 'D·ªØ li·ªáu t·∫£i v·ªÅ kh√¥ng ƒë·∫ßy ƒë·ªß. Vui l√≤ng l√†m m·ªõi trang v√† th·ª≠ l·∫°i.', 'error');
      console.error('Data incomplete:', appData.allData);
      return;
    }
    
    updateLoadingProgress(80, 'ƒêang c·∫≠p nh·∫≠t giao di·ªán... (80%)');
    
    // C·∫≠p nh·∫≠t giao di·ªán
    console.log('C·∫≠p nh·∫≠t giao di·ªán...');
    updateDashboard();
    
    updateLoadingProgress(100, 'Ho√†n t·∫•t!');
    
    console.log('T·∫£i d·ªØ li·ªáu th√†nh c√¥ng');
    
    // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y 100% r·ªìi m·ªõi ·∫©n
    setTimeout(() => {
      hideLoading();
    }, 500);
  } catch (error) {
    console.error('L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu:', error);
    handleLoadingError(error, 'Kh√¥ng th·ªÉ x·ª≠ l√Ω d·ªØ li·ªáu');
  }
}

/**
 * X·ª≠ l√Ω l·ªói t·∫£i d·ªØ li·ªáu
 * @param {Error} error - L·ªói
 */
function handleDataError(error) {
  console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
  handleLoadingError(error, 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu');
}

/**
 * X·ª≠ l√Ω l·ªói m√†n h√¨nh loading
 * @param {Error} error - L·ªói
 * @param {string} prefix - Ti·ªÅn t·ªë th√¥ng b√°o l·ªói
 */
function handleLoadingError(error, prefix) {
  // X√≥a timeout n·∫øu c√≥
  if (loadingTimeoutId) {
    clearTimeout(loadingTimeoutId);
    loadingTimeoutId = null;
  }
  
  // Hi·ªÉn th·ªã n√∫t th·ª≠ l·∫°i
  document.getElementById('loadingError').classList.remove('d-none');
  
  // D·ª´ng spinner
  const progressBar = document.getElementById('loadingProgressBar');
  if (progressBar) {
    progressBar.style.width = '100%';
    progressBar.classList.remove('progress-bar-animated', 'bg-primary');
    progressBar.classList.add('bg-danger');
  }
  
  // C·∫≠p nh·∫≠t th√¥ng b√°o l·ªói
  const loadingMessage = document.getElementById('loadingMessage');
  if (loadingMessage) {
    loadingMessage.textContent = 'C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu!';
  }
  
  // Hi·ªÉn th·ªã th√¥ng b√°o chi ti·∫øt
  let errorMessage = `${prefix}: ${error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`;
  let errorDetails = '';
  
  // Ph√¢n t√≠ch l·ªói th∆∞·ªùng g·∫∑p
  if (error.message && error.message.includes('timed out') || error.message && error.message.includes('timeout')) {
    errorDetails = 'M√°y ch·ªß ph·∫£n h·ªìi qu√° ch·∫≠m, vui l√≤ng th·ª≠ l·∫°i sau.';
  } else if (error.message && error.message.includes('Failed to execute')) {
    errorDetails = 'C√≥ v·∫•n ƒë·ªÅ khi th·ª±c thi script, vui l√≤ng l√†m m·ªõi trang.';
  } else if (error.message && error.message.includes('Authorization')) {
    errorDetails = 'C·∫ßn ƒëƒÉng nh·∫≠p l·∫°i ho·∫∑c c√≥ v·∫•n ƒë·ªÅ v·ªÅ quy·ªÅn truy c·∫≠p.';
  } else {
    errorDetails = 'Vui l√≤ng l√†m m·ªõi trang v√† th·ª≠ l·∫°i.';
  }
  
  if (errorDetails) {
    errorMessage += `\n${errorDetails}`;
  }
  
  console.error('Chi ti·∫øt l·ªói:', error);
  showAlert('L·ªói t·∫£i d·ªØ li·ªáu', errorMessage, 'error');
}

// ==== C√ÅC H√ÄM C·∫¨P NH·∫¨T GIAO DI·ªÜN ====
/**
 * C·∫≠p nh·∫≠t b·∫£ng ƒëi·ªÅu khi·ªÉn
 */
function updateDashboard() {
  if (!appData.allData || !appData.userData) {
    console.error('D·ªØ li·ªáu kh√¥ng ƒë·∫ßy ƒë·ªß ƒë·ªÉ c·∫≠p nh·∫≠t giao di·ªán');
    return;
  }
  
  try {
    // Ki·ªÉm tra d·ªØ li·ªáu MainSC c√≥ t·ªìn t·∫°i kh√¥ng
    if (!appData.allData.val_MainSC) {
      console.error('Thi·∫øu d·ªØ li·ªáu val_MainSC');
      document.getElementById('bao-hong-count').textContent = '0';
      document.getElementById('dang-sua-count').textContent = '0';
      document.getElementById('bao-hanh-count').textContent = '0';
      document.getElementById('sua-ngoai-count').textContent = '0';
      
      // Hi·ªÉn th·ªã th√¥ng b√°o trong c√°c b·∫£ng
      updateRepairTable('baoHongTable', []);
      updateRepairTable('dangSuaTable', []);
      updateRepairTable('baoHanhTable', []);
      updateRepairTable('suaNgoaiTable', []);
      
      // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
      showAlert('D·ªØ li·ªáu ch∆∞a ƒë·∫ßy ƒë·ªß', 'Ch∆∞a nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu s·ª≠a ch·ªØa. Vui l√≤ng l√†m m·ªõi trang.', 'warning');
      return;
    }
    
    // L·ªçc d·ªØ li·ªáu theo ƒë∆°n v·ªã ng∆∞·ªùi d√πng
    const userUnitId = appData.userData.id;
    const repairData = appData.allData.val_MainSC.filter(row => 
      row && row.length > CONFIG.COLUMNS.MainSC.DON_VI && row[CONFIG.COLUMNS.MainSC.DON_VI] === userUnitId
    );
    
    // Ph√¢n lo·∫°i theo tr·∫°ng th√°i
    let baoHongData = [], dangSuaData = [], baoHanhData = [], suaNgoaiData = [];
    
    try {
      baoHongData = repairData.filter(row => 
        row && row.length > CONFIG.COLUMNS.MainSC.TRANG_THAI && 
        row[CONFIG.COLUMNS.MainSC.TRANG_THAI] === CONFIG.REPAIR_STATUS.BAO_HONG
      );
      dangSuaData = repairData.filter(row => 
        row && row.length > CONFIG.COLUMNS.MainSC.TRANG_THAI && 
        row[CONFIG.COLUMNS.MainSC.TRANG_THAI] === CONFIG.REPAIR_STATUS.DANG_SUA
      );
      baoHanhData = repairData.filter(row => 
        row && row.length > CONFIG.COLUMNS.MainSC.TRANG_THAI && 
        row[CONFIG.COLUMNS.MainSC.TRANG_THAI] === CONFIG.REPAIR_STATUS.BAO_HANH
      );
      suaNgoaiData = repairData.filter(row => 
        row && row.length > CONFIG.COLUMNS.MainSC.TRANG_THAI && 
        row[CONFIG.COLUMNS.MainSC.TRANG_THAI] === CONFIG.REPAIR_STATUS.SUA_NGOAI
      );
    } catch (e) {
      console.error('L·ªói khi ph√¢n lo·∫°i d·ªØ li·ªáu:', e);
    }
    
    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
    document.getElementById('bao-hong-count').textContent = baoHongData.length;
    document.getElementById('dang-sua-count').textContent = dangSuaData.length;
    document.getElementById('bao-hanh-count').textContent = baoHanhData.length;
    document.getElementById('sua-ngoai-count').textContent = suaNgoaiData.length;
    
    // C·∫≠p nh·∫≠t c√°c b·∫£ng
    updateRepairTable('baoHongTable', baoHongData);
    updateRepairTable('dangSuaTable', dangSuaData);
    updateRepairTable('baoHanhTable', baoHanhData);
    updateRepairTable('suaNgoaiTable', suaNgoaiData);
    
    // Thi·∫øt l·∫≠p c√°c combobox
    try {
      setupDropdowns();
    } catch (e) {
      console.error('L·ªói khi thi·∫øt l·∫≠p dropdowns:', e);
    }
    
  } catch (error) {
    console.error('L·ªói khi c·∫≠p nh·∫≠t giao di·ªán:', error);
    // Th√¥ng b√°o l·ªói cho ng∆∞·ªùi d√πng
    showAlert('L·ªói hi·ªÉn th·ªã', 'C√≥ l·ªói khi hi·ªÉn th·ªã d·ªØ li·ªáu. Vui l√≤ng l√†m m·ªõi trang.', 'error');
  }
}

/**
 * C·∫≠p nh·∫≠t b·∫£ng b√°o s·ª≠a
 * @param {string} tableId - ID c·ªßa b·∫£ng
 * @param {Array} data - D·ªØ li·ªáu b·∫£ng
 */
function updateRepairTable(tableId, data) {
  try {
    const table = document.getElementById(tableId);
    if (!table) {
      console.error(`Kh√¥ng t√¨m th·∫•y b·∫£ng v·ªõi ID: ${tableId}`);
      return;
    }
    
    const tbody = table.querySelector('tbody');
    if (!tbody) {
      console.error(`Kh√¥ng t√¨m th·∫•y ph·∫ßn tbody trong b·∫£ng ${tableId}`);
      return;
    }
    
    tbody.innerHTML = '';
    
    if (!data || !Array.isArray(data) || data.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="3" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td>`;
      tbody.appendChild(tr);
      return;
    }
    
    data.forEach((row, index) => {
      try {
        if (!row || !Array.isArray(row)) return;
        
        // ƒê·∫£m b·∫£o c√≥ ƒë·ªß c·ªôt d·ªØ li·ªáu
        const hasMinimumColumns = row.length > Math.max(
          CONFIG.COLUMNS.MainSC.ID,
          CONFIG.COLUMNS.MainSC.THIET_BI,
          CONFIG.COLUMNS.MainSC.HO_TEN,
          CONFIG.COLUMNS.MainSC.THOI_GIAN_DV_BAO,
          CONFIG.COLUMNS.MainSC.TINH_TRANG_TB_DV_BAO
        );
        
        if (!hasMinimumColumns) return;
        
        const repairId = row[CONFIG.COLUMNS.MainSC.ID] || 'N/A';
        const deviceId = row[CONFIG.COLUMNS.MainSC.THIET_BI];
        const deviceInfo = findDeviceById(deviceId);
        
        // T·∫°o n·ªôi dung hi·ªÉn th·ªã
        const deviceName = deviceInfo ? deviceInfo[CONFIG.COLUMNS.DSThietBi.TEN_THIET_BI] : 'Kh√¥ng x√°c ƒë·ªãnh';
        const deviceModel = deviceInfo ? deviceInfo[CONFIG.COLUMNS.DSThietBi.MODEL] : '';
        const deviceSerial = deviceInfo ? deviceInfo[CONFIG.COLUMNS.DSThietBi.SERIAL] : '';
        const deviceOrigin = deviceInfo ? deviceInfo[CONFIG.COLUMNS.DSThietBi.NUOC_SAN_XUAT] : '';
        const reporterName = row[CONFIG.COLUMNS.MainSC.HO_TEN] || '';
        const reportDate = formatDate(row[CONFIG.COLUMNS.MainSC.THOI_GIAN_DV_BAO]);
        const issueDescription = row[CONFIG.COLUMNS.MainSC.TINH_TRANG_TB_DV_BAO] || '';
        
        const content = `
          <div class="repair-content">
            <span class="repair-id">‚ö†Ô∏è ${repairId}</span>
            <p>üõ†Ô∏è ${issueDescription}</p>
            <p>- Th√¥ng tin thi·∫øt b·ªã: ‚ôüÔ∏è${deviceName} ‚öôÔ∏è${deviceModel} ‚öôÔ∏è${deviceSerial} ‚öôÔ∏è${deviceOrigin}</p>
            <p>- Th√¥ng tin ng∆∞·ªùi s·ª≠a: üë®${reporterName} üìÖ${reportDate}</p>
          </div>
        `;
        
        // T·∫°o n√∫t h√†nh ƒë·ªông
        let actionButtons = `
          <button class="btn btn-sm btn-info action-btn" onclick="viewRepairDetails('${repairId}')">
            <i class="fas fa-eye"></i><span>Xem</span>
          </button>
        `;
        
        // Th√™m n√∫t s·ª≠a/x√≥a cho B√°o h·ªèng
        if (tableId === 'baoHongTable') {
          actionButtons += `
            <button class="btn btn-sm btn-primary action-btn" onclick="editRepair('${repairId}')">
              <i class="fas fa-edit"></i><span>S·ª≠a</span>
            </button>
            <button class="btn btn-sm btn-danger action-btn" onclick="deleteRepair('${repairId}')">
              <i class="fas fa-trash"></i><span>X√≥a</span>
            </button>
          `;
        }
        
        // Th√™m n√∫t xu·∫•t b√°o c√°o
        actionButtons += `
          <button class="btn btn-sm btn-success action-btn" onclick="exportRepair('${repairId}', 'pdf')">
            <i class="fas fa-file-pdf"></i><span>PDF</span>
          </button>
          <button class="btn btn-sm btn-secondary action-btn" onclick="exportRepair('${repairId}', 'doc')">
            <i class="fas fa-file-word"></i><span>Word</span>
          </button>
        `;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="text-center">${index + 1}</td>
          <td>${content}</td>
          <td class="text-center">${actionButtons}</td>
        `;
        tbody.appendChild(tr);
      } catch (rowError) {
        console.error('L·ªói khi x·ª≠ l√Ω d√≤ng d·ªØ li·ªáu:', rowError);
      }
    });
  } catch (error) {
    console.error('L·ªói khi c·∫≠p nh·∫≠t b·∫£ng:', error);
  }
}

/**
 * T√¨m thi·∫øt b·ªã theo ID
 * @param {string} deviceId - ID thi·∫øt b·ªã
 * @returns {Array|null} D·ªØ li·ªáu thi·∫øt b·ªã
 */
function findDeviceById(deviceId) {
  if (!appData.allData || !deviceId) return null;
  
  try {
    if (!appData.allData.val_DSThietBi || !Array.isArray(appData.allData.val_DSThietBi)) {
      console.warn('Thi·∫øu d·ªØ li·ªáu thi·∫øt b·ªã ho·∫∑c d·ªØ li·ªáu kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng');
      return null;
    }
    
    return appData.allData.val_DSThietBi.find(row => 
      row && 
      row.length > CONFIG.COLUMNS.DSThietBi.ID && 
      row[CONFIG.COLUMNS.DSThietBi.ID] === deviceId
    ) || null;
  } catch (error) {
    console.error('L·ªói khi t√¨m thi·∫øt b·ªã:', error);
    return null;
  }
}

/**
 * Thi·∫øt l·∫≠p c√°c dropdown
 */
function setupDropdowns() {
  // Thi·∫øt l·∫≠p dropdown m·ª©c ƒë·ªô y√™u c·∫ßu
  const mucDoSelect = document.getElementById('mucDoYeuCau');
  if (mucDoSelect) {
    mucDoSelect.innerHTML = '';
    
    if (appData.allData.mucDoList) {
      appData.allData.mucDoList.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        option.textContent = item.ten;
        mucDoSelect.appendChild(option);
      });
    }
  }
  
  // Thi·∫øt l·∫≠p dropdown ng∆∞·ªùi s·ª≠a ch·ªØa
  const nguoiSuaSelect = document.getElementById('nguoiSuaChua');
  if (nguoiSuaSelect) {
    nguoiSuaSelect.innerHTML = '';
    
    if (appData.allData.val_DSUserSua) {
      appData.allData.val_DSUserSua.forEach(row => {
        if (row && row.length > CONFIG.COLUMNS.DSUserSua.ID) {
          const option = document.createElement('option');
          option.value = row[CONFIG.COLUMNS.DSUserSua.ID];
          option.textContent = row[CONFIG.COLUMNS.DSUserSua.HO_TEN] || 'Kh√¥ng x√°c ƒë·ªãnh';
          option.dataset.sdt = (row.length > CONFIG.COLUMNS.DSUserSua.SO_DIEN_THOAI) ? 
            (row[CONFIG.COLUMNS.DSUserSua.SO_DIEN_THOAI] || '') : '';
          nguoiSuaSelect.appendChild(option);
        }
      });
    } else {
      console.warn('Thi·∫øu d·ªØ li·ªáu val_DSUserSua');
    }
  }
  
  // Thi·∫øt l·∫≠p dropdown nh√≥m thi·∫øt b·ªã
  const nhomThietBiSelect = document.getElementById('nhomThietBi');
  if (nhomThietBiSelect) {
    nhomThietBiSelect.innerHTML = '';
    
    if (appData.allData.val_DSNhomTB) {
      try {
        const uniqueGroups = [...new Set(appData.allData.val_DSNhomTB
          .filter(row => row && row.length > CONFIG.COLUMNS.DSNhomTB.NHOM_THIET_BI)
          .map(row => row[CONFIG.COLUMNS.DSNhomTB.NHOM_THIET_BI])
          .filter(Boolean)
        )];
        
        uniqueGroups.forEach(group => {
          const option = document.createElement('option');
          option.value = group;
          option.textContent = group;
          nhomThietBiSelect.appendChild(option);
        });
      } catch (e) {
        console.error('L·ªói khi x·ª≠ l√Ω danh s√°ch nh√≥m thi·∫øt b·ªã:', e);
      }
    } else {
      console.warn('Thi·∫øu d·ªØ li·ªáu val_DSNhomTB');
    }
  }
  
  // Thi·∫øt l·∫≠p danh s√°ch g·ª£i √Ω ng∆∞·ªùi y√™u c·∫ßu
  const nguoiYeuCauList = document.getElementById('nguoiYeuCauList');
  if (nguoiYeuCauList) {
    nguoiYeuCauList.innerHTML = '';
    
    if (appData.allData.val_MainSC) {
      try {
        // L·ªçc theo ng∆∞·ªùi d√πng hi·ªán t·∫°i
        const userUnitId = appData.userData.id;
        const unitRepairs = appData.allData.val_MainSC.filter(row => 
          row && row.length > CONFIG.COLUMNS.MainSC.DON_VI && 
          row[CONFIG.COLUMNS.MainSC.DON_VI] === userUnitId
        );
        
        // L·∫•y danh s√°ch ng∆∞·ªùi y√™u c·∫ßu ƒë·ªôc ƒë√°o
        const uniqueRequesters = [...new Set(unitRepairs
          .filter(row => row && row.length > CONFIG.COLUMNS.MainSC.HO_TEN)
          .map(row => row[CONFIG.COLUMNS.MainSC.HO_TEN])
          .filter(Boolean)
        )];
        
        uniqueRequesters.forEach(requester => {
          const option = document.createElement('option');
          option.value = requester;
          nguoiYeuCauList.appendChild(option);
        });
      } catch (e) {
        console.error('L·ªói khi x·ª≠ l√Ω danh s√°ch ng∆∞·ªùi y√™u c·∫ßu:', e);
      }
    }
  }
  
  // Thi·∫øt l·∫≠p danh s√°ch g·ª£i √Ω s·ªë ƒëi·ªán tho·∫°i
  const sdtYeuCauList = document.getElementById('sdtYeuCauList');
  if (sdtYeuCauList) {
    sdtYeuCauList.innerHTML = '';
    
    if (appData.allData.val_MainSC) {
      try {
        // L·ªçc theo ng∆∞·ªùi d√πng hi·ªán t·∫°i
        const userUnitId = appData.userData.id;
        const unitRepairs = appData.allData.val_MainSC.filter(row => 
          row && row.length > CONFIG.COLUMNS.MainSC.DON_VI && 
          row[CONFIG.COLUMNS.MainSC.DON_VI] === userUnitId
        );
        
        const uniquePhones = [...new Set(unitRepairs
          .filter(row => row && row.length > CONFIG.COLUMNS.MainSC.SO_DIEN_THOAI)
          .map(row => row[CONFIG.COLUMNS.MainSC.SO_DIEN_THOAI])
          .filter(Boolean)
        )];
        
        uniquePhones.forEach(phone => {
          const option = document.createElement('option');
          option.value = phone;
          sdtYeuCauList.appendChild(option);
        });
      } catch (e) {
        console.error('L·ªói khi x·ª≠ l√Ω danh s√°ch s·ªë ƒëi·ªán tho·∫°i:', e);
      }
    }
  }
}

// ==== C√ÅC H√ÄM X·ª¨ L√ù S·ª∞ KI·ªÜN ====
/**
 * Kh·ªüi t·∫°o khi trang ƒë√£ t·∫£i xong
 */
window.onload = function() {
  // X·ª≠ l√Ω s·ª± ki·ªán thay ƒë·ªïi ng∆∞·ªùi s·ª≠a ch·ªØa
  document.getElementById('nguoiSuaChua').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    document.getElementById('sdtNguoiSua').value = selectedOption.dataset.sdt || '';
  });
  
  // X·ª≠ l√Ω s·ª± ki·ªán thay ƒë·ªïi nh√≥m thi·∫øt b·ªã
  document.getElementById('nhomThietBi').addEventListener('change', function() {
    const selectedGroup = this.value;
    updateDeviceList(selectedGroup);
  });
  
  // X·ª≠ l√Ω s·ª± ki·ªán thay ƒë·ªïi m√£ thi·∫øt b·ªã
  document.getElementById('maThietBi').addEventListener('change', function() {
    const selectedDeviceId = this.value;
    updateDeviceDetails(selectedDeviceId);
  });
  
  // X·ª≠ l√Ω n√∫t th√™m b√°o h·ªèng
  document.getElementById('addRepairBtn').addEventListener('click', function() {
    openAddRepairModal();
  });
  
  // X·ª≠ l√Ω n√∫t l∆∞u b√°o h·ªèng
  document.getElementById('saveRepairBtn').addEventListener('click', function() {
    saveRepair();
  });
  
  // X·ª≠ l√Ω n√∫t l∆∞u m·∫≠t kh·∫©u
  document.getElementById('savePasswordBtn').addEventListener('click', function() {
    changePassword();
  });
  
  // X·ª≠ l√Ω t√¨m ki·∫øm
  document.getElementById('searchBtn').addEventListener('click', function() {
    searchRepairs();
  });
  
  // X·ª≠ l√Ω t√¨m ki·∫øm khi nh·∫•n Enter
  document.getElementById('searchInput').addEventListener('keyup', function(event) {
    if (event.key === 'Enter') {
      searchRepairs();
    }
  });
};

/**
 * C·∫≠p nh·∫≠t danh s√°ch thi·∫øt b·ªã theo nh√≥m
 * @param {string} groupName - T√™n nh√≥m thi·∫øt b·ªã
 */
function updateDeviceList(groupName) {
  const deviceSelect = document.getElementById('maThietBi');
  deviceSelect.innerHTML = '';
  
  // Th√™m l·ª±a ch·ªçn m·∫∑c ƒë·ªãnh
  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = '-- Ch·ªçn thi·∫øt b·ªã --';
  deviceSelect.appendChild(defaultOption);
  
  // L·ªçc thi·∫øt b·ªã theo nh√≥m
  const devices = appData.allData.val_DSThietBi.filter(row => 
    row[CONFIG.COLUMNS.DSThietBi.NHOM_THIET_BI] === groupName
  );
  
  // Th√™m c√°c thi·∫øt b·ªã
  devices.forEach(device => {
    const option = document.createElement('option');
    option.value = device[CONFIG.COLUMNS.DSThietBi.ID];
    option.textContent = `${device[CONFIG.COLUMNS.DSThietBi.MA_THIET_BI]} - ${device[CONFIG.COLUMNS.DSThietBi.TEN_THIET_BI]}`;
    deviceSelect.appendChild(option);
  });
}

/**
 * C·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt thi·∫øt b·ªã
 * @param {string} deviceId - ID thi·∫øt b·ªã
 */
function updateDeviceDetails(deviceId) {
  if (!deviceId) {
    // Clear device details
    document.getElementById('tenThietBi').value = '';
    document.getElementById('modelThietBi').value = '';
    document.getElementById('serialThietBi').value = '';
    document.getElementById('hangSanXuat').value = '';
    document.getElementById('nuocSanXuat').value = '';
    document.getElementById('namSanXuat').value = '';
    document.getElementById('namSuDung').value = '';
    document.getElementById('hanBaoHanh').value = '';
    document.getElementById('viTriDat').value = '';
    return;
  }
  
  // Find the device
  const device = findDeviceById(deviceId);
  if (!device) return;
  
  // Update device details
  document.getElementById('tenThietBi').value = device[CONFIG.COLUMNS.DSThietBi.TEN_THIET_BI] || '';
  document.getElementById('modelThietBi').value = device[CONFIG.COLUMNS.DSThietBi.MODEL] || '';
  document.getElementById('serialThietBi').value = device[CONFIG.COLUMNS.DSThietBi.SERIAL] || '';
  document.getElementById('hangSanXuat').value = device[CONFIG.COLUMNS.DSThietBi.HANG_SAN_XUAT] || '';
  document.getElementById('nuocSanXuat').value = device[CONFIG.COLUMNS.DSThietBi.NUOC_SAN_XUAT] || '';
  document.getElementById('namSanXuat').value = device[CONFIG.COLUMNS.DSThietBi.NAM_SAN_XUAT] || '';
  document.getElementById('namSuDung').value = device[CONFIG.COLUMNS.DSThietBi.THOI_GIAN_SU_DUNG] || '';
  document.getElementById('hanBaoHanh').value = device[CONFIG.COLUMNS.DSThietBi.HAN_BAO_HANH] || '';
  document.getElementById('viTriDat').value = device[CONFIG.COLUMNS.DSThietBi.VI_TRI_DAT] || '';
}

/**
 * M·ªü modal th√™m b√°o h·ªèng m·ªõi
 */
function openAddRepairModal() {
  // Reset form
  document.getElementById('repairForm').reset();
  document.getElementById('repairId').value = '';
  
  // ƒêi·ªÅn th√¥ng tin ƒë∆°n v·ªã y√™u c·∫ßu
  document.getElementById('donViYeuCau').value = appData.userData.donVi || '';
  
  // Hi·ªÉn th·ªã modal
  const repairModal = new bootstrap.Modal(document.getElementById('repairModal'));
  repairModal.show();
}

/**
 * L∆∞u b√°o c√°o s·ª≠a ch·ªØa
 */
function saveRepair() {
  // Validate form
  const form = document.getElementById('repairForm');
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }
  
  // Hi·ªÉn th·ªã loading
  showLoading();
  
  // Thu th·∫≠p d·ªØ li·ªáu form
  const repairData = {
    iduserdv: appData.userData.id,
    idusersua: document.getElementById('nguoiSuaChua').value,
    idthietbi: document.getElementById('maThietBi').value,
    tinhtrangtbdvbao: document.getElementById('tinhTrangThietBi').value,
    hoten: document.getElementById('nguoiYeuCau').value,
    sdt: document.getElementById('sdtYeuCau').value,
    ghichu: document.getElementById('ghiChu').value,
    mucDo: document.getElementById('mucDoYeuCau').value,
    donvi: appData.userData.kiHieu || 'XX'
  };
  
  // G·ª≠i y√™u c·∫ßu t·∫°o b√°o c√°o s·ª≠a ch·ªØa
  google.script.run
    .withSuccessHandler(onSaveRepairSuccess)
    .withFailureHandler(onSaveRepairError)
    .createRepairReport(repairData);
}

/**
 * X·ª≠ l√Ω khi l∆∞u b√°o c√°o th√†nh c√¥ng
 * @param {Object} result - K·∫øt qu·∫£ t·ª´ server
 */
function onSaveRepairSuccess(result) {
  hideLoading();
  
  if (result.success) {
    // ·∫®n modal
    const repairModal = bootstrap.Modal.getInstance(document.getElementById('repairModal'));
    repairModal.hide();
    
    // Th√¥ng b√°o th√†nh c√¥ng
    showAlert('Th√†nh c√¥ng', result.message, 'success');
    
    // T·∫£i l·∫°i d·ªØ li·ªáu
    loadAllData();
  } else {
    showAlert('L·ªói', result.message, 'error');
  }
}

/**
 * X·ª≠ l√Ω khi l∆∞u b√°o c√°o b·ªã l·ªói
 * @param {Error} error - L·ªói
 */
function onSaveRepairError(error) {
  hideLoading();
  showAlert('L·ªói h·ªá th·ªëng', `Kh√¥ng th·ªÉ l∆∞u b√°o c√°o: ${error.message}`, 'error');
}

/**
 * ƒê·ªïi m·∫≠t kh·∫©u
 */
function changePassword() {
  // Validate form
  const form = document.getElementById('changePasswordForm');
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }
  
  const oldPassword = document.getElementById('oldPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  // Ki·ªÉm tra m·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n
  if (newPassword !== confirmPassword) {
    showAlert('L·ªói', 'M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng kh·ªõp', 'error');
    return;
  }
  
  // Hi·ªÉn th·ªã loading
  showLoading();
  
  // G·ª≠i y√™u c·∫ßu ƒë·ªïi m·∫≠t kh·∫©u
  google.script.run
    .withSuccessHandler(onChangePasswordSuccess)
    .withFailureHandler(onChangePasswordError)
    .changePassword(appData.userData.id, oldPassword, newPassword, !!appData.userData.hoTen);
}

/**
 * X·ª≠ l√Ω khi ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng
 * @param {Object} result - K·∫øt qu·∫£ t·ª´ server
 */
function onChangePasswordSuccess(result) {
  hideLoading();
  
  if (result.success) {
    // ·∫®n modal
    const passwordModal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
    passwordModal.hide();
    
    // Reset form
    document.getElementById('changePasswordForm').reset();
    
    // Th√¥ng b√°o th√†nh c√¥ng
    showAlert('Th√†nh c√¥ng', result.message, 'success');
  } else {
    showAlert('L·ªói', result.message, 'error');
  }
}

/**
 * X·ª≠ l√Ω khi ƒë·ªïi m·∫≠t kh·∫©u b·ªã l·ªói
 * @param {Error} error - L·ªói
 */
function onChangePasswordError(error) {
  hideLoading();
  showAlert('L·ªói h·ªá th·ªëng', `Kh√¥ng th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u: ${error.message}`, 'error');
}

/**
 * T√¨m ki·∫øm b√°o c√°o
 */
function searchRepairs() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  
  if (!searchTerm) {
    updateDashboard(); // N·∫øu kh√¥ng c√≥ t·ª´ kh√≥a, hi·ªÉn th·ªã t·∫•t c·∫£
    return;
  }
  
  if (!appData.allData || !appData.userData) return;
  
  // L·ªçc d·ªØ li·ªáu theo ƒë∆°n v·ªã ng∆∞·ªùi d√πng
  const userUnitId = appData.userData.id;
  const repairData = appData.allData.val_MainSC.filter(row => 
    row[CONFIG.COLUMNS.MainSC.DON_VI] === userUnitId
  );
  
  // L·ªçc theo t·ª´ kh√≥a
  const filteredData = repairData.filter(row => {
    // L·∫•y th√¥ng tin thi·∫øt b·ªã
    const deviceId = row[CONFIG.COLUMNS.MainSC.THIET_BI];
    const deviceInfo = findDeviceById(deviceId);
    
    // T√¨m ki·∫øm trong c√°c tr∆∞·ªùng
    const repairId = row[CONFIG.COLUMNS.MainSC.ID] || '';
    const deviceName = deviceInfo ? deviceInfo[CONFIG.COLUMNS.DSThietBi.TEN_THIET_BI] || '' : '';
    const deviceModel = deviceInfo ? deviceInfo[CONFIG.COLUMNS.DSThietBi.MODEL] || '' : '';
    const deviceSerial = deviceInfo ? deviceInfo[CONFIG.COLUMNS.DSThietBi.SERIAL] || '' : '';
    const issueDescription = row[CONFIG.COLUMNS.MainSC.TINH_TRANG_TB_DV_BAO] || '';
    const reporterName = row[CONFIG.COLUMNS.MainSC.HO_TEN] || '';
    
    // Ki·ªÉm tra xem t·ª´ kh√≥a c√≥ tr√πng v·ªõi b·∫•t k·ª≥ tr∆∞·ªùng n√†o
    return repairId.toLowerCase().includes(searchTerm) ||
      deviceName.toLowerCase().includes(searchTerm) ||
      deviceModel.toLowerCase().includes(searchTerm) ||
      deviceSerial.toLowerCase().includes(searchTerm) ||
      issueDescription.toLowerCase().includes(searchTerm) ||
      reporterName.toLowerCase().includes(searchTerm);
  });
  
  // Ph√¢n lo·∫°i theo tr·∫°ng th√°i
  const baoHongData = filteredData.filter(row => row[CONFIG.COLUMNS.MainSC.TRANG_THAI] === CONFIG.REPAIR_STATUS.BAO_HONG);
  const dangSuaData = filteredData.filter(row => row[CONFIG.COLUMNS.MainSC.TRANG_THAI] === CONFIG.REPAIR_STATUS.DANG_SUA);
  const baoHanhData = filteredData.filter(row => row[CONFIG.COLUMNS.MainSC.TRANG_THAI] === CONFIG.REPAIR_STATUS.BAO_HANH);
  const suaNgoaiData = filteredData.filter(row => row[CONFIG.COLUMNS.MainSC.TRANG_THAI] === CONFIG.REPAIR_STATUS.SUA_NGOAI);
  
  // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
  document.getElementById('bao-hong-count').textContent = baoHongData.length;
  document.getElementById('dang-sua-count').textContent = dangSuaData.length;
  document.getElementById('bao-hanh-count').textContent = baoHanhData.length;
  document.getElementById('sua-ngoai-count').textContent = suaNgoaiData.length;
  
  // C·∫≠p nh·∫≠t c√°c b·∫£ng
  updateRepairTable('baoHongTable', baoHongData);
  updateRepairTable('dangSuaTable', dangSuaData);
  updateRepairTable('baoHanhTable', baoHanhData);
  updateRepairTable('suaNgoaiTable', suaNgoaiData);
}

/**
 * Xem chi ti·∫øt b√°o c√°o
 * @param {string} repairId - ID b√°o c√°o s·ª≠a ch·ªØa
 */
function viewRepairDetails(repairId) {
  showAlert('Th√¥ng b√°o', 'Ch·ª©c nƒÉng xem chi ti·∫øt ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.', 'info');
}

/**
 * S·ª≠a b√°o c√°o
 * @param {string} repairId - ID b√°o c√°o s·ª≠a ch·ªØa
 */
function editRepair(repairId) {
  showAlert('Th√¥ng b√°o', 'Ch·ª©c nƒÉng s·ª≠a b√°o c√°o ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.', 'info');
}

/**
 * X√≥a b√°o c√°o
 * @param {string} repairId - ID b√°o c√°o s·ª≠a ch·ªØa
 */
function deleteRepair(repairId) {
  Swal.fire({
    title: 'X√°c nh·∫≠n x√≥a',
    text: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√°o c√°o ${repairId}?`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'X√≥a',
    cancelButtonText: 'H·ªßy',
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6'
  }).then((result) => {
    if (result.isConfirmed) {
      showAlert('Th√¥ng b√°o', 'Ch·ª©c nƒÉng x√≥a b√°o c√°o ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.', 'info');
    }
  });
}

/**
 * Xu·∫•t b√°o c√°o
 * @param {string} repairId - ID b√°o c√°o s·ª≠a ch·ªØa
 * @param {string} format - ƒê·ªãnh d·∫°ng (pdf, doc)
 */
function exportRepair(repairId, format) {
  showAlert('Th√¥ng b√°o', 'Ch·ª©c nƒÉng xu·∫•t b√°o c√°o ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.', 'info');
}

/**
 * Hi·ªÉn th·ªã modal ƒë·ªïi m·∫≠t kh·∫©u
 */
function showChangePasswordModal() {
  // Reset form
  document.getElementById('changePasswordForm').reset();
  
  // Hi·ªÉn th·ªã modal
  const passwordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
  passwordModal.show();
}
</script> 