<script>
// ===== 1. GLOBAL VARIABLES =====
let currentUser = null;
let deviceGroups = [];
let devices = {};
let repairers = [];

// ===== 2. UTILITY FUNCTIONS =====
function formatDate(date) {
  return new Date(date).toLocaleDateString('vi-VN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function showError(message) {
  Swal.fire({
    icon: 'error',
    title: 'L·ªói',
    text: message,
    confirmButtonText: 'ƒê√≥ng'
  });
}

function showSuccess(message) {
  Swal.fire({
    icon: 'success',
    title: 'Th√†nh c√¥ng',
    text: message,
    confirmButtonText: 'ƒê√≥ng'
  });
}

function showLoading(message = 'ƒêang x·ª≠ l√Ω...') {
  Swal.fire({
    title: message,
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
    }
  });
}

function hideLoading() {
  Swal.close();
}

// ===== 3. AUTHENTICATION =====
document.getElementById('login').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  
  try {
    showLoading('ƒêang ƒëƒÉng nh·∫≠p...');
    const response = await google.script.run
      .withSuccessHandler(handleLoginSuccess)
      .withFailureHandler(handleLoginError)
      .validateLogin(username, password);
  } catch (error) {
    showError('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message);
  }
});

function handleLoginSuccess(response) {
  hideLoading();
  if (response.success) {
    currentUser = response.userData;
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    
    // Update UI with user info
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userLogo').src = currentUser.logo;
    document.getElementById('headerLogo').src = currentUser.logo;
    
    // Load initial data
    loadInitialData();
  } else {
    showError(response.message);
  }
}

function handleLoginError(error) {
  hideLoading();
  showError('L·ªói ƒëƒÉng nh·∫≠p: ' + error.message);
}

// Toggle password visibility
document.querySelector('.toggle-password').addEventListener('click', function() {
  const passwordInput = document.getElementById('password');
  const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
  passwordInput.setAttribute('type', type);
  this.classList.toggle('fa-eye');
  this.classList.toggle('fa-eye-slash');
});

// ===== 4. DATA LOADING =====
async function loadInitialData() {
  try {
    showLoading('ƒêang t·∫£i d·ªØ li·ªáu...');
    // Load device groups
    deviceGroups = await google.script.run
      .withSuccessHandler(groups => {
        const select = document.getElementById('deviceGroup');
        select.innerHTML = '<option value="">Ch·ªçn nh√≥m thi·∫øt b·ªã</option>';
        groups.forEach(group => {
          const option = document.createElement('option');
          option.value = group.id;
          option.textContent = group.name;
          select.appendChild(option);
        });
        return groups;
      })
      .withFailureHandler(error => {
        showError('L·ªói t·∫£i danh s√°ch nh√≥m thi·∫øt b·ªã: ' + error.message);
        return [];
      })
      .getDeviceGroups();
    
    // Load repair reports
    await loadRepairReports();
    hideLoading();
  } catch (error) {
    hideLoading();
    showError('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message);
  }
}

async function loadRepairReports() {
  try {
    const reports = await google.script.run
      .withSuccessHandler(updateReportTables)
      .withFailureHandler(error => {
        showError('L·ªói t·∫£i danh s√°ch b√°o s·ª≠a: ' + error.message);
        return [];
      })
      .getRepairReports(currentUser.id);
  } catch (error) {
    showError('L·ªói t·∫£i danh s√°ch b√°o s·ª≠a: ' + error.message);
  }
}

function updateReportTables(reports) {
  // Group reports by status
  const reporting = reports.filter(r => r.status === 'Em001');
  const repairing = reports.filter(r => r.status === 'Em002');
  const warranty = reports.filter(r => r.status === 'Em003');
  const external = reports.filter(r => r.status === 'Em004');
  
  // Update counts
  document.getElementById('reportingCount').textContent = reporting.length;
  document.getElementById('repairingCount').textContent = repairing.length;
  document.getElementById('warrantyCount').textContent = warranty.length;
  document.getElementById('externalCount').textContent = external.length;
  
  // Update tables
  updateTable('reportingTable', reporting);
  updateTable('repairingTable', repairing);
  updateTable('warrantyTable', warranty);
  updateTable('externalTable', external);
}

function updateTable(tableId, reports) {
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = '';
  
  reports.forEach((report, index) => {
    const row = document.createElement('tr');
    
    // STT
    const sttCell = document.createElement('td');
    sttCell.textContent = index + 1;
    row.appendChild(sttCell);
    
    // N·ªôi dung
    const contentCell = document.createElement('td');
    contentCell.innerHTML = `
      üõ†Ô∏è ${report.deviceStatus} ‚ö†Ô∏è ${report.id}<br>
      - Th√¥ng tin thi·∫øt b·ªã: ‚ôüÔ∏è${report.device} ‚öôÔ∏è${report.model} ‚öôÔ∏è${report.serial} ‚öôÔ∏è${report.country}<br>
      - Th√¥ng tin ng∆∞·ªùi s·ª≠a: üë®${report.requester} üìÖ${formatDate(report.reportTime)}
    `;
    row.appendChild(contentCell);
    
    // H√†nh ƒë·ªông
    const actionCell = document.createElement('td');
    actionCell.innerHTML = `
      <div class="action-buttons">
        <button onclick="viewReport('${report.id}')" class="btn btn-info btn-sm">
          <i class="fas fa-eye"></i> Xem
        </button>
        <button onclick="editReport('${report.id}')" class="btn btn-warning btn-sm">
          <i class="fas fa-edit"></i> S·ª≠a
        </button>
        <button onclick="deleteReport('${report.id}')" class="btn btn-danger btn-sm">
          <i class="fas fa-trash"></i> X√≥a
        </button>
        <button onclick="exportPDF('${report.id}')" class="btn btn-secondary btn-sm">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
        <button onclick="exportWord('${report.id}')" class="btn btn-primary btn-sm">
          <i class="fas fa-file-word"></i> Word
        </button>
      </div>
    `;
    row.appendChild(actionCell);
    
    tbody.appendChild(row);
  });
}

// ===== 5. DEVICE SELECTION =====
document.getElementById('deviceGroup').addEventListener('change', async (e) => {
  const groupId = e.target.value;
  if (!groupId) return;
  
  try {
    showLoading('ƒêang t·∫£i danh s√°ch thi·∫øt b·ªã...');
    const devices = await google.script.run
      .withSuccessHandler(updateDeviceSelect)
      .withFailureHandler(error => {
        showError('L·ªói t·∫£i danh s√°ch thi·∫øt b·ªã: ' + error.message);
        return [];
      })
      .getDevicesByGroup(groupId);
    hideLoading();
  } catch (error) {
    hideLoading();
    showError('L·ªói t·∫£i danh s√°ch thi·∫øt b·ªã: ' + error.message);
  }
});

function updateDeviceSelect(devices) {
  const select = document.getElementById('deviceCode');
  select.innerHTML = '<option value="">Ch·ªçn m√£ thi·∫øt b·ªã</option>';
  
  devices.forEach(device => {
    const option = document.createElement('option');
    option.value = device.id;
    option.textContent = device.code;
    option.dataset.device = JSON.stringify(device);
    select.appendChild(option);
  });
}

document.getElementById('deviceCode').addEventListener('change', (e) => {
  const option = e.target.selectedOptions[0];
  if (!option.value) return;
  
  const device = JSON.parse(option.dataset.device);
  document.getElementById('deviceName').value = device.name;
  document.getElementById('model').value = device.model;
  document.getElementById('serial').value = device.serial;
  document.getElementById('manufacturer').value = device.manufacturer;
  document.getElementById('country').value = device.country;
  document.getElementById('year').value = device.year;
  document.getElementById('useYear').value = device.useYear;
  document.getElementById('warranty').value = device.warranty;
  document.getElementById('location').value = device.location;
});

// ===== 6. REPAIR REPORT FORM =====
document.getElementById('addRepairButton').addEventListener('click', () => {
  document.getElementById('repairModal').style.display = 'block';
  document.getElementById('unit').value = currentUser.name;
});

document.querySelector('.close').addEventListener('click', () => {
  document.getElementById('repairModal').style.display = 'none';
});

document.getElementById('repairForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const formData = {
    unitCode: currentUser.id,
    unit: currentUser.name,
    requester: document.getElementById('requester').value,
    phone: document.getElementById('phone').value,
    repairer: document.getElementById('repairer').value,
    device: document.getElementById('deviceName').value,
    deviceStatus: document.getElementById('deviceStatus').value,
    level: document.getElementById('level').value,
    note: document.getElementById('note').value
  };
  
  try {
    showLoading('ƒêang t·∫°o b√°o s·ª≠a...');
    const response = await google.script.run
      .withSuccessHandler(handleCreateSuccess)
      .withFailureHandler(handleCreateError)
      .createRepairReport(formData);
  } catch (error) {
    hideLoading();
    showError('L·ªói t·∫°o b√°o s·ª≠a: ' + error.message);
  }
});

function handleCreateSuccess(response) {
  hideLoading();
  if (response.success) {
    document.getElementById('repairModal').style.display = 'none';
    document.getElementById('repairForm').reset();
    showSuccess('T·∫°o b√°o s·ª≠a th√†nh c√¥ng');
    loadRepairReports();
  } else {
    showError(response.message);
  }
}

function handleCreateError(error) {
  hideLoading();
  showError('L·ªói t·∫°o b√°o s·ª≠a: ' + error.message);
}

// ===== 7. REPORT ACTIONS =====
function viewReport(id) {
  // TODO: Implement view report
  showError('Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
}

function editReport(id) {
  // TODO: Implement edit report
  showError('Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
}

function deleteReport(id) {
  Swal.fire({
    title: 'X√°c nh·∫≠n x√≥a',
    text: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√°o s·ª≠a n√†y?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'X√≥a',
    cancelButtonText: 'H·ªßy'
  }).then((result) => {
    if (result.isConfirmed) {
      // TODO: Implement delete report
      showError('Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
    }
  });
}

function exportPDF(id) {
  // TODO: Implement export PDF
  showError('Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
}

function exportWord(id) {
  // TODO: Implement export Word
  showError('Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
}

// ===== 8. SEARCH FUNCTIONALITY =====
document.getElementById('searchButton').addEventListener('click', () => {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  // TODO: Implement search functionality
  showError('Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
});
</script> 